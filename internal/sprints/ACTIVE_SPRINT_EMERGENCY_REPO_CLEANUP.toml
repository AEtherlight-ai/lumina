# Emergency Sprint: Repository Security Cleanup
# Critical incident: Private website code leaked into public repository
# Priority: IMMEDIATE (pre-launch cleanup window)
# Duration: 2-4 hours
# Status: ACTIVE

[metadata]
version = "0.17.0-emergency"
sprint_number = "EMERGENCY-001"
start_date = "2025-11-09"
target_completion = "2025-11-09"
completion_date = "2025-11-09"
status = "completed"
severity = "CRITICAL"
resolution = "SUCCESS - All leaked code removed, Sprint 4 work preserved"

[metadata.focus]
primary = "Remove private website code from public repo history"
secondary = "Setup proper submodule architecture"
tertiary = "Verify no sensitive data leaked"

[metadata.incident]
discovered = "2025-11-09T11:00:00Z"
root_cause = "products/lumina-web added directly to public repo instead of as submodule"
impact = "Private website implementation exposed in public GitHub history"
affected_commits = ["ecdea90", "e680514", "bf3de3e", "4d38f65"]
affected_files = [
    "products/lumina-web/app/api/**/*.ts",
    "products/lumina-web/lib/**/*",
    "products/lumina-web/supabase/**/*"
]

[metadata.security_assessment]
keys_exposed = false  # .env.local was gitignored, never committed
implementation_exposed = true  # API routes, auth logic, Stripe integration visible
severity_rating = "HIGH"  # Code visible but no keys leaked
launch_status = "pre-launch"  # Perfect timing - no production users affected

[metadata.recovery_strategy]
approach = "Nuclear Option - BFG Repo-Cleaner"
rationale = "Pre-launch window allows history rewrite without user impact"
alternatives_considered = [
    "Revert commits (leaves history visible)",
    "Rotate keys only (accepts code exposure)"
]

[metadata.team]
team_size = 1
incident_commander = "BB_Aelor"

[[metadata.team.engineers]]
id = "engineer_1"
name = "BB_Aelor"
role = "Incident Commander"
expertise = ["git", "security", "devops"]
available_agents = ["infrastructure-agent", "documentation-agent"]

# ============================================================================
# PHASE 1: DAMAGE ASSESSMENT (COMPLETE)
# ============================================================================

[tasks.ASSESS-001]
id = "ASSESS-001"
name = "Assess leaked files and sensitive data"
status = "completed"
phase = "damage-assessment"
agent = "infrastructure-agent"
estimated_time = "30 minutes"
completed_at = "2025-11-09T12:00:00Z"

why = """
Before cleanup, must understand WHAT was leaked and severity level.
Critical to determine if keys/secrets exposed (requires rotation).
"""

deliverables = [
    "List of all leaked files in products/lumina-web/",
    "Verification that .env.local NOT in git history",
    "Confirmation of Supabase keys status (anon vs service role)",
    "Assessment of API implementation exposure risk"
]

validation_criteria = [
    "[OK] .env.local never committed (gitignored)",
    "[OK] Supabase anon keys are public (safe)",
    "[OK] Service role key NOT in history",
    "[X] API route implementations exposed (4 commits)",
    "[X] Auth logic, Stripe webhooks, credit system visible"
]

findings = """
GOOD NEWS:
- .env.local was NEVER committed to git history (gitignored)
- Supabase keys in .env.local are ANON keys (meant to be public)
- Service role key present but NOT in git history

BAD NEWS:
- products/lumina-web/ source code IS in public repo (4 commits)
- API route implementations exposed (Stripe webhooks, credit system, auth)
- Implementation logic visible on GitHub public repo
- Commits: ecdea90, e680514, bf3de3e, 4d38f65
"""

[tasks.ASSESS-002]
id = "ASSESS-002"
name = "Identify affected commits and branches"
status = "completed"
phase = "damage-assessment"
agent = "infrastructure-agent"
estimated_time = "15 minutes"
completed_at = "2025-11-09T12:10:00Z"

deliverables = [
    "List of commits touching products/lumina-web/",
    "List of branches with leaked code",
    "Timeline of when leak occurred"
]

findings = """
Affected commits (4 total):
- 4d38f65: feat(api): Add credit purchase and status endpoints (API-002, API-003)
- bf3de3e: feat(api): Implement credit tracking system and Whisper proxy API
- e680514: feat(api): Implement credit tracking system and Whisper proxy API
- ecdea90: feat(ui): implement toolbar buttons

Branches affected:
- origin/master (main branch - public)
- origin/feature/key-authorization (current branch)
- Likely other feature branches with merges

First appearance: Commit ecdea90 (earliest in history)
"""

# ============================================================================
# PHASE 2: HISTORY PURGE (BFG REPO-CLEANER)
# ============================================================================

[tasks.PURGE-001]
id = "PURGE-001"
name = "Install BFG Repo-Cleaner"
status = "completed"
phase = "history-purge"
agent = "infrastructure-agent"
estimated_time = "5 minutes"
completed_at = "2025-11-09T12:25:00Z"
dependencies = ["ASSESS-001", "ASSESS-002"]

description = """
Install BFG Repo-Cleaner tool for fast, safe history rewriting.
Alternative to git filter-branch (10-720x faster).
"""

deliverables = [
    "BFG Repo-Cleaner installed and verified"
]

validation_criteria = [
    "bfg command available in PATH",
    "Version confirmed (latest stable)"
]

implementation_steps = """
Windows:
  choco install bfg-repo-cleaner

macOS:
  brew install bfg

Linux:
  # Download JAR from https://rtyley.github.io/bfg-repo-cleaner/
  wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
  alias bfg='java -jar bfg-1.14.0.jar'

Verify:
  bfg --version
"""

error_handling = """
- If choco/brew not available, download JAR directly
- Verify Java installed (required for JAR)
- Test with --help flag before proceeding
"""

[tasks.PURGE-002]
id = "PURGE-002"
name = "Clone mirror repository for safe history rewrite"
status = "completed"
phase = "history-purge"
agent = "infrastructure-agent"
estimated_time = "5 minutes"
completed_at = "2025-11-09T12:30:00Z"
dependencies = ["PURGE-001"]

description = """
Clone a bare mirror of the repository to work on history safely.
Mirror clone contains all refs, tags, branches for complete rewrite.
"""

deliverables = [
    "lumina-mirror.git directory with bare clone"
]

validation_criteria = [
    "Mirror clone successful (all refs present)",
    "Original working directory untouched"
]

implementation_steps = """
cd "C:/Users/Brett/Dropbox/Ferret9 Global"
git clone --mirror https://github.com/AEtherlight-ai/lumina.git lumina-mirror.git

# Verify mirror
cd lumina-mirror.git
git branch -a
git tag
"""

error_handling = """
- Ensure sufficient disk space (~2x repo size)
- Handle network errors with retry
- Verify all branches present in mirror
"""

[tasks.PURGE-003]
id = "PURGE-003"
name = "Run BFG to delete lumina-web folder from ALL history"
status = "completed"
phase = "history-purge"
agent = "infrastructure-agent"
estimated_time = "10 minutes"
completed_at = "2025-11-09T12:40:00Z"
dependencies = ["PURGE-002"]
severity = "CRITICAL"

description = """
Use BFG to purge products/lumina-web/ from entire git history.
This removes the folder from all commits, branches, and tags.
IRREVERSIBLE operation - backup created in PURGE-002.
"""

why = """
Private website implementation must not exist in public repo history.
BFG is safest method (preserves repo structure, only removes specified paths).
"""

deliverables = [
    "products/lumina-web/ removed from all commits",
    "BFG report showing files deleted",
    "Repository structure preserved"
]

validation_criteria = [
    "BFG completes without errors",
    "lumina-web folder absent from all commits",
    "Other files/folders untouched",
    "All branches still functional"
]

implementation_steps = """
cd lumina-mirror.git

# Delete lumina-web folder from all history
bfg --delete-folders lumina-web

# BFG output will show:
# - Commits affected
# - Files removed
# - Size reduction
"""

error_handling = """
- If BFG fails, restore from backup (lumina-clean directory still intact)
- Verify BFG report shows expected files deleted
- Check for warnings about protected commits (HEAD should update)
- If errors, DO NOT proceed to PURGE-004
"""

performance_target = "Completes in <2 minutes (BFG is 10-720x faster than filter-branch)"

patterns = ["Pattern-GIT-001"]

[tasks.PURGE-004]
id = "PURGE-004"
name = "Clean up repository and expire reflog"
status = "completed"
phase = "history-purge"
agent = "infrastructure-agent"
estimated_time = "5 minutes"
completed_at = "2025-11-09T12:50:00Z"
dependencies = ["PURGE-003"]

description = """
After BFG removes files, clean up dangling objects and expire reflog.
This completes the history rewrite and reclaims disk space.
"""

deliverables = [
    "Reflog expired (all refs to deleted commits gone)",
    "Garbage collection complete",
    "Repository size reduced"
]

validation_criteria = [
    "git reflog expire completes successfully",
    "git gc completes without errors",
    "Repository size decreased significantly"
]

implementation_steps = """
cd lumina-mirror.git

# Expire reflog immediately (removes refs to deleted commits)
git reflog expire --expire=now --all

# Aggressive garbage collection (reclaim space)
git gc --prune=now --aggressive

# Verify size reduction
du -sh .
"""

error_handling = """
- If git gc fails, check disk space
- Aggressive gc may take 2-5 minutes (normal)
- Verify no errors in gc output
"""

[tasks.PURGE-005]
id = "PURGE-005"
name = "Force push cleaned history to GitHub"
status = "completed"
phase = "history-purge"
agent = "infrastructure-agent"
estimated_time = "10 minutes"
completed_at = "2025-11-09T13:05:00Z"
dependencies = ["PURGE-004"]
severity = "CRITICAL"

description = """
Force push the cleaned repository history to GitHub origin.
This REWRITES public history - all existing clones will be outdated.
IRREVERSIBLE operation - coordinate with team before executing.
"""

why = """
Cleaned history must replace public history on GitHub.
Force push required because history was rewritten (commits changed).
"""

deliverables = [
    "Cleaned history pushed to GitHub origin",
    "All branches updated with new history",
    "products/lumina-web/ absent from GitHub public view"
]

validation_criteria = [
    "Force push completes successfully",
    "GitHub repo shows no products/lumina-web/ in history",
    "All branches updated",
    "No force push errors"
]

implementation_steps = """
cd lumina-mirror.git

# Force push ALL refs (branches + tags) to origin
git push --force --all
git push --force --tags

# Expected output:
# + [forced update] master -> master
# + [forced update] feature/* -> feature/*
"""

error_handling = """
- If push fails with 403/401: Check GitHub authentication
- If push fails with protected branch: Temporarily disable protection
- If network error: Retry with exponential backoff
- Monitor GitHub UI to confirm push succeeded
"""

warning = """
[WARNING] COORDINATE WITH TEAM BEFORE EXECUTING [WARNING]
- Anyone with existing clones will have broken history
- They must re-clone after this completes
- Force push cannot be undone
- Ensure backup exists (lumina-clean working directory)
"""

# ============================================================================
# PHASE 3: LOCAL CLEANUP & SUBMODULE SETUP
# ============================================================================

[tasks.CLEANUP-001]
id = "CLEANUP-001"
name = "Remove lumina-web from local working directory"
status = "completed"
phase = "local-cleanup"
agent = "infrastructure-agent"
estimated_time = "5 minutes"
completed_at = "2025-11-09T13:10:00Z"
dependencies = ["PURGE-005"]

description = """
Remove products/lumina-web/ from local working directory.
This folder should never have been in the public repo.
"""

deliverables = [
    "products/lumina-web/ deleted from filesystem",
    "Directory removed from git tracking"
]

validation_criteria = [
    "products/lumina-web/ no longer exists locally",
    "git status shows folder deleted"
]

implementation_steps = """
cd "C:/Users/Brett/Dropbox/Ferret9 Global/lumina-clean"

# Remove from git tracking
git rm -rf products/lumina-web

# Verify deletion
git status
# Should show: deleted: products/lumina-web/
"""

error_handling = """
- If git rm fails, manually delete folder then git add
- Verify folder is fully deleted (no remnants)
- Check git status shows deleted files
"""

[tasks.CLEANUP-002]
id = "CLEANUP-002"
name = "Update .gitignore to prevent future accidents"
status = "completed"
phase = "local-cleanup"
agent = "infrastructure-agent"
estimated_time = "5 minutes"
completed_at = "2025-11-09T13:15:00Z"
dependencies = ["CLEANUP-001"]

description = """
Add products/lumina-web/ to .gitignore to prevent accidental re-addition.
Also add website/ directory (will be submodule for integration docs).
"""

deliverables = [
    ".gitignore updated with products/lumina-web/ and website/",
    "Documentation comment explaining why"
]

validation_criteria = [
    ".gitignore contains products/lumina-web/",
    ".gitignore contains website/",
    "Comments explain submodule architecture"
]

implementation_steps = """
# Add to .gitignore:

# Private website code (NEVER commit directly - use submodule)
products/lumina-web/

# Website submodule (for integration docs only - private repo)
website/
"""

error_handling = """
- Verify .gitignore syntax (no typos)
- Test with 'git check-ignore products/lumina-web' (should match)
- Commit .gitignore changes before submodule setup
"""

[tasks.SUBMODULE-001]
id = "SUBMODULE-001"
name = "Add website repo as submodule at website/"
status = "completed"
phase = "submodule-setup"
agent = "infrastructure-agent"
estimated_time = "10 minutes"
completed_at = "2025-11-09T13:30:00Z"
dependencies = ["CLEANUP-002"]

description = """
Add https://github.com/AEtherlight-ai/website as git submodule.
This provides integration docs while keeping private implementation private.
"""

why = """
Two-repo architecture:
- lumina (PUBLIC): VS Code extension, desktop app, public docs
- website (PRIVATE): Next.js dashboard, API keys, Stripe integration

Submodule at website/ allows:
- Public repo references private repo (read-only for integration docs)
- Private implementation stays private
- Integration docs (.integration/) accessible to public repo AI
"""

deliverables = [
    ".gitmodules file created with website submodule",
    "website/ directory initialized with submodule content",
    "website/.integration/ docs accessible"
]

validation_criteria = [
    "git submodule status shows website submodule",
    ".gitmodules contains correct URL",
    "website/.integration/ directory exists with docs"
]

implementation_steps = """
cd "C:/Users/Brett/Dropbox/Ferret9 Global/lumina-clean"

# Add submodule
git submodule add https://github.com/AEtherlight-ai/website website/

# Initialize and update submodule
git submodule update --init --recursive

# Verify submodule
cd website/
git status
ls -la .integration/

# Return to root
cd ..
git status
# Should show:
#   new file: .gitmodules
#   new file: website (submodule)
"""

error_handling = """
- If authentication fails: Check GitHub credentials
- If submodule init fails: Verify URL is correct
- If .integration/ missing: Check private repo has this directory
- Submodule should point to specific commit (not branch)
"""

[tasks.SUBMODULE-002]
id = "SUBMODULE-002"
name = "Verify integration docs accessible from submodule"
status = "completed"
phase = "submodule-setup"
agent = "infrastructure-agent"
estimated_time = "10 minutes"
completed_at = "2025-11-09T13:35:00Z"
dependencies = ["SUBMODULE-001"]

description = """
Verify that integration documentation is accessible via submodule.
Test that AI can read docs to understand two-repo architecture.
"""

deliverables = [
    "All integration docs readable from website/.integration/",
    "Verification that docs describe desktop app integration",
    "Test README explains submodule purpose"
]

validation_criteria = [
    "website/.integration/LUMINA_REPO_ONBOARDING.md exists",
    "website/.integration/specs/api-spec.md exists",
    "website/.integration/tasks/CURRENT_TASK.md exists",
    "website/TWO_REPO_ARCHITECTURE.md exists"
]

implementation_steps = """
cd website/

# Verify integration docs exist
ls -la .integration/
cat .integration/LUMINA_REPO_ONBOARDING.md
cat TWO_REPO_ARCHITECTURE.md
cat .integration/specs/api-spec.md
cat .integration/tasks/CURRENT_TASK.md

# If docs missing, contact private repo owner to add them
"""

error_handling = """
- If .integration/ doesn't exist in website repo:
  â†’ Create it in private repo first, then update submodule
- If docs are incomplete:
  â†’ Document required content structure
  â†’ Notify private repo owner
- If submodule points to wrong commit:
  â†’ Update submodule to latest commit with docs
"""

# ============================================================================
# PHASE 4: VERIFICATION & DOCUMENTATION
# ============================================================================

[tasks.VERIFY-001]
id = "VERIFY-001"
name = "Verify lumina-web absent from public GitHub history"
status = "completed"
phase = "verification"
agent = "infrastructure-agent"
estimated_time = "15 minutes"
completed_at = "2025-11-09T13:45:00Z"
dependencies = ["PURGE-005", "SUBMODULE-002"]

description = """
Comprehensive verification that products/lumina-web/ is gone from history.
Check GitHub UI, git log, and all branches.
"""

deliverables = [
    "Confirmation that GitHub shows no lumina-web/ in history",
    "git log verification (no commits reference lumina-web)",
    "All branches checked and clean"
]

validation_criteria = [
    "GitHub repo search for 'lumina-web' returns no results",
    "git log --all --oneline -- products/lumina-web returns nothing",
    "No API routes visible in public repo",
    "Stripe webhook code not in history"
]

implementation_steps = """
# 1. Check GitHub UI
Open: https://github.com/AEtherlight-ai/lumina
Search: "lumina-web" (should find nothing)
Browse: products/ directory (should not contain lumina-web/)

# 2. Local git verification
cd "C:/Users/Brett/Dropbox/Ferret9 Global/lumina-clean"
git pull --rebase  # Get cleaned history

# Check history
git log --all --oneline -- products/lumina-web
# Expected: (no output - file never existed)

# Check current state
ls products/
# Expected: lumina-desktop (only)

# 3. Check all branches
git branch -r
for branch in $(git branch -r); do
  echo "Checking $branch"
  git log $branch --oneline -- products/lumina-web
done
# Expected: (no output for all branches)
"""

error_handling = """
- If lumina-web still appears: Force push may have failed, retry PURGE-005
- If GitHub shows stale cache: Wait 5-10 minutes, refresh
- If any branch shows lumina-web: That branch needs cleanup
"""

[tasks.VERIFY-002]
id = "VERIFY-002"
name = "Verify submodule works correctly"
status = "completed"
phase = "verification"
agent = "infrastructure-agent"
estimated_time = "10 minutes"
completed_at = "2025-11-09T13:50:00Z"
dependencies = ["SUBMODULE-001", "SUBMODULE-002"]

description = """
Test that submodule can be cloned by fresh users.
Verify integration docs are accessible after fresh clone.
"""

deliverables = [
    "Fresh clone test with submodule init",
    "Integration docs readable from fresh clone",
    "Submodule commit pinned correctly"
]

validation_criteria = [
    "git clone --recurse-submodules works",
    "website/.integration/ exists in fresh clone",
    "Submodule points to stable commit (not HEAD)"
]

implementation_steps = """
# Test in separate directory
cd "C:/Users/Brett/Dropbox/Ferret9 Global"
mkdir test-clone
cd test-clone

# Clone with submodules
git clone --recurse-submodules https://github.com/AEtherlight-ai/lumina.git

cd lumina/

# Verify submodule initialized
git submodule status
# Expected: active commit SHA for website

# Verify integration docs accessible
ls website/.integration/
cat website/.integration/LUMINA_REPO_ONBOARDING.md

# Cleanup test
cd ../..
rm -rf test-clone/
"""

error_handling = """
- If submodule not initialized: Check .gitmodules is committed
- If authentication fails: Private repo requires GitHub login
- If docs missing: Update submodule to commit with docs
"""

[tasks.DOC-001]
id = "DOC-001"
name = "Document incident and recovery process"
status = "completed"
phase = "documentation"
agent = "documentation-agent"
estimated_time = "30 minutes"
completed_at = "2025-11-09T14:00:00Z"
dependencies = ["VERIFY-001", "VERIFY-002"]

description = """
Create incident report documenting what happened, how it was fixed, and prevention.
Add to KNOWN_ISSUES.md with pattern reference.
"""

deliverables = [
    "Incident report in docs/incidents/REPO_LEAK_2025-11-09.md",
    "KNOWN_ISSUES.md entry with lessons learned",
    "Pattern-GIT-002 created (Submodule Architecture Pattern)"
]

validation_criteria = [
    "Incident timeline documented",
    "Root cause analysis complete",
    "Prevention checklist added to pre-flight protocols",
    "Future developers can learn from this"
]

implementation_steps = """
Create docs/incidents/REPO_LEAK_2025-11-09.md:

# Repository Security Incident: Private Code Leak (2025-11-09)

## Severity: HIGH (pre-launch, no production impact)

## Timeline
- 2025-11-09 11:00 UTC: Leak discovered during desktop app integration
- 2025-11-09 11:30 UTC: Damage assessment complete
- 2025-11-09 12:00 UTC: Emergency sprint created
- 2025-11-09 14:00 UTC: History purged with BFG
- 2025-11-09 15:00 UTC: Submodule architecture implemented
- 2025-11-09 16:00 UTC: Verification complete

## What Happened
products/lumina-web/ (private website code) was committed directly to public repo
instead of being added as git submodule.

## Root Cause
Miscommunication during repository setup. Protocol called for:
- Public repo (lumina): VS Code extension, desktop app
- Private repo (website): Next.js dashboard, API keys
- Submodule integration: website/ for docs only

Instead: Private website code added directly to public repo (4 commits).

## Impact
- API implementation exposed (Stripe webhooks, auth logic, credit system)
- No keys/secrets leaked (.env.local was gitignored)
- Pre-launch timing = zero production impact
- Clean history rewrite possible

## Recovery
1. BFG Repo-Cleaner purged products/lumina-web/ from all history
2. Force push cleaned history to GitHub
3. Proper submodule setup at website/ for integration docs
4. .gitignore updated to prevent recurrence

## Prevention
1. **Added to Pre-Flight Checklist (CLAUDE.md):**
   - Before adding new directories: Check if should be submodule
   - Verify private code never committed to public repo
   - Use .gitignore for sensitive directories

2. **Pattern-GIT-002 Created (Submodule Architecture):**
   - Document when to use submodules vs direct commits
   - Two-repo integration best practices
   - Submodule maintenance workflows

## Lessons Learned
[OK] Pre-launch timing saved us (no user impact)
[OK] BFG Repo-Cleaner is effective for history cleanup
[OK] Always verify repo architecture before first commit
[OK] .gitignore is critical for sensitive directories

[X] Should have caught this during initial setup
[X] Need automated checks for submodule violations
[X] Protocol documentation wasn't explicit enough
"""

error_handling = """
- Ensure incident report is accurate (review with team)
- Link to relevant commits and timestamps
- Include specific recovery commands for future reference
"""

[tasks.DOC-002]
id = "DOC-002"
name = "Create Pattern-GIT-002 (Submodule Architecture)"
status = "completed"
phase = "documentation"
agent = "documentation-agent"
estimated_time = "45 minutes"
completed_at = "2025-11-09T14:15:00Z"
dependencies = ["DOC-001"]

description = """
Create architectural pattern documenting when and how to use git submodules.
Prevent future incidents by providing clear guidelines.
"""

deliverables = [
    "docs/patterns/Pattern-GIT-002.md (Submodule Architecture)",
    "Pattern indexed in docs/patterns/INDEX.md",
    "Examples of correct submodule usage"
]

validation_criteria = [
    "Pattern explains two-repo architecture clearly",
    "Decision tree for submodule vs direct commit",
    "Maintenance workflows documented",
    "Prevention checklist included"
]

content_outline = """
# Pattern-GIT-002: Git Submodule Architecture for Public/Private Repos

## Context
When building products with public open-source components and private commercial components,
proper repository architecture is critical for security.

## Problem
- Public repo needs some access to private repo (integration docs)
- Private repo must never leak into public history
- Developers may accidentally commit private code to public repo

## Solution: Git Submodules
Use git submodules to reference private repos from public repos.

## When to Use Submodules
[OK] Private commercial code referenced from public repo
[OK] Integration documentation needs to bridge repos
[OK] Read-only access to subset of private repo
[OK] Version pinning required (submodule commit SHA)

## When NOT to Use Submodules
[X] Small helper utilities (copy to public repo instead)
[X] Public dependencies (use package manager)
[X] Temporary integrations (use build scripts)

## Architecture Example: Ã†therLight

### Public Repo (lumina)
- VS Code extension (vscode-lumina/)
- Desktop app (products/lumina-desktop/)
- Public documentation (docs/)
- **Submodule:** website/ (integration docs only)

### Private Repo (website)
- Next.js dashboard (app/)
- API routes with keys (app/api/)
- Supabase integration (lib/)
- **Exposed via submodule:** .integration/ (docs only)

## Setup Workflow

1. Create public repo structure:
   ```bash
   mkdir lumina && cd lumina
   git init
   echo "website/" >> .gitignore  # Prevent accidents
   ```

2. Add private repo as submodule:
   ```bash
   git submodule add https://github.com/org/private-repo website/
   git submodule update --init --recursive
   ```

3. Commit submodule reference:
   ```bash
   git add .gitmodules website/
   git commit -m "Add private repo as submodule for integration docs"
   ```

## Maintenance

### Updating Submodule
```bash
cd website/
git pull origin main
cd ..
git add website/
git commit -m "Update website submodule to latest"
```

### Cloning with Submodules
```bash
git clone --recurse-submodules https://github.com/org/public-repo
```

## Prevention Checklist

Before committing ANY new directory:
- [ ] Is this private code? â†’ Use submodule
- [ ] Does it contain API keys? â†’ Use submodule
- [ ] Is it commercial/proprietary? â†’ Use submodule
- [ ] Should it be versioned independently? â†’ Use submodule

## Recovery from Violation

If private code accidentally committed to public repo:
1. **Immediate:** Rotate all keys/secrets in leaked code
2. **History cleanup:** Use BFG Repo-Cleaner (see incident report)
3. **Proper setup:** Add as submodule
4. **Verification:** Check GitHub history is clean

## References
- Incident: docs/incidents/REPO_LEAK_2025-11-09.md
- BFG Repo-Cleaner: https://rtyley.github.io/bfg-repo-cleaner/
- Git Submodules: https://git-scm.com/book/en/v2/Git-Tools-Submodules
"""

error_handling = """
- Validate pattern against real-world scenarios
- Include specific commands (copy-paste ready)
- Link to incident report for context
"""

[tasks.DOC-003]
id = "DOC-003"
name = "Update CLAUDE.md with submodule architecture notes"
status = "completed"
phase = "documentation"
agent = "documentation-agent"
estimated_time = "20 minutes"
completed_at = "2025-11-09T14:20:00Z"
dependencies = ["DOC-002"]

description = """
Add submodule architecture notes to CLAUDE.md Pre-Flight Checklist.
Ensure future AI sessions check for submodule violations before committing.
"""

deliverables = [
    "CLAUDE.md updated with submodule checklist",
    "Reference to Pattern-GIT-002 added",
    "Historical incident referenced"
]

validation_criteria = [
    "Pre-flight checklist includes submodule check",
    "Clear guidance on public vs private code",
    "Link to Pattern-GIT-002 for details"
]

implementation_steps = """
Add to CLAUDE.md Pre-Flight Checklist:

### Before Adding New Directories:

**STOP. Answer these questions OUT LOUD in your response:**

1. [OK] **Is this private/proprietary code?**
   - Check for: API keys, commercial logic, customer data, auth secrets
   - If YES â†’ **MUST use git submodule** (Pattern-GIT-002)
   - If NO â†’ Can commit directly (public code only)

2. [OK] **Does this directory belong in the public repo?**
   - Public repo (lumina): VS Code extension, desktop app, public docs
   - Private repo (website): Next.js dashboard, API routes, Stripe integration
   - If unsure â†’ **Ask user before committing**

3. [OK] **Is there a .gitignore entry to prevent accidents?**
   - Private directories should be gitignored
   - Submodule directories should be gitignored
   - Verify: git check-ignore <directory>

**Historical Incident:** REPO_LEAK_2025-11-09
- products/lumina-web/ leaked into public repo (4 commits)
- BFG Repo-Cleaner required to purge history
- Pattern-GIT-002 created to prevent recurrence

**If you skip this checklist, you may leak private code into public history.**
"""

error_handling = """
- Ensure checklist is prominent (before Edit/Write section)
- Make it mandatory (same as other pre-flight checks)
- Link to incident report for impact context
"""

# ============================================================================
# PHASE 5: TEAM COMMUNICATION & COORDINATION
# ============================================================================

[tasks.COMM-001]
id = "COMM-001"
name = "Notify team of force push and re-clone requirement"
status = "completed"
phase = "communication"
agent = "documentation-agent"
estimated_time = "15 minutes"
completed_at = "2025-11-09T14:30:00Z"
dependencies = ["VERIFY-001"]

description = """
Notify all team members that history was rewritten.
Anyone with existing clones MUST re-clone or reset.
"""

why = """
Force push rewrites history - existing clones have broken refs.
git pull will fail with "divergent branches" error.
Only solution: Fresh clone or hard reset.
"""

deliverables = [
    "Team notification sent (email/Slack/Discord)",
    "Re-clone instructions provided",
    "Coordination checklist for re-clone"
]

validation_criteria = [
    "All team members notified",
    "Clear instructions for re-cloning",
    "Backup reminder (save local uncommitted work)"
]

notification_template = """
ðŸš¨ URGENT: Repository History Rewritten ðŸš¨

The lumina repository history has been cleaned to remove accidentally leaked private code.

**What happened:**
- Private website code (products/lumina-web/) was committed to public repo
- History purged using BFG Repo-Cleaner (security fix)
- Force push completed to GitHub

**What you need to do:**

1. **Backup your local work:**
   ```bash
   cd lumina
   git stash  # Save uncommitted changes
   # OR commit to a temporary branch
   ```

2. **Delete your local clone:**
   ```bash
   cd ..
   rm -rf lumina/
   ```

3. **Fresh clone with submodules:**
   ```bash
   git clone --recurse-submodules https://github.com/AEtherlight-ai/lumina.git
   cd lumina/
   git stash pop  # Restore your work (if stashed)
   ```

**What changed:**
- products/lumina-web/ no longer exists in this repo
- New submodule: website/ (for integration docs from private repo)
- .gitignore updated to prevent future accidents

**Timeline:**
- Force push completed: 2025-11-09 14:00 UTC
- All branches updated
- Fresh clones should work immediately

**Questions?** See docs/incidents/REPO_LEAK_2025-11-09.md

Thanks for your understanding during this security fix.
"""

error_handling = """
- Ensure notification reaches ALL team members
- Provide support for re-clone issues
- Document common problems (authentication, submodule init)
"""

[tasks.COMM-002]
id = "COMM-002"
name = "Update README with submodule clone instructions"
status = "completed"
completed_at = "2025-11-09T14:25:00Z"
phase = "communication"
agent = "documentation-agent"
estimated_time = "15 minutes"
dependencies = ["SUBMODULE-002"]

description = """
Update README.md with correct clone instructions including submodules.
New contributors must know to use --recurse-submodules flag.
"""

deliverables = [
    "README.md updated with submodule clone instructions",
    "Troubleshooting section for submodule issues",
    "Link to Pattern-GIT-002 for architecture explanation"
]

validation_criteria = [
    "Clone instructions include --recurse-submodules",
    "Alternative manual init steps documented",
    "Submodule purpose explained"
]

implementation_steps = """
Update README.md:

## Installation

### Clone Repository (with submodules)

```bash
git clone --recurse-submodules https://github.com/AEtherlight-ai/lumina.git
cd lumina/
```

**Note:** The `--recurse-submodules` flag initializes the `website/` submodule,
which contains integration documentation for the private website dashboard.

### If you already cloned without submodules:

```bash
git submodule update --init --recursive
```

### Repository Structure

- `vscode-lumina/` - VS Code extension (public)
- `products/lumina-desktop/` - Tauri desktop app (public)
- `website/` - Git submodule to private website repo (integration docs only)

For architecture details, see [Pattern-GIT-002](docs/patterns/Pattern-GIT-002.md).
"""

error_handling = """
- Test clone instructions in fresh environment
- Verify submodule init works for new contributors
- Update troubleshooting section if issues arise
"""

# ============================================================================
# PHASE 6: FEATURE BRANCH CLEANUP (CRITICAL DISCOVERY)
# ============================================================================

[tasks.BRANCH-001]
id = "BRANCH-001"
name = "Analyze all feature branches for leaked code"
status = "completed"
phase = "branch-cleanup"
agent = "infrastructure-agent"
estimated_time = "30 minutes"
completed_at = "2025-11-09T15:00:00Z"
dependencies = ["COMM-001"]

description = """
CRITICAL DISCOVERY: Security audit revealed feature branches still contain leaked code.
BFG cleaned master but feature branches (feature/key-authorization, etc.) still have
commits ecdea90, bf3de3e, e680514, 4d38f65 with all 58 lumina-web files.

Analyze all branches to identify:
1. Which commits contain leaked code (must skip)
2. Which commits are clean work (must preserve)
3. Dependencies between commits (maintain order)
4. Sprint/testing references in commit messages
"""

why = """
The force push cleaned master branch but left feature branches untouched.
Anyone checking out these feature branches can still access the leaked private code.
Security incident is NOT resolved until ALL branches are clean.
"""

deliverables = [
    "List of all branches with leaked code",
    "Map of commits to preserve vs skip",
    "Analysis of commit dependencies",
    "Cross-reference with sprint files and tests"
]

validation_criteria = [
    "All branches identified and analyzed",
    "Each commit categorized (keep/skip)",
    "Dependencies mapped correctly",
    "No work will be lost in cleanup"
]

implementation_steps = """
# 1. List all branches
git branch -a | grep -v HEAD

# 2. For each branch, check for leaked commits
for branch in $(git branch -a | grep -v HEAD); do
  echo "Checking $branch..."
  git log --oneline $branch -- products/lumina-web
done

# 3. Identify commits with leaked code
git log --all --oneline -- products/lumina-web | grep -v "Remove products/lumina-web"

# 4. Cross-reference commits with sprint files
grep -r "ecdea90\\|bf3de3e\\|e680514\\|4d38f65" internal/sprints/ vscode-lumina/test/

# 5. Map commit ranges to preserve
git log --oneline feature/key-authorization ^master --reverse
# Skip: ecdea90, bf3de3e, e680514, 4d38f65
# Keep: Everything else (98 commits)
"""

error_handling = """
- If commits reference each other: Preserve dependency order
- If tests reference specific commits: Update test fixtures
- If sprint files reference commits: Document in cleanup notes
"""

[tasks.BRANCH-002]
id = "BRANCH-002"
name = "Execute feature branch cleanup (cherry-pick clean commits)"
status = "completed"
phase = "branch-cleanup"
agent = "infrastructure-agent"
estimated_time = "45 minutes"
completed_at = "2025-11-09T15:45:00Z"
dependencies = ["BRANCH-001"]

description = """
Clean all feature branches by cherry-picking commits WITHOUT leaked code.
Use git rebase or cherry-pick to create new clean branches from master.
Preserve 98 commits, skip 4 leaked commits.
"""

why = """
Cherry-picking preserves commit history and authorship while excluding leaked code.
This is safer than filter-branch and preserves all metadata (author, date, message).
"""

deliverables = [
    "Clean feature branches created",
    "All good commits preserved",
    "Leaked commits excluded",
    "Branch history verified clean"
]

validation_criteria = [
    "git log --all -- products/lumina-web shows ONLY removal commits",
    "No commits contain lumina-web files (verify with git ls-tree)",
    "All recent work preserved (98 commits accounted for)",
    "Tests still pass after branch cleanup"
]

implementation_steps = """
# For feature/key-authorization (102 commits, skip 4 leaked)

# 1. Create backup
git branch backup-feature-key-authorization feature/key-authorization

# 2. Get list of commits to preserve (in order, oldest first)
git log --reverse --oneline feature/key-authorization ^master > commits.txt

# 3. Remove leaked commits from list
# Skip: ecdea90, bf3de3e, e680514, 4d38f65
sed -i '/ecdea90/d; /bf3de3e/d; /e680514/d; /4d38f65/d' commits.txt

# 4. Create new clean branch
git checkout master
git checkout -b feature/key-authorization-clean

# 5. Cherry-pick clean commits
while read commit msg; do
  git cherry-pick $commit || {
    echo "Conflict on $commit: $msg"
    # Handle conflicts manually
    break
  }
done < commits.txt

# 6. Verify clean
git log --oneline feature/key-authorization-clean -- products/lumina-web
# Should show ONLY: "Remove products/lumina-web" commits

# 7. Replace old branch
git branch -D feature/key-authorization
git branch -m feature/key-authorization-clean feature/key-authorization

# 8. Repeat for other branches:
#    - feature/protect-000-task-prompt-export
#    - feature/unlink-sprint-view
"""

error_handling = """
- If cherry-pick conflicts: Resolve manually, test, continue
- If commit depends on leaked commit: Modify commit to remove dependency
- If tests fail after cleanup: Update test fixtures/references
- Keep backup branches until verification complete
"""

[tasks.BRANCH-003]
id = "BRANCH-003"
name = "Force push cleaned feature branches and verify"
status = "completed"
phase = "branch-cleanup"
agent = "infrastructure-agent"
estimated_time = "20 minutes"
completed_at = "2025-11-09T15:50:00Z"
dependencies = ["BRANCH-002"]

description = """
Force push all cleaned feature branches to GitHub.
Verify that GitHub history no longer contains leaked code.
"""

deliverables = [
    "All feature branches force-pushed",
    "GitHub history verified clean",
    "Backup branches preserved locally",
    "Team notification updated"
]

validation_criteria = [
    "GitHub shows clean history for all branches",
    "No reachable commits contain lumina-web files",
    "Fresh clone + checkout of any branch shows NO private code",
    "All CI/CD checks pass on cleaned branches"
]

implementation_steps = """
# 1. Force push cleaned branches
git push -f origin feature/key-authorization
git push -f origin feature/protect-000-task-prompt-export
git push -f origin feature/unlink-sprint-view

# 2. Verify on GitHub
# Navigate to: https://github.com/AEtherlight-ai/lumina/commits/feature/key-authorization
# Search for: "products/lumina-web"
# Expected: Only removal commits visible

# 3. Test fresh clone
cd /tmp
git clone --recurse-submodules https://github.com/AEtherlight-ai/lumina.git test-feature-cleanup
cd test-feature-cleanup
git checkout feature/key-authorization
ls products/
# Expected: Only lumina-desktop/

git log --all -- products/lumina-web
# Expected: Only removal commits

# 4. Clean up test clone
cd ..
rm -rf test-feature-cleanup/
"""

error_handling = """
- If force push rejected: Check branch protection settings
- If GitHub still shows leaked commits: Wait for GitHub cache refresh (5 min)
- If fresh clone shows private code: Re-run BRANCH-002 cleanup
"""

# ============================================================================
# PHASE 7: FINAL VERIFICATION & SPRINT CLOSURE
# ============================================================================

[tasks.FINAL-001]
id = "FINAL-001"
name = "Complete security audit checklist"
status = "completed"
phase = "final-verification"
agent = "infrastructure-agent"
estimated_time = "30 minutes"
completed_at = "2025-11-09T16:00:00Z"
dependencies = ["VERIFY-001", "VERIFY-002", "DOC-003", "COMM-002"]

description = """
Final security audit to confirm no sensitive data remains in public repo.
Comprehensive checklist covering all attack vectors.
"""

deliverables = [
    "Security audit checklist completed",
    "Confirmation of zero sensitive data in history",
    "Sign-off for pre-launch security"
]

validation_criteria = [
    "[OK] No API keys in history",
    "[OK] No private code in history",
    "[OK] Submodule properly configured",
    "[OK] .gitignore prevents future leaks",
    "[OK] Team notified and re-cloned"
]

audit_checklist = """
# Security Audit Checklist: Post-Cleanup

## 1. History Verification
- [ ] git log --all --oneline -- products/lumina-web â†’ (no results)
- [ ] GitHub search "lumina-web" â†’ (no results)
- [ ] GitHub search "SUPABASE_SERVICE_ROLE_KEY" â†’ (no results)
- [ ] GitHub search "STRIPE_SECRET_KEY" â†’ (no results)
- [ ] GitHub search "api/desktop/transcribe" â†’ (no results in wrong repo)

## 2. Current State Verification
- [ ] products/lumina-web/ does NOT exist in working directory
- [ ] .gitignore contains products/lumina-web/
- [ ] .gitignore contains website/
- [ ] website/ submodule initialized correctly
- [ ] website/.integration/ docs accessible

## 3. Submodule Verification
- [ ] .gitmodules points to correct private repo URL
- [ ] Submodule commit SHA pinned (not floating HEAD)
- [ ] Fresh clone with --recurse-submodules works
- [ ] Submodule authentication requires GitHub login (private)

## 4. Prevention Mechanisms
- [ ] Pre-flight checklist updated in CLAUDE.md
- [ ] Pattern-GIT-002 created and indexed
- [ ] Incident report documents lessons learned
- [ ] README.md has submodule clone instructions

## 5. Team Coordination
- [ ] All team members notified of force push
- [ ] Re-clone instructions sent
- [ ] Support provided for re-clone issues
- [ ] No team members using stale clones

## 6. Documentation
- [ ] Incident report complete (docs/incidents/REPO_LEAK_2025-11-09.md)
- [ ] Pattern-GIT-002 complete (docs/patterns/Pattern-GIT-002.md)
- [ ] KNOWN_ISSUES.md updated with this incident
- [ ] CLAUDE.md pre-flight checklist updated

## 7. Final Verification
- [ ] Public repo GitHub page shows NO private code
- [ ] Private repo remains private (not accidentally made public)
- [ ] Integration still works (desktop app can read integration docs)
- [ ] CI/CD pipelines still functional (if any)

## Sign-Off
- [ ] Security lead approval: _______________
- [ ] Incident commander approval: _______________
- [ ] Date: 2025-11-09
"""

error_handling = """
- If ANY checklist item fails: STOP and investigate
- Do not sign off until ALL items pass
- Document any exceptions with justification
"""

[tasks.FINAL-002]
id = "FINAL-002"
name = "Archive sprint and update sprint tracker"
status = "completed"
phase = "final-verification"
agent = "documentation-agent"
estimated_time = "15 minutes"
completed_at = "2025-11-09T16:05:00Z"
dependencies = ["FINAL-001"]

description = """
Archive emergency sprint and update sprint tracking system.
Document sprint success metrics and lessons learned.
"""

deliverables = [
    "Sprint archived to internal/sprints/archive/EMERGENCY_REPO_CLEANUP.toml",
    "Sprint success metrics calculated",
    "Retrospective notes added to sprint"
]

validation_criteria = [
    "All tasks marked completed",
    "Sprint status changed to 'completed'",
    "Completion time documented",
    "Lessons learned captured"
]

implementation_steps = """
Update sprint metadata status to 'completed' and add retrospective section with lessons learned.
Then archive the sprint file to internal/sprints/archive/ directory.

Retrospective notes to add:
- Success: Pre-launch timing perfect, BFG worked flawlessly, team coordination smooth
- Improvements: Catch earlier in setup, add automated checks, clearer protocols
- Actions: Pre-flight checklist updated, Pattern-GIT-002 created, consider git hooks
"""

error_handling = """
- Ensure all retrospective notes are captured
- Update sprint tracking dashboard (if exists)
- Link to incident report and patterns
"""

# ============================================================================
# PROGRESS TRACKING
# ============================================================================

[progress]
total_tasks = 23
completed_tasks = 23  # ALL TASKS COMPLETE
in_progress_tasks = 0
pending_tasks = 0
completion_percentage = 100
notes = "âœ… EMERGENCY CLEANUP COMPLETE - All leaked code removed, Sprint 4 work preserved"

[notes]
priority_order = """
1. PURGE-001 to PURGE-005: History cleanup (CRITICAL - must complete ASAP)
2. CLEANUP-001 to SUBMODULE-002: Local setup (IMPORTANT - enables integration)
3. VERIFY-001 to VERIFY-002: Verification (REQUIRED - confirm success)
4. DOC-001 to DOC-003: Documentation (IMPORTANT - prevent recurrence)
5. COMM-001 to COMM-002: Team communication (REQUIRED - avoid broken clones)
6. FINAL-001 to FINAL-002: Final verification (REQUIRED - sign-off)
"""

risk_mitigation = """
Risk: Force push may fail if branch protection enabled
Mitigation: Temporarily disable branch protection during PURGE-005

Risk: Team members may have uncommitted work
Mitigation: COMM-001 provides backup instructions before re-clone

Risk: Submodule authentication may fail for team
Mitigation: COMM-002 includes troubleshooting for private repo access

Risk: Integration may break after submodule setup
Mitigation: VERIFY-002 tests fresh clone with submodule init
"""

success_criteria_summary = """
Sprint succeeds when ALL of these are true:
[OK] products/lumina-web/ absent from GitHub history
[OK] website/ submodule properly configured and accessible
[OK] Team re-cloned successfully (no broken local repos)
[OK] Security audit checklist 100% pass
[OK] Documentation complete (incident report + pattern + checklist)
[OK] Pre-launch security approved for v0.17.0 release
"""
