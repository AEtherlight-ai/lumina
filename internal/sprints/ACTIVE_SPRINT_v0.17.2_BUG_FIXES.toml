[metadata]
version = "0.17.2"
sprint_number = "17.2"
sprint_name = "Critical TOML Syntax Fixes & Modal Regressions"
start_date = "2025-01-14"
target_completion = "2025-01-15"
status = "active"
created = "2025-01-14"
updated = "2025-01-14"

  [metadata.focus]
  primary = "Fix TOML syntax errors blocking Sprint Panel (CRITICAL CASCADE FAILURE)"
  secondary = "Restore modal functionality (Code Analyzer, Sprint Planner)"
  tertiary = "Fix prompt enhancement regressions"

  [metadata.priority_order]
  phase_0_critical_blockers = "BUG-017 (FIXED - recompile done), BUG-018 (CRITICAL - panel won't open), BUG-019 (CRITICAL - desktop transcription broken), BUG-015, BUG-016 (TOML syntax blocks features)"
  phase_1 = "HIGH - Modal regression fixes (Code Analyzer, Sprint Planner)"
  phase_2 = "HIGH - Prompt enhancement regression fixes"
  phase_3 = "MEDIUM - Desktop app connection warnings (expected after app removal)"
  phase_4 = "Quality Assurance - Testing & validation"
  phase_5 = "Documentation - CHANGELOG & completion reports"

  [metadata.audit_context]
  audit_trigger = "User report: All features broken after Sprint 17.1 deployment + AetherLight panel won't open + Desktop app transcription fails"
  critical_bugs_found = 10
  severity = "CRITICAL - Extension activation failure + Webview service worker mismatch + Desktop transcription API missing + TOML syntax errors cascade to all modal features"
  root_cause = "BUG-017: Non-extensible context object (FIXED - recompile needed) + BUG-018: Webview service worker mismatch + BUG-019: Server API endpoint not deployed + BUG-015/016: Markdown code blocks in TOML multi-line strings + template literal escapes"

  [metadata.team]
  team_size = 1
  default_engineer = "engineer_1"

    [[metadata.team.engineers]]
    id = "engineer_1"
    name = "BB_Aelor"
    expertise = [ "typescript", "vscode-extensions", "toml", "debugging" ]
    available_agents = [
      "infrastructure-agent",
      "testing-agent",
      "documentation-agent"
    ]
    max_parallel_tasks = 2
    daily_capacity_hours = 6

[tasks.BUG-017]
id = "BUG-017"
name = "Fix extension activation failure (Cannot add property tierGate)"
status = "completed"
phase = "extension-activation"
agent = "infrastructure-agent"
why = """
CRITICAL: Extension fails to activate completely with error 'Cannot add property tierGate, object is not extensible'.

Root Cause: VS Code extension context is sealed - cannot add arbitrary properties.
Impact: Extension doesn't load AT ALL - users see activation error, no features work.
Severity: CRITICAL - Blocks 100% of extension (worse than TOML bugs).
"""
context = """
Error Log:
Activating extension 'aetherlight.aetherlight' failed: Cannot add property tierGate, object is not extensible.

File: vscode-lumina/src/extension.ts:347
Code: (context as any).tierGate = tierGate;

VS Code seals extension context objects - cannot add properties dynamically.
Similar to IPC client issue (lines 450-452 had warnings about this).
"""
reasoning_chain = [
  "1. Extension activation starts",
  "2. Line 289 creates tierGate instance: const tierGate = new TierGate()",
  "3. Line 347 tries to add to context: (context as any).tierGate = tierGate",
  "4. VS Code context is sealed (non-extensible)",
  "5. Error: 'Cannot add property tierGate, object is not extensible'",
  "6. Extension activation fails completely",
  "7. No commands registered, no features work",
  "8. User sees activation error in console"
]
success_impact = """
After BUG-017 complete:
+ Extension activates successfully
+ All features available (voice panel, commands, etc.)
+ No activation errors in console
+ Users can use Ã†therLight
"""
files_to_modify = [
  "vscode-lumina/src/extension.ts (use module-level variable instead of context property)",
  "vscode-lumina/src/commands/captureVoiceGlobal.ts (accept tierGate as parameter)",
  "vscode-lumina/src/commands/captureVoice.ts (accept tierGate as parameter)"
]
deliverables = [
  "Add module-level tierGate variable (like desktopAppProcess)",
  "Remove line 347 that adds tierGate to context",
  "Update command signatures to accept tierGate as parameter",
  "Compile and verify extension activates",
  "Test in VS Code extension host (F5)"
]
estimated_time = "1 hour"
estimated_lines = 30
validation_criteria = [
  "Extension activates without errors",
  "No 'Cannot add property' errors",
  "Commands can access tierGate via closure",
  "Tier gating works correctly"
]
error_handling = """
Prevention:
- Never add properties to extension context (it's sealed)
- Use module-level variables for shared state
- Pass state as parameters to command register functions
- Document this pattern in KNOWN_ISSUES.md
"""
patterns = [ "Pattern-CODE-001", "Pattern-ACTIVATION-001" ]
completion_notes = """
Fixed 2025-01-14:
- Added module-level tierGate variable (extension.ts:91)
- Removed context property assignment (extension.ts:347)
- Updated captureVoiceGlobal.ts signature to accept tierGate parameter
- Updated captureVoice.ts signature to accept tierGate parameter
- Compiled successfully (npm run compile)
- Extension now activates without errors

Root cause: VS Code extension context is non-extensible (sealed object).
Solution: Use module-level variables for shared state (same pattern as desktopAppProcess).
"""

[tasks.BUG-015]
id = "BUG-015"
name = "Fix TOML syntax error at row 442 (markdown code blocks)"
status = "completed"
phase = "toml-syntax-fixes"
agent = "infrastructure-agent"
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-015_ENHANCED_PROMPT.md"
why = """
CRITICAL: TOML parser fails at row 442 with duplicate key error.

Root Cause: Markdown code blocks (```json) inside multi-line strings break TOML parsing.
Impact: Sprint Panel cannot load ANY tasks -> Cascade failure to all modals.
Severity: CRITICAL - Blocks 100% of extension features (modals, buttons, prompt enhancement).
"""
context = """
File: internal/sprints/ACTIVE_SPRINT.toml:442
Error: "Can't redefine existing key" (TOML parser interprets ``` as syntax, not string content)

Example problematic pattern:
'''toml
completion_notes = '''
Website API Response (ACTUAL):
```json
{
  "success": true
}
```
'''
'''

TOML parser sees ``` inside triple-quoted string and fails.
"""
reasoning_chain = [
  "1. ACTIVE_SPRINT.toml has markdown code blocks in completion_notes",
  "2. TOML parser encounters ``` at row 442",
  "3. Parser interprets ``` as syntax (not string content)",
  "4. TOML parsing fails with duplicate key error",
  "5. SprintLoader.loadSprint() throws exception",
  "6. Sprint Panel shows 'No tasks loaded'",
  "7. Code Analyzer modal cannot find tasks -> fails",
  "8. Sprint Planner modal cannot find tasks -> fails",
  "9. All task buttons fail with 'Task not found'",
  "10. Prompt enhancement cannot load context -> fails"
]
success_impact = """
After BUG-015 complete:
+ Sprint Panel loads tasks successfully
+ Code Analyzer modal can find and display tasks
+ Sprint Planner modal can find and display tasks
+ Task buttons work correctly
+ Prompt enhancement can load task context
"""
files_to_modify = [
  "internal/sprints/ACTIVE_SPRINT.toml (row 442 area - remove or escape code blocks)"
]
deliverables = [
  "Remove all markdown code blocks (```json, ```rust, etc.) from TOML strings",
  "Replace with plain text or indented code (no backticks)",
  "Validate TOML syntax with @iarna/toml parser",
  "Test Sprint Panel loads without errors"
]
estimated_time = "1-2 hours"
estimated_lines = 100
validation_criteria = [
  "TOML parses successfully (no errors)",
  "Sprint Panel shows tasks in dropdown",
  "No 'duplicate key' errors in console",
  "All tasks visible in Sprint Panel"
]
error_handling = """
Prevention:
- Never use markdown code blocks (```) in TOML multi-line strings
- Use plain text or indented code instead
- Always validate TOML after edits: node -e "require('@iarna/toml').parse(fs.readFileSync('file.toml', 'utf-8'))"
"""
patterns = [ "Pattern-CODE-001", "Pattern-VALIDATION-001" ]
completion_notes = """
Verified 2025-01-17:
- Tested TOML parsing with @iarna/toml - parses successfully
- No markdown code blocks (```) causing syntax errors
- All backticks properly escaped or in safe contexts
- ACTIVE_SPRINT.toml: 22 tasks loaded successfully
- No TOML parse errors in console

Status: TOML syntax is valid, no issues found.
"""

[tasks.BUG-016]
id = "BUG-016"
name = "Fix TOML template literal escape errors (backticks with ${})"
status = "completed"
phase = "toml-syntax-fixes"
agent = "infrastructure-agent"
why = """
CRITICAL: TOML parser fails with unknown escape character 96 (backtick).

Root Cause: Template literals with ${} in code examples (e.g., `Error: ${msg}`)
Impact: TOML parsing fails -> Sprint Panel cannot load.
Severity: CRITICAL - Blocks Sprint Panel from loading.
"""
context = """
Error: "Unknown escape character: 96" (96 is ASCII code for backtick `)
TOML escape sequences: \\, \\n, \\r, \\t, \\", \\uXXXX (backtick NOT supported)

Example problematic pattern:
'''toml
code_example = '''
const msg = `Error: ${err}`;  // BREAKS TOML
'''
'''

Fix: Replace template literals with string concatenation
const msg = 'Error: ' + err;  // VALID
"""
reasoning_chain = [
  "1. TOML string contains JavaScript template literal: `Error: ${msg}`",
  "2. TOML parser encounters backtick with backslash escape attempt",
  "3. Backtick is not a valid TOML escape character",
  "4. Parser fails with 'Unknown escape character: 96'",
  "5. SprintLoader cannot parse TOML",
  "6. Sprint Panel fails to load"
]
success_impact = """
After BUG-016 complete:
+ TOML parses without escape errors
+ Sprint Panel loads successfully
+ All code examples use valid syntax (no template literals)
"""
files_to_modify = [
  "internal/sprints/ACTIVE_SPRINT.toml (search for backticks in code examples)"
]
deliverables = [
  "Find all template literals with ${} in TOML strings",
  "Replace with string concatenation (+) or plain text",
  "Validate TOML syntax",
  "Test Sprint Panel loads"
]
estimated_time = "1 hour"
estimated_lines = 50
validation_criteria = [
  "No 'unknown escape character' errors",
  "TOML parses successfully",
  "Sprint Panel loads without errors"
]
error_handling = """
Prevention:
- Never use template literals (`${}`) in TOML strings
- Use string concatenation instead: 'Error: ' + msg
- Always validate TOML after edits
"""
patterns = [ "Pattern-CODE-001", "Pattern-VALIDATION-001" ]
dependencies = [ "BUG-015" ]
completion_notes = """
Verified 2025-01-17:
- Tested TOML parsing with @iarna/toml - parses successfully
- Searched for template literals (${}) - 0 found
- All code examples use string concatenation instead
- ACTIVE_SPRINT_v0.17.2_BUG_FIXES.toml: 15 tasks loaded successfully
- No escape character errors in console

Status: No template literals present, TOML is valid.
"""

[tasks.BUG-003]
id = "BUG-003"
name = "Debug Code Analyzer modal regression (not appearing)"
status = "completed"
phase = "modal-regression-fixes"
agent = "infrastructure-agent"
why = """
User-Reported: Code Analyzer modal does not appear after clicking button.

Historical Context: BUG-008 in Sprint 17.1 was marked 'completed' but modal still fails.
Impact: Users cannot use Code Analyzer feature.
Severity: HIGH - Core feature non-functional.
"""
context = """
Expected Behavior (from BUG-008 completion):
1. User clicks Code Analyzer button
2. Modal opens with task analysis

Actual Behavior:
1. User clicks button
2. Nothing happens (no modal, no error)
3. Console may show 'Task not found' error

Hypothesis: TOML parsing failure prevents modal from loading task data.
"""
reasoning_chain = [
  "1. User clicks Code Analyzer button",
  "2. Extension tries to load current task from Sprint Panel",
  "3. Sprint Panel has no tasks (TOML parse failure)",
  "4. Modal cannot find task to analyze",
  "5. Modal fails to open (silent failure or error)"
]
success_impact = """
After BUG-003 complete:
+ Code Analyzer button opens modal successfully
+ Modal displays task analysis
+ User can use Code Analyzer feature
"""
files_to_modify = [
  "vscode-lumina/src/commands/codeAnalyzer.ts (check modal trigger logic)",
  "vscode-lumina/src/services/SprintPanel.ts (check getCurrentTask() logic)"
]
deliverables = [
  "Identify why modal doesn't open",
  "Fix modal trigger logic (if needed)",
  "Add error handling for missing tasks",
  "Test Code Analyzer button opens modal"
]
estimated_time = "2 hours"
estimated_lines = 20
validation_criteria = [
  "Code Analyzer button opens modal",
  "Modal displays task analysis",
  "No silent failures",
  "Error message if no task selected"
]
error_handling = """
Safety checks:
- Check if currentTask exists before opening modal
- Show error notification if task not found
- Log error to console for debugging
"""
patterns = [ "Pattern-CODE-001", "Pattern-TDD-001" ]
dependencies = [ "BUG-015", "BUG-016", "BUG-021" ]
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-003_ENHANCED_PROMPT.md"
completion_notes = """
Root Cause Identified 2025-01-17:
- BUG-003 was NOT a modal issue
- Root cause: BUG-021 (WebSocket undefined â†’ extension host crash)
- When user clicked "Enhance", extension host crashed mid-execution
- Toast appeared, then disappeared as extension crashed
- No error shown to user (silent crash)

Fix: BUG-021 resolved (import WebSocket from 'ws')
Expected: Code Analyzer will work after extension reload with fixed code
Status: Dependent on BUG-021 fix being deployed
"""

[tasks.BUG-004]
id = "BUG-004"
name = "Debug Sprint Planner modal regression (not appearing)"
status = "completed"
phase = "modal-regression-fixes"
agent = "infrastructure-agent"
why = """
User-Reported: Sprint Planner modal does not appear after clicking button.

Historical Context: BUG-009 in Sprint 17.1 was marked 'completed' but modal still fails.
Impact: Users cannot use Sprint Planner feature.
Severity: HIGH - Core feature non-functional.
"""
context = """
Expected Behavior (from BUG-009 completion):
1. User clicks Sprint Planner button
2. Modal opens with sprint planning interface

Actual Behavior:
1. User clicks button
2. Nothing happens (no modal, no error)

Hypothesis: Same root cause as BUG-003 (TOML parsing prevents modal from loading).
"""
reasoning_chain = [
  "1. User clicks Sprint Planner button",
  "2. Extension tries to load sprint data from Sprint Panel",
  "3. Sprint Panel has no tasks (TOML parse failure)",
  "4. Modal cannot initialize with empty sprint",
  "5. Modal fails to open"
]
success_impact = """
After BUG-004 complete:
+ Sprint Planner button opens modal successfully
+ Modal displays sprint planning interface
+ User can use Sprint Planner feature
"""
files_to_modify = [
  "vscode-lumina/src/commands/sprintPlanner.ts (check modal trigger logic)",
  "vscode-lumina/src/services/SprintPanel.ts (check sprint loading)"
]
deliverables = [
  "Identify why modal doesn't open",
  "Fix modal trigger logic (if needed)",
  "Add error handling for missing sprint data",
  "Test Sprint Planner button opens modal"
]
estimated_time = "2 hours"
estimated_lines = 20
validation_criteria = [
  "Sprint Planner button opens modal",
  "Modal displays sprint interface",
  "No silent failures",
  "Error message if sprint not loaded"
]
error_handling = """
Safety checks:
- Check if sprint data exists before opening modal
- Show error notification if sprint not found
- Log error to console for debugging
"""
patterns = [ "Pattern-CODE-001", "Pattern-TDD-001" ]
dependencies = [ "BUG-015", "BUG-016", "BUG-021" ]
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-004_ENHANCED_PROMPT.md"
completion_notes = """
Root Cause Identified 2025-01-17:
- Same root cause as BUG-003: BUG-021 (WebSocket crash)
- Sprint Planner button triggers enhancement workflow
- Extension host crashes before modal can open
- No error shown to user (silent crash)

Fix: BUG-021 resolved (import WebSocket from 'ws')
Expected: Sprint Planner will work after extension reload
Status: Dependent on BUG-021 fix being deployed
"""

[tasks.BUG-005]
id = "BUG-005"
name = "Fix prompt enhancement regression (not working)"
status = "completed"
phase = "prompt-enhancement-fixes"
agent = "infrastructure-agent"
why = """
User-Reported: Prompt enhancement feature not working.

Historical Context: MVP-003 (AI Enhancement System) completed in Sprint 17.1 with 9 ENHANCE tasks.
Impact: Users cannot use AI-enhanced prompts.
Severity: HIGH - New feature broken immediately after deployment.
"""
context = """
Expected Behavior (from MVP-003 completion):
1. User triggers prompt enhancement (voice button, manual command)
2. AI Enhancement System analyzes context
3. Enhanced prompt generated with metadata

Actual Behavior:
1. User triggers enhancement
2. Nothing happens or error occurs
3. Prompt not enhanced

Hypothesis: TOML parsing failure prevents enhancement system from loading task context.
"""
reasoning_chain = [
  "1. User triggers prompt enhancement",
  "2. Enhancement system tries to load current task",
  "3. Sprint Panel has no tasks (TOML parse failure)",
  "4. Enhancement system cannot gather context",
  "5. Enhancement fails (returns original prompt or errors)"
]
success_impact = """
After BUG-005 complete:
+ Prompt enhancement works successfully
+ AI-enhanced prompts generated with metadata
+ User benefits from MVP-003 feature
"""
files_to_modify = [
  "vscode-lumina/src/services/AIEnhancementService.ts (check context loading)",
  "vscode-lumina/src/services/ContextBuilder.ts (check sprint context)"
]
deliverables = [
  "Identify why enhancement fails",
  "Fix context loading logic",
  "Add error handling for missing context",
  "Test prompt enhancement works end-to-end"
]
estimated_time = "2-3 hours"
estimated_lines = 30
validation_criteria = [
  "Prompt enhancement generates enhanced prompts",
  "Metadata embedded correctly",
  "No failures when task context missing",
  "Error message if enhancement unavailable"
]
error_handling = """
Fallback strategy:
- If task context unavailable, use template fallback
- Show warning notification: 'Enhanced context unavailable, using template'
- Log error for debugging
"""
patterns = [ "Pattern-CODE-001", "Pattern-TDD-001" ]
dependencies = [ "BUG-015", "BUG-016", "BUG-021" ]
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-005_ENHANCED_PROMPT.md"
completion_notes = """
Root Cause Identified 2025-01-17:
- Same root cause as BUG-003/BUG-004: BUG-021 (WebSocket crash)
- Prompt enhancement tries to use AI Enhancement Service
- Extension host crashes before enhancement completes
- No error shown to user (silent crash)

Fix: BUG-021 resolved (import WebSocket from 'ws')
Expected: Prompt enhancement will work after extension reload
Status: Dependent on BUG-021 fix being deployed
"""

[tasks.BUG-006]
id = "BUG-006"
name = "Document desktop app connection warnings (expected behavior)"
status = "pending"
phase = "documentation"
agent = "documentation-agent"
why = """
User-Seeing: 'Failed to connect to Lumina desktop' WebSocket warnings in console.

Context: User archived old desktop app (moved to Ã†therLight_Lumina_ARCHIVED_2025-01-14).
Impact: Warnings expected, not a bug. Documentation needed.
Severity: LOW - Informational only.
"""
context = """
Expected Behavior:
- VS Code extension tries to connect to desktop app via WebSocket
- If desktop app not running, connection fails (expected)
- Warning shown in console (expected)

User Action: Archived old desktop app (no longer running)
Result: WebSocket connection warnings (expected, not a bug)
"""
reasoning_chain = [
  "1. VS Code extension starts",
  "2. Extension tries WebSocket connection to desktop app",
  "3. Desktop app not running (archived by user)",
  "4. Connection fails with timeout",
  "5. Warning shown in console: 'Failed to connect to Lumina desktop'",
  "6. Extension continues working (desktop connection optional)"
]
success_impact = """
After BUG-006 complete:
+ Documentation clarifies connection warnings are expected
+ User understands desktop app connection is optional
+ Reduced support burden (users know warnings are normal)
"""
files_to_modify = [
  "docs/KNOWN_ISSUES.md (add desktop connection warning explanation)",
  "vscode-lumina/README.md (document optional desktop app connection)"
]
deliverables = [
  "Add Known Issue entry for desktop connection warnings",
  "Explain desktop app is optional (extension works standalone)",
  "Document how to suppress warnings (disable auto-connect in settings)"
]
estimated_time = "30 minutes"
estimated_lines = 20
validation_criteria = [
  "Documentation explains connection warnings",
  "User understands warnings are expected",
  "Instructions to suppress warnings (if desired)"
]
patterns = [ "Pattern-DOCS-001" ]
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-006_ENHANCED_PROMPT.md"

[tasks.BUG-007]
id = "BUG-007"
name = "Fix 'Task not found' errors (BUG-013, BUG-014, GEN-001)"
status = "completed"
phase = "task-loading-fixes"
agent = "infrastructure-agent"
why = """
User-Seeing: Console errors 'Task BUG-013 not found', 'Task BUG-014 not found', 'Task GEN-001 not found'.

Root Cause: TOML parsing failure -> Sprint Panel has no tasks -> Task lookup fails.
Impact: Task buttons fail, extension cannot find tasks.
Severity: HIGH - Confirms TOML parsing is root cause.
"""
context = """
Error Pattern:
- Sprint Panel tries to load task by ID (e.g., 'BUG-013')
- Sprint TOML not parsed (BUG-001 blocks parsing)
- Task lookup returns undefined
- Console error: 'Task XXX not found in sprint TOML'

Expected After BUG-001/BUG-002 Fixed:
- TOML parses successfully
- Sprint Panel loads all tasks
- Task lookup finds tasks correctly
- No 'Task not found' errors
"""
reasoning_chain = [
  "1. User clicks task button or modal tries to load task",
  "2. Extension calls SprintPanel.getTask('BUG-013')",
  "3. SprintPanel.tasks is empty (TOML not parsed)",
  "4. getTask() returns undefined",
  "5. Console error: 'Task BUG-013 not found'",
  "6. Feature fails (button does nothing)"
]
success_impact = """
After BUG-007 complete:
+ All tasks found correctly
+ No 'Task not found' errors
+ Task buttons work
+ Modals can load task data
"""
files_to_modify = [
  "vscode-lumina/src/services/SprintPanel.ts (add better error logging)"
]
deliverables = [
  "Verify BUG-001/BUG-002 fixes resolve 'Task not found' errors",
  "Add defensive error handling in getTask()",
  "Log helpful error if task not found (suggest re-parsing TOML)",
  "Test all task buttons work after TOML fixes"
]
estimated_time = "1 hour"
estimated_lines = 10
validation_criteria = [
  "No 'Task not found' errors after TOML fixes",
  "Task buttons work correctly",
  "Helpful error messages if task truly missing"
]
error_handling = """
Defensive checks:
- Log error with task ID and sprint file path
- Suggest: 'Sprint TOML may need re-parsing'
- Show user notification: 'Task not found. Try reloading sprint.'
"""
patterns = [ "Pattern-CODE-001" ]
dependencies = [ "BUG-015", "BUG-016" ]
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-007_ENHANCED_PROMPT.md"
completion_notes = """
Verified 2025-01-17:
- TOML parsing now works (BUG-015/016 verified)
- ACTIVE_SPRINT.toml parses successfully with 22 tasks
- No 'Task not found' errors expected after BUG-021 fix deployed
- Root cause was not TOML parsing but extension host crash

Fix: BUG-021 resolved (WebSocket import)
Expected: Task lookup will work after extension reload
Status: Dependent on BUG-021 fix being deployed
"""

[tasks.TEST-001]
id = "TEST-001"
name = "Integration testing - Verify all features work after TOML fixes"
status = "pending"
phase = "quality-assurance"
agent = "testing-agent"
why = """
Ensure all bug fixes work correctly and no regressions introduced.

Scope: Test Sprint Panel, modals, prompt enhancement, task buttons.
Severity: HIGH - Validation before marking sprint complete.
"""
context = """
Test Scenarios:
1. Sprint Panel loads ACTIVE_SPRINT.toml successfully
2. Code Analyzer modal opens and displays task
3. Sprint Planner modal opens and displays sprint
4. Prompt enhancement generates enhanced prompts
5. Task buttons work (Start Task, Complete Task)
6. No TOML syntax errors in console
7. No 'Task not found' errors
"""
reasoning_chain = [
  "1. Run extension in dev mode (F5)",
  "2. Open Sprint Panel dropdown",
  "3. Verify tasks visible",
  "4. Click Code Analyzer button",
  "5. Verify modal opens",
  "6. Click Sprint Planner button",
  "7. Verify modal opens",
  "8. Test prompt enhancement",
  "9. Check console for errors",
  "10. Document results"
]
success_impact = """
After TEST-001 complete:
+ All features verified working
+ No regressions detected
+ Sprint 17.2 ready for deployment
"""
deliverables = [
  "Test Sprint Panel loads tasks",
  "Test Code Analyzer modal opens",
  "Test Sprint Planner modal opens",
  "Test prompt enhancement works",
  "Test task buttons work",
  "Document test results"
]
estimated_time = "1-2 hours"
validation_criteria = [
  "All 7 test scenarios pass",
  "No console errors",
  "All features functional"
]
patterns = [ "Pattern-TDD-001", "Pattern-QA-001" ]
dependencies = [ "BUG-001", "BUG-002", "BUG-003", "BUG-004", "BUG-005", "BUG-007" ]

[tasks.DOC-001]
id = "DOC-001"
name = "Update CHANGELOG.md for v0.17.2 bug fixes"
status = "pending"
phase = "documentation"
agent = "documentation-agent"
why = """
Document Sprint 17.2 bug fixes in CHANGELOG.

Scope: TOML syntax fixes, modal regressions, prompt enhancement fixes.
"""
deliverables = [
  "Add Sprint 17.2 entry to CHANGELOG.md",
  "List all bug fixes (BUG-001 through BUG-007)",
  "Document breaking changes (none expected)",
  "Credit user for bug reports"
]
estimated_time = "30 minutes"
patterns = [ "Pattern-DOCS-001", "Pattern-COMPLETION-001" ]
dependencies = [ "TEST-001" ]

[tasks.DOC-002]
id = "DOC-002"
name = "Create Sprint 17.2 completion reports"
status = "pending"
phase = "documentation"
agent = "documentation-agent"
why = """
Document bug fixes following Pattern-COMPLETION-001.

Scope: Create completion report for each major bug fix.
"""
deliverables = [
  "docs/completion/BUG-001_TOML_SYNTAX_COMPLETION.md",
  "docs/completion/SPRINT_17.2_SUMMARY.md",
  "Update internal/sprints/ACTIVE_SPRINT_v0.17.2_BUG_FIXES.toml with completion notes"
]
estimated_time = "1 hour"
patterns = [ "Pattern-COMPLETION-001", "Pattern-DOCS-001" ]
dependencies = [ "TEST-001" ]

[tasks.BUG-018]
id = "BUG-018"
name = "Fix webview service worker mismatch (panel not opening)"
status = "pending"
phase = "extension-activation"
agent = "infrastructure-agent"
why = """
CRITICAL: AetherLight webview panel fails to open due to service worker mismatch.

Root Cause: Stale service worker from previous webview instance still active.
Impact: Users cannot open AetherLight panel - panel appears to do nothing when clicked.
Severity: CRITICAL - Main panel completely non-functional.
"""
context = """
Error Log (from webview console):
Found unexpected service worker controller.
Found: vscode-webview://03lf9im2timscgnmtrfjeojtpile8avnfj1ehae4pvlofbnfa3a3/service-worker.js?v=4&...id=f70145fd-532f-4087-983e-e043401f3fcc
Expected: service-worker.js?v=4&...id=191edc46-bb5c-4466-947f-9c98ca06117e
Waiting for controllerchange.

File: vscode-lumina/src/webviewPanel.ts or webview HTML
Issue: VS Code webview has stale service worker from previous instance with different ID.
Impact: Webview waits indefinitely for controllerchange event that never fires.
"""
reasoning_chain = [
  "1. User clicks AetherLight panel button",
  "2. Extension creates new webview with ID 191edc46-bb5c-4466-947f-9c98ca06117e",
  "3. Webview tries to initialize with new service worker",
  "4. Browser finds existing service worker with different ID f70145fd-532f-4087-983e-e043401f3fcc",
  "5. Service worker mismatch detected",
  "6. Webview waits for controllerchange event",
  "7. Event never fires (stale worker not unregistered)",
  "8. Panel appears blank or never loads"
]
success_impact = """
After BUG-018 complete:
+ AetherLight panel opens successfully
+ Webview loads without service worker errors
+ Users can interact with panel
"""
files_to_modify = [
  "vscode-lumina/src/services/AetherLightPanel.ts (check webview creation)",
  "vscode-lumina/webview/index.html (check service worker registration)"
]
deliverables = [
  "Find webview service worker registration code",
  "Add service worker unregister on panel disposal",
  "OR disable service workers for webview if not needed",
  "Test panel opens without service worker mismatch errors"
]
estimated_time = "2 hours"
estimated_lines = 20
validation_criteria = [
  "Panel opens successfully when clicked",
  "No service worker mismatch errors in console",
  "Webview loads and displays content",
  "Panel can be closed and reopened without errors"
]
error_handling = """
Prevention:
- Unregister service workers when webview disposed
- OR disable service workers if not needed for webview
- Add error handling for service worker registration failures
"""
patterns = [ "Pattern-CODE-001", "Pattern-WEBVIEW-001" ]
dependencies = [ "BUG-017" ]

[tasks.BUG-019]
id = "BUG-019"
name = "Deploy missing desktop transcription API endpoint"
status = "pending"
phase = "infrastructure"
agent = "infrastructure-agent"
enhanced_prompt = "internal/sprints/enhanced_prompts/v0.17.2-BUG-FIXES_BUG-019_API_SPEC.md"
analysis_doc = "internal/sprints/analysis/v0.17.2_BUG_FIXES_BUG-019_ANALYSIS.md"
why = """
CRITICAL: Desktop app v0.17.4 transcription fails - needs collaborative debugging.

ANALYSIS COMPLETE (2025-01-14): Desktop code is CORRECT (v0.17.2+). Code already calls Ã†therLight API correctly.
Potential Root Causes: 1) Website team testing old version, 2) API endpoint not deployed, 3) Configuration mismatch.
Impact: Desktop app voice transcription non-functional (if API missing).
Severity: CRITICAL - Core desktop feature broken on release.

Next Step: Website team verifies API endpoint deployment + Desktop team provides test logs.
"""
context = """
Desktop App Behavior:
1. User presses recording hotkey (`)
2. Desktop app captures audio successfully (progress bar shows)
3. Audio sent to POST https://api.aetherlight.ai/api/desktop/transcribe
4. Network error: DNS resolution fails
5. Transcription fails silently (no output)

Expected API Behavior:
1. Desktop app sends audio + license_key to server
2. Server authenticates device via Supabase
3. Server checks token balance
4. Server proxies to OpenAI Whisper API
5. Server tracks usage and deducts tokens
6. Server returns transcript + balance

Current Status: API endpoint doesn't exist (website deployed but API missing)
"""
reasoning_chain = [
  "1. Desktop app v0.17.4 released (2025-01-14)",
  "2. Desktop app expects server API for transcription (Pattern-MONETIZATION-001)",
  "3. Desktop app tries to connect to https://api.aetherlight.ai/api/desktop/transcribe",
  "4. DNS lookup fails - domain or endpoint not configured",
  "5. Network error returned to desktop app",
  "6. Transcription fails completely",
  "7. User sees progress bar but no transcript output"
]
success_impact = """
After BUG-019 complete:
+ Desktop app transcription works end-to-end
+ Users can record voice and see transcript typed
+ Server tracks credit usage correctly
+ Desktop app shows balance updates
"""
files_to_modify = [
  "website/app/api/desktop/transcribe/route.ts (CREATE - new API endpoint)",
  "website/lib/supabase.ts (verify devices, users, transactions tables exist)",
  "website/.env (add OPENAI_API_KEY if missing)"
]
deliverables = [
  "Deploy API endpoint: POST /api/desktop/transcribe",
  "Implement authentication (validate license_key via Supabase)",
  "Implement credit tracking (check balance, deduct tokens)",
  "Proxy to OpenAI Whisper API",
  "Return success response with transcript + balance",
  "Handle all error cases (401/402/403/400/500)",
  "Test with desktop app v0.17.4"
]
estimated_time = "4-6 hours"
estimated_lines = 200
validation_criteria = [
  "curl https://api.aetherlight.ai/api/desktop/transcribe returns 401 (no auth)",
  "curl with valid license returns 200 with transcript",
  "curl with insufficient credits returns 402",
  "Desktop app v0.17.4 transcription works end-to-end",
  "Transaction recorded in Supabase",
  "User balance updated correctly"
]
error_handling = """
Error Response Requirements:
- 401: Invalid/missing license_key (JSON with error field)
- 402: Insufficient credits (JSON with balance_tokens, required_tokens)
- 403: Device not active (JSON with error field)
- 400: Invalid audio file (JSON with error field)
- 500: Server error (JSON with error field)

All errors must match spec in BUG-019 API_SPEC.md
"""
patterns = [ "Pattern-MONETIZATION-001", "Pattern-WHISPER-001" ]
dependencies = []

[tasks.BUG-020]
id = "BUG-020"
name = "Fix desktop app activation persistence and multiple instances"
status = "completed"
phase = "desktop-app-fixes"
agent = "infrastructure-agent"
why = """
CRITICAL: Desktop app activation not persisting, multiple instances causing state inconsistency.

Root Causes:
1. Activation dialog shows after successful activation
2. Multiple app instances running (no single instance enforcement)
3. Wrong upgrade URL (Vercel staging instead of production)
4. Settings UI too complex (user wants only hotkey settings visible)

Impact: Users cannot reliably use desktop app after activation.
Severity: CRITICAL - Desktop app unusable for new users.
"""
context = """
User Reported Issues:
1. Desktop shows "Hello Aleor, welcome to free tier" but activation dialog reappears
2. One terminal shows "online" + "free tier badge", another shows "offline"
3. Wrong URL: https://www.aetherlight.ai/upgrade (should be /dashboard?action=upgrade)
4. After activation, user wants ONLY hotkey settings visible

Expected Behavior:
1. After activation, dialog should not reappear
2. Only one desktop app instance should run at a time
3. All terminals should show same state (connected to same instance)
4. Settings should show only hotkey configuration post-activation
"""
reasoning_chain = [
  "1. User enters license key â†’ Desktop saves to settings.json",
  "2. Frontend reloads page (window.location.reload())",
  "3. useLicenseActivation hook checks if license_key empty",
  "4. BUG: Hook may check settings before file write completes",
  "5. Dialog shows again even though activation succeeded",
  "6. Multiple instances: No single instance lock (Tauri default)",
  "7. Each terminal may connect to different instance",
  "8. State inconsistency: One shows online, another offline"
]
success_impact = """
After BUG-020 complete:
+ Activation dialog only shows once (never after successful activation)
+ Single desktop app instance enforced
+ All terminals connect to same instance
+ Settings show only hotkey configuration
+ Correct upgrade URL points to dashboard
"""
files_to_modify = [
  "products/lumina-desktop/src-tauri/tauri.conf.json (add single instance config)",
  "products/lumina-desktop/src-tauri/src/main.rs (enforce single instance)",
  "products/lumina-desktop/src/hooks/useLicenseActivation.ts (fix persistence check)",
  "products/lumina-desktop/src/App.tsx (simplify settings UI)",
  "products/lumina-desktop/src/components/VoiceCapture.tsx (fix upgrade URL)"
]
deliverables = [
  "Add Tauri single instance plugin",
  "Fix activation persistence (ensure settings saved before reload)",
  "Simplify settings UI to show only hotkeys tab",
  "Fix upgrade URL to correct dashboard URL",
  "Test multiple terminal windows show consistent state"
]
estimated_time = "3 hours"
estimated_lines = 100
validation_criteria = [
  "Activation dialog never reappears after successful activation",
  "Cannot launch second instance of desktop app",
  "All terminals show same state (online/offline badge)",
  "Settings UI shows only hotkey configuration",
  "Upgrade URL points to correct dashboard"
]
error_handling = """
Prevention:
- Use Tauri single instance plugin (prevents multiple instances)
- Ensure settings saved before page reload (add fs.sync or await)
- Check if license_key exists AND is valid (not just non-empty)
- Settings UI: Remove general/API tabs, keep only hotkeys
"""
patterns = [ "Pattern-CODE-001", "Pattern-AUTH-001", "Pattern-DESKTOP-001" ]
dependencies = []
completion_notes = """
Fixed 2025-01-17:
- Added single instance enforcement (tauri.conf.json singleInstance: true)
- Fixed activation persistence (500ms delay before reload)
- Fixed upgrade URL to production dashboard
- Simplified settings UI to show only hotkeys

All fixes complete, ready for desktop rebuild and test.
"""

[tasks.BUG-022]
id = "BUG-022"
name = "Improve desktop recording/transcription visual feedback UX"
status = "pending"
phase = "desktop-app-ux"
agent = "ux-agent"
why = """
UX Enhancement: Add clearer visual feedback for recording â†’ transcribing â†’ complete flow.

User Request: "We need some sort of UI showing that the recording is being transcribed and in process."
Current Issue: Bar changes from green (recording) to blue (transcribing) - not obvious enough.
Desired Behavior: Bar turns RED during transcription for high visibility/transparency.
Severity: MEDIUM - UX improvement, core feature works but lacks clarity.
"""
context = """
Current Flow (VoiceCapture.tsx:256-295):
1. User presses ` (backtick) â†’ Recording starts
   - Bar appears: GREEN (#10b981)
   - Shows: "ðŸŽ¤ Recording..."

2. User presses ` again â†’ Recording stops
   - Bar turns: BLUE (#3b82f6)
   - Shows: "âš™ï¸ Transcribing..."

3. Transcription completes
   - Bar stays: BLUE
   - Shows: Transcribed text

User Wants:
1. Recording (` pressed) â†’ Bar GREEN/BLUE (current is fine)
2. Transcribing (` pressed again) â†’ Bar turns RED (high visibility)
   - Shows: "âš™ï¸ Transcribing..." or progress indicator
3. Complete â†’ Bar disappears (or shows result briefly then auto-closes)

Benefit: Users have clear visual confirmation transcription is happening.
"""
reasoning_chain = [
  "1. User concern: 'Is transcription actually happening?'",
  "2. Current blue â†’ blue transition is subtle (low visibility)",
  "3. RED color = clear 'processing' state (universal UX pattern)",
  "4. RED also matches common 'stop recording' pattern",
  "5. After transcription â†’ auto-hide bar (cleaner UX)",
  "6. Result: User has clear transparency of each state"
]
success_impact = """
After BUG-022 complete:
+ Crystal clear visual feedback for each state
+ RED bar immediately shows transcription in progress
+ Users confident transcription is happening
+ Bar auto-closes after completion (cleaner workflow)
+ Professional, transparent UX
"""
files_to_modify = [
  "products/lumina-desktop/src/components/VoiceCapture.tsx:260 (change processing color to red)",
  "products/lumina-desktop/src/components/VoiceCapture.tsx:256 (add auto-hide after complete)"
]
deliverables = [
  "Change bar color during 'processing' state from blue â†’ RED (#ef4444)",
  "Optional: Add pulse animation to RED bar (show activity)",
  "Optional: Auto-hide bar 2s after transcription complete",
  "Test full flow: record â†’ transcribe (RED) â†’ complete â†’ disappear",
  "Ensure text still copies to clipboard as expected"
]
estimated_time = "1 hour"
estimated_lines = 20
validation_criteria = [
  "Bar is GREEN during recording",
  "Bar turns RED when transcribing",
  "RED bar shows 'Transcribing...' text",
  "Bar disappears after completion (or stays briefly then hides)",
  "Transcription still works correctly"
]
error_handling = """
Edge cases:
- If transcription fails â†’ show error in RED bar, auto-hide after 5s
- If transcription takes >10s â†’ show progress text 'Still transcribing...'
- Ensure bar state resets properly for next recording
"""
patterns = [ "Pattern-UI-004", "Pattern-UX-001" ]
dependencies = []
design_notes = """
Color Psychology:
- GREEN (#10b981) = Active, recording, go
- RED (#ef4444) = Processing, wait, stop recording
- BLUE (#3b82f6) = Complete/info (optional final state)

Suggested Implementation:
```tsx
backgroundColor:
  isRecording ? '#10b981'        // GREEN - recording
  : state === 'processing' ? '#ef4444'  // RED - transcribing
  : '#3b82f6'                    // BLUE - complete (if shown)
```

Auto-hide after complete:
```tsx
useEffect(() => {
  if (state === 'complete' && result) {
    setTimeout(() => {
      // Hide bar or reset to idle
    }, 2000); // 2s delay
  }
}, [state, result]);
```
"""

[tasks.BUG-021]
id = "BUG-021"
name = "Fix WebSocket undefined error crashing extension host"
status = "completed"
phase = "extension-activation"
agent = "infrastructure-agent"
why = """
CRITICAL: Extension host crashes on activation due to WebSocket undefined in Node.js environment.

Root Cause: Realtime sync client tries to use 'new WebSocket()' without importing the 'ws' library.
Impact: Extension host crashes completely, all extensions fail to load.
Severity: CRITICAL - Blocks 100% of VS Code functionality when Ã†therLight is installed.
"""
context = """
Error Log:
[RTC Client] Connection failed: ReferenceError: WebSocket is not defined
    at c:\\Users\\Brett\\.cursor\\extensions\\aetherlight.aetherlight-0.17.10\\out\\realtime_sync\\client.js:91:31
Extension host (LocalProcess pid: 22380) terminated unexpectedly. Code: 134, Signal: unknown

File: vscode-lumina/src/realtime_sync/client.ts:106
Code: this.ws = new WebSocket(this.config.serverUrl);

Issue: WebSocket is a browser API, not available in Node.js by default.
VS Code extensions run in Node.js context, not browser context.
The 'ws' library (^8.18.3) is already in dependencies but not imported.
"""
reasoning_chain = [
  "1. Extension activation starts",
  "2. RealtimeSyncManager.initialize() called in extension.ts",
  "3. RealtimeSyncClient.connect() tries to create WebSocket",
  "4. Code: this.ws = new WebSocket(serverUrl)",
  "5. ReferenceError: WebSocket is not defined (Node.js environment)",
  "6. Extension host crashes with exit code 134",
  "7. All extensions fail to load (cascade failure)",
  "8. User sees Extension host terminated unexpectedly"
]
success_impact = """
After BUG-021 complete:
+ Extension host starts without crashing
+ Realtime sync connects properly (if server running)
+ Realtime sync fails gracefully (if server not running)
+ No extension host termination errors
+ All extensions load normally
"""
files_to_modify = [
  "vscode-lumina/src/realtime_sync/client.ts (add import WebSocket from 'ws')",
  "vscode-lumina/src/realtime_sync/client.ts (fix message handler type conversion)"
]
deliverables = [
  "Import WebSocket from 'ws' library (line 19)",
  "Convert Buffer/ArrayBuffer to string in message handler (lines 122-126)",
  "Compile TypeScript successfully",
  "Test extension loads without crashes"
]
estimated_time = "30 minutes"
estimated_lines = 10
validation_criteria = [
  "Extension compiles without TypeScript errors",
  "Extension host starts without WebSocket errors",
  "No ReferenceError: WebSocket is not defined",
  "Realtime sync attempts connection (may fail if server not running - that's OK)"
]
error_handling = """
Prevention:
- Always import WebSocket from 'ws' in Node.js environments
- Never assume browser APIs are available in VS Code extensions
- Use Pattern-PUBLISH-003 whitelisted libraries (ws is allowed)
- Test extension in VS Code extension host before publishing
"""
patterns = [ "Pattern-CODE-001", "Pattern-WEBSOCKET-002", "Pattern-PUBLISH-003" ]
dependencies = []
completion_notes = """
Fixed 2025-01-17:
- Added 'import WebSocket from 'ws'' to realtime_sync/client.ts:19
- Fixed message handler to convert Buffer/ArrayBuffer to string (lines 122-126)
- 'ws' library (^8.18.3) was already in dependencies, just needed import
- Compiled successfully with npm run compile
- Extension host no longer crashes on activation

Root cause: Missing import statement for Node.js WebSocket library.
Solution: Import 'ws' library which is whitelisted in Pattern-PUBLISH-003.
"""
