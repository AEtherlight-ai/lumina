# INFRA-003: Implement Automated Task Document Linking Enforcement System

**Sprint**: 17.1-BUGS (Desktop Authentication & Installation Bugs)
**Task ID**: INFRA-003
**Status**: pending
**Phase**: documentation-infrastructure
**Agent**: infrastructure-agent
**Template**: MVP-003-PromptEnhancer-TaskTemplate-v1.4.3
**Pattern Reference**: Pattern-DOCS-002-TaskDocumentLinking.md (v1.1 - COMPLETE)
**Date Created**: 2025-01-13

---

## Executive Summary

**Problem**: Task documents (enhanced prompts, questions, test plans) can become orphaned or unlinked, making them hard to discover and maintain. Manual linking is error-prone (BUG-012 initially forgotten).

**Solution**: Implement 100% automated enforcement with validation script + pre-commit hook + migration script for sprint-aware naming.

**Key Innovation**: Sprint-aware naming (`{SPRINT_ID}_{TASK_ID}_{TYPE}.md`) prevents collisions when multiple sprints have same task IDs.

**Estimated Time**: 4-5 hours
**Estimated Lines**: 450 (validation 250 + migration 150 + hook installer 50)

---

## Step 0: Pre-Task Analysis (Pattern-TASK-ANALYSIS-001)

### 0.1 Problem Statement

**Current State**:
```
Agent creates: BUG-012_ENHANCED_PROMPT.md
Agent forgets: Add enhanced_prompt field to TOML
Result: Document orphaned (exists but not linked)
Discovery: Weeks later, can't find by searching TOML
Impact: Lost documentation, inconsistent organization
```

**Evidence of Problem**:
- ‚ùå BUG-012 initially created without TOML link (caught manually)
- ‚ùå No validation script exists
- ‚ùå No pre-commit hook
- ‚ùå 100% reliance on human diligence
- ‚ùå Old naming convention causes collisions (Sprint 3 BUG-001 vs Sprint 17.1 BUG-001)

**Desired State**:
```
Agent creates: 17.1-BUGS_BUG-012_ENHANCED_PROMPT.md
Pre-commit hook: Validates naming + TOML link
If missing: Blocks commit with clear error message
If valid: Commit succeeds
Result: 100% enforcement, zero orphaned documents
```

### 0.2 Sprint-Aware Naming Convention (v1.1)

**Format**: `{SPRINT_ID}_{TASK_ID}_{TYPE}.md`

**Sprint ID Extraction**:
```
TOML Filename ‚Üí Sprint ID
ACTIVE_SPRINT_17.1_BUGS.toml ‚Üí 17.1-BUGS
ACTIVE_SPRINT_3.toml ‚Üí 3
ACTIVE_SPRINT_4_KEYS.toml ‚Üí 4-KEYS
```

**Examples**:
```
17.1-BUGS_BUG-011_ENHANCED_PROMPT.md  (Sprint 17.1, enhanced prompt)
17.1-BUGS_BUG-011_QUESTIONS.md        (Sprint 17.1, questions doc)
3_PROTECT-001_TEST_PLAN.md            (Sprint 3, test plan)
4-KEYS_KEY-002_DESIGN.md              (Sprint 4, design doc)
```

**Why Sprint ID?**
- ‚úÖ Prevents collisions (Sprint 3 BUG-001 vs Sprint 17.1 BUG-001)
- ‚úÖ Clear ownership (sprint context in filename)
- ‚úÖ Validation can check sprint ID matches task owner
- ‚úÖ Searchable (`ls internal/sprints/*/17.1-BUGS_BUG-*`)

### 0.3 Current State Analysis

**Existing Files** (need migration):
```
internal/sprints/enhanced_prompts/
‚îú‚îÄ‚îÄ BUG-002_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-002A_ENHANCED_PROMPT.md        ‚Üí Needs rename to 17.1-BUGS_BUG-002A_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-002A.1_ENHANCED_PROMPT.md      ‚Üí Needs rename to 17.1-BUGS_BUG-002A.1_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-003_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-003_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-004_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-004_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-005_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-005_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-006_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-006_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-007_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-007_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-008_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-008_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-009_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-009_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-010_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-010_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-011_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-011_ENHANCED_PROMPT.md
‚îú‚îÄ‚îÄ BUG-012_ENHANCED_PROMPT.md         ‚Üí Needs rename to 17.1-BUGS_BUG-012_ENHANCED_PROMPT.md
‚îî‚îÄ‚îÄ 17.1-BUGS_BUG-013_ENHANCED_PROMPT.md  ‚úÖ Already correct

internal/sprints/questions/
‚îî‚îÄ‚îÄ BUG-011_QUESTIONS.md               ‚Üí Needs rename to 17.1-BUGS_BUG-011_QUESTIONS.md
```

**Total Files to Migrate**: 13 enhanced prompts + 1 questions doc = 14 files

### 0.4 Architecture Overview

**Three-Layer Enforcement**:

**Layer 1: Naming Convention**
```
Format: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
Validation: Regex /^([A-Z0-9.-]+)_([A-Z]+-\d+[A-Z]?)_([A-Z_]+)\.md$/
Sprint ID: Extract from TOML filename
```

**Layer 2: TOML Linking**
```toml
[tasks.BUG-011]
id = "BUG-011"
enhanced_prompt = "internal/sprints/enhanced_prompts/17.1-BUGS_BUG-011_ENHANCED_PROMPT.md"
questions_doc = "internal/sprints/questions/17.1-BUGS_BUG-011_QUESTIONS.md"
```

**Layer 3: Pre-Commit Hook**
```bash
#!/bin/bash
node scripts/validate-task-docs.js
if [ $? -ne 0 ]; then
  echo "‚ùå Task document validation failed!"
  exit 1
fi
```

### 0.5 Implementation Plan

**Phase 1: Validation Script** (2 hours, 250 lines)
- Parse all sprint TOML files
- Extract sprint ID from filename
- Find all task documents in filesystem
- Validate naming convention
- Validate TOML links
- Detect sprint ID mismatches
- Report errors with fix instructions

**Phase 2: Migration Script** (1 hour, 150 lines)
- Find all existing task documents
- Determine owning sprint from TOML
- Rename files with sprint ID prefix
- Update TOML references
- Dry-run mode for preview

**Phase 3: Hook Installer** (30 minutes, 50 lines)
- Create pre-commit hook script
- Install to .git/hooks/pre-commit
- Make executable (chmod +x)
- Test hook blocks bad commits

**Phase 4: Migration Execution** (30 minutes)
- Run migration script (dry-run first)
- Review changes
- Execute migration
- Validate all files renamed correctly
- Commit migration

**Phase 5: Testing & Documentation** (1 hour)
- Test validation script with intentional errors
- Test pre-commit hook blocks bad commits
- Update CLAUDE.md with new process
- Add npm scripts to package.json

### 0.6 Success Criteria

**Functional**:
- ‚úÖ Validation script runs successfully
- ‚úÖ Pre-commit hook blocks commits with orphaned docs
- ‚úÖ Pre-commit hook blocks commits with broken links
- ‚úÖ Pre-commit hook blocks commits with sprint ID mismatches
- ‚úÖ All 14 existing documents migrated to sprint-aware naming
- ‚úÖ All TOML references updated to new paths
- ‚úÖ npm run validate-docs shows 0 errors

**Testing**:
- ‚úÖ Create orphaned doc ‚Üí hook blocks commit ‚úÖ
- ‚úÖ Break TOML link ‚Üí hook blocks commit ‚úÖ
- ‚úÖ Wrong sprint ID in filename ‚Üí hook blocks commit ‚úÖ
- ‚úÖ Valid doc + TOML link ‚Üí hook allows commit ‚úÖ

**Documentation**:
- ‚úÖ Pattern-DOCS-002 exists (COMPLETE - 6,500+ lines)
- ‚úÖ CLAUDE.md updated with new process
- ‚úÖ npm scripts added (validate-docs, install-hooks, migrate-docs)

### 0.7 Risks & Mitigation

**Risk 1**: Migration script renames wrong files
- **Severity**: HIGH
- **Mitigation**: Dry-run mode shows preview first
- **Recovery**: Git can undo renames (git reset --hard)

**Risk 2**: TOML references broken after migration
- **Severity**: MEDIUM
- **Mitigation**: Validation script verifies all links after migration
- **Recovery**: Re-run migration with correct paths

**Risk 3**: Pre-commit hook too strict (blocks valid commits)
- **Severity**: LOW
- **Mitigation**: Clear error messages show exactly what's wrong
- **Recovery**: User can fix issues or use --no-verify (emergency only)

**Risk 4**: Performance impact (large TOML files)
- **Severity**: LOW
- **Mitigation**: Validation script < 1 second for current codebase
- **Recovery**: Optimize validation if needed (caching, incremental)

### 0.8 Dependencies & Prerequisites

**Dependencies**:
- ‚úÖ Pattern-DOCS-002 exists (COMPLETE v1.1 with sprint-aware naming)
- ‚úÖ Node.js ‚â• 18.0.0 installed
- ‚úÖ @iarna/toml package installed (already in dependencies)

**Prerequisites**:
- ‚úÖ Git repository initialized
- ‚úÖ Sprint TOML files exist (ACTIVE_SPRINT_17.1_BUGS.toml, etc.)
- ‚úÖ Task documents exist (14 files to migrate)
- ‚úÖ Write access to .git/hooks/ directory

**No Blockers**: Ready to proceed

---

## Step 1: Workflow Protocol Check (Pattern-CODE-001)

### Git Status Check (Pattern-GIT-001)

**STOP**: Before making ANY changes, run git status and announce results OUT LOUD.

```bash
git status
git diff
```

**Expected State**:
- ‚úÖ Clean working directory OR
- ‚úÖ Uncommitted BUG-013 enhanced prompt (acceptable)
- ‚úÖ Current branch: feature/v0.17.2-bug-fixes

**If uncommitted changes exist**: Consider committing them first before proceeding.

### Workflow Announcement

**I AM ABOUT TO**:
1. Create validation script: `scripts/validate-task-docs.js` (250 lines)
2. Create migration script: `scripts/migrate-task-docs.js` (150 lines)
3. Create hook installer: `scripts/install-hooks.js` (50 lines)
4. Install pre-commit hook: `.git/hooks/pre-commit` (20 lines)
5. Migrate 14 existing documents to sprint-aware naming
6. Update package.json with npm scripts
7. Update CLAUDE.md with new process

**Pattern-CODE-001 Checklist**:
- ‚úÖ Pre-task analysis complete (Step 0)
- ‚úÖ Git status checked (above)
- ‚úÖ Architecture designed (three-layer enforcement)
- ‚úÖ Test plan defined (4 tests minimum)
- ‚úÖ Pattern-DOCS-002 reference available
- ‚úÖ Ready to proceed

---

## Step 2: Create Validation Script

### 2.1 Script Architecture

**File**: `scripts/validate-task-docs.js`
**Purpose**: Find orphaned documents, broken links, sprint ID mismatches
**Estimated Lines**: 250

**Key Functions**:
1. `validateTaskDocs()` - Main validation function
2. `extractSprintId(filename)` - Extract sprint ID from TOML filename
3. `validateNaming(filename)` - Check naming convention
4. `validateLinks(tasks, docs)` - Check TOML links exist
5. `reportErrors(errors, warnings)` - Format error output

### 2.2 Implementation

**Create File**: `scripts/validate-task-docs.js`

```javascript
/**
 * Task Document Validation Script (Pattern-DOCS-002 v1.1)
 *
 * Validates that all task-related documents are:
 * 1. Named correctly ({SPRINT_ID}_{TASK_ID}_{TYPE}.md)
 * 2. Linked in sprint TOML files
 * 3. Actually exist on filesystem
 * 4. Sprint ID in filename matches task owner
 *
 * Usage:
 *   node scripts/validate-task-docs.js           # Validate only
 *   node scripts/validate-task-docs.js --fix     # Auto-fix missing links (future)
 */

const fs = require('fs');
const path = require('path');
const toml = require('@iarna/toml');

// Configuration
const SPRINTS_DIR = 'internal/sprints';
const DOC_TYPES = {
  'enhanced_prompts': 'enhanced_prompt',
  'questions': 'questions_doc',
  'test_plans': 'test_plan',
  'design': 'design_doc',
  'retrospectives': 'retrospective',
  'notes': 'notes'
};

const REQUIRED_FIELDS = ['enhanced_prompt']; // All tasks MUST have enhanced_prompt

/**
 * Extract sprint ID from TOML filename
 * Example: ACTIVE_SPRINT_17.1_BUGS.toml ‚Üí 17.1-BUGS
 */
function extractSprintId(filename) {
  const match = filename.match(/^ACTIVE_SPRINT_(.+)\.toml$/);
  if (!match) return 'UNKNOWN';

  // Replace underscores with hyphens: 17.1_BUGS ‚Üí 17.1-BUGS
  return match[1].replace(/_/g, '-');
}

/**
 * Parse filename: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
 * Returns: { sprintId, taskId, docType } or null if invalid
 */
function parseFilename(filename) {
  // Skip templates
  if (filename.includes('TEMPLATE') || filename.includes('MVP-')) {
    return null;
  }

  const match = filename.match(/^([A-Z0-9.-]+)_([A-Z]+-\d+[A-Z]?)_([A-Z_]+)\.md$/);

  if (!match) {
    return { invalid: true, filename };
  }

  const [, sprintId, taskId, docType] = match;
  return { sprintId, taskId, docType };
}

/**
 * Main validation function
 */
async function validateTaskDocs() {
  console.log('üîç Validating task document links...\n');

  const errors = [];
  const warnings = [];

  // Step 1: Find all sprint TOML files
  const sprintFiles = fs.readdirSync(SPRINTS_DIR)
    .filter(f => f.startsWith('ACTIVE_SPRINT') && f.endsWith('.toml'));

  console.log(`Found ${sprintFiles.length} sprint files\n`);

  // Step 2: Parse each sprint file and collect task IDs
  const allTasks = new Map(); // taskId -> { sprint, sprintId, task }

  for (const sprintFile of sprintFiles) {
    const sprintId = extractSprintId(sprintFile);
    const sprintPath = path.join(SPRINTS_DIR, sprintFile);
    const content = fs.readFileSync(sprintPath, 'utf-8');

    let data;
    try {
      data = toml.parse(content);
    } catch (error) {
      errors.push(`Failed to parse ${sprintFile}: ${error.message}`);
      continue;
    }

    if (!data.tasks) {
      warnings.push(`No tasks found in ${sprintFile}`);
      continue;
    }

    for (const [taskId, task] of Object.entries(data.tasks)) {
      allTasks.set(taskId, { sprint: sprintFile, sprintId, task });
    }
  }

  console.log(`Found ${allTasks.size} tasks\n`);

  // Step 3: Find all task documents in filesystem
  const allDocs = new Map(); // filePath -> { sprintId, taskId, type, docType }

  for (const [dirName, tomlField] of Object.entries(DOC_TYPES)) {
    const dirPath = path.join(SPRINTS_DIR, dirName);

    if (!fs.existsSync(dirPath)) {
      warnings.push(`Directory not found: ${dirPath}`);
      continue;
    }

    const files = fs.readdirSync(dirPath);

    for (const file of files) {
      const parsed = parseFilename(file);

      if (!parsed) {
        continue; // Skip templates
      }

      if (parsed.invalid) {
        warnings.push(
          `Invalid naming convention: ${dirName}/${file}\n` +
          `  Expected: {SPRINT_ID}_{TASK_ID}_{TYPE}.md\n` +
          `  Example: 17.1-BUGS_BUG-013_ENHANCED_PROMPT.md`
        );
        continue;
      }

      const filePath = path.join(dirName, file);
      allDocs.set(filePath, {
        sprintId: parsed.sprintId,
        taskId: parsed.taskId,
        type: tomlField,
        docType: parsed.docType
      });
    }
  }

  console.log(`Found ${allDocs.size} task documents\n`);

  // Step 4: Validate that all documents are linked in TOML
  for (const [filePath, { sprintId, taskId, type }] of allDocs) {
    const task = allTasks.get(taskId);

    if (!task) {
      errors.push(
        `Orphaned document: ${filePath}\n` +
        `  Task ${taskId} not found in any sprint TOML\n` +
        `  Fix: Add [tasks.${taskId}] to a sprint TOML file`
      );
      continue;
    }

    // Validate sprint ID matches
    if (sprintId !== task.sprintId) {
      errors.push(
        `Sprint ID mismatch: ${filePath}\n` +
        `  Document sprint: ${sprintId}\n` +
        `  Task belongs to: ${task.sprintId} (${task.sprint})\n` +
        `  Fix: Rename file to ${task.sprintId}_${taskId}_${type.toUpperCase()}.md`
      );
      continue;
    }

    const linkedPath = task.task[type];

    if (!linkedPath) {
      errors.push(
        `Missing TOML link: ${filePath}\n` +
        `  Task ${taskId} missing field: ${type}\n` +
        `  Fix: Add to ${task.sprint}:\n` +
        `    ${type} = "internal/sprints/${filePath}"`
      );
      continue;
    }

    const expectedPath = `internal/sprints/${filePath}`;
    if (linkedPath !== expectedPath) {
      errors.push(
        `Incorrect TOML link: ${taskId}.${type}\n` +
        `  Current: "${linkedPath}"\n` +
        `  Expected: "${expectedPath}"\n` +
        `  Fix: Update ${task.sprint}`
      );
    }
  }

  // Step 5: Validate that all TOML links point to existing files
  for (const [taskId, { sprint, sprintId, task }] of allTasks) {
    // Check required fields
    for (const requiredField of REQUIRED_FIELDS) {
      if (!task[requiredField]) {
        errors.push(
          `Missing required field: ${taskId}.${requiredField}\n` +
          `  File: ${sprint}\n` +
          `  Fix: Add ${requiredField} = "internal/sprints/enhanced_prompts/${sprintId}_${taskId}_ENHANCED_PROMPT.md"`
        );
      }
    }

    // Check all document links
    for (const [dirName, tomlField] of Object.entries(DOC_TYPES)) {
      const linkedPath = task[tomlField];

      if (!linkedPath) {
        continue; // Optional field
      }

      // Check if file exists
      if (!fs.existsSync(linkedPath)) {
        errors.push(
          `Broken link: ${taskId}.${tomlField}\n` +
          `  Path: "${linkedPath}"\n` +
          `  File not found\n` +
          `  Fix: Create file or remove link from ${sprint}`
        );
      }
    }
  }

  // Step 6: Report results
  console.log('‚îÅ'.repeat(60));
  console.log('\nüìä Validation Results:\n');

  if (errors.length === 0 && warnings.length === 0) {
    console.log('‚úÖ All checks passed!');
    console.log(`   - ${allTasks.size} tasks validated`);
    console.log(`   - ${allDocs.size} documents linked`);
    console.log(`   - 0 errors, 0 warnings`);
    return true;
  }

  if (warnings.length > 0) {
    console.log(`‚ö†Ô∏è  Warnings (${warnings.length}):\n`);
    warnings.forEach((w, i) => {
      console.log(`${i + 1}. ${w}`);
      console.log();
    });
  }

  if (errors.length > 0) {
    console.log(`‚ùå Errors (${errors.length}):\n`);
    errors.forEach((e, i) => {
      console.log(`${i + 1}. ${e}`);
      console.log();
    });
    console.log('Fix errors above before committing.');
    return false;
  }

  return true;
}

// Run validation
validateTaskDocs()
  .then(success => {
    process.exit(success ? 0 : 1);
  })
  .catch(err => {
    console.error('‚ùå Validation failed:', err);
    process.exit(1);
  });
```

### 2.3 Test Validation Script

**Run Script**:
```bash
node scripts/validate-task-docs.js
```

**Expected Output** (before migration):
```
üîç Validating task document links...

Found 1 sprint files

Found 13 tasks

Found 14 task documents

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Validation Results:

‚ö†Ô∏è  Warnings (13):

1. Invalid naming convention: enhanced_prompts/BUG-002_ENHANCED_PROMPT.md
  Expected: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
  Example: 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md

2. Invalid naming convention: enhanced_prompts/BUG-003_ENHANCED_PROMPT.md
  ...

‚ùå Errors (0):

(After migration, warnings will become 0)
```

---

## Step 3: Create Migration Script

### 3.1 Script Architecture

**File**: `scripts/migrate-task-docs.js`
**Purpose**: Rename existing documents to sprint-aware format + update TOML
**Estimated Lines**: 150

**Key Functions**:
1. `migrateTaskDocs(dryRun)` - Main migration function
2. `findDocumentOwner(taskId)` - Find which sprint owns task
3. `renameDocument(oldPath, newPath)` - Rename file
4. `updateTomlReference(sprintFile, taskId, field, newPath)` - Update TOML

### 3.2 Implementation

**Create File**: `scripts/migrate-task-docs.js`

```javascript
/**
 * Task Document Migration Script (Pattern-DOCS-002 v1.1)
 *
 * Migrates existing task documents to sprint-aware naming convention.
 *
 * Old: BUG-011_ENHANCED_PROMPT.md
 * New: 17.1-BUGS_BUG-011_ENHANCED_PROMPT.md
 *
 * Also updates all TOML references automatically.
 *
 * Usage:
 *   node scripts/migrate-task-docs.js --dry-run   # Preview changes
 *   node scripts/migrate-task-docs.js              # Execute migration
 */

const fs = require('fs');
const path = require('path');
const toml = require('@iarna/toml');

const SPRINTS_DIR = 'internal/sprints';
const DOC_TYPES = {
  'enhanced_prompts': 'enhanced_prompt',
  'questions': 'questions_doc',
  'test_plans': 'test_plan',
  'design': 'design_doc',
  'retrospectives': 'retrospective',
  'notes': 'notes'
};

const DRY_RUN = process.argv.includes('--dry-run');

/**
 * Extract sprint ID from TOML filename
 */
function extractSprintId(filename) {
  const match = filename.match(/^ACTIVE_SPRINT_(.+)\.toml$/);
  if (!match) return 'UNKNOWN';
  return match[1].replace(/_/g, '-');
}

/**
 * Parse old-style filename: {TASK_ID}_{TYPE}.md
 */
function parseOldFilename(filename) {
  if (filename.includes('TEMPLATE') || filename.includes('MVP-')) {
    return null;
  }

  const match = filename.match(/^([A-Z]+-\d+[A-Z.]*)_([A-Z_]+)\.md$/);
  if (!match) return null;

  const [, taskId, docType] = match;
  return { taskId, docType };
}

/**
 * Find which sprint owns a task
 */
function findTaskOwner(taskId, allTasks) {
  return allTasks.get(taskId);
}

/**
 * Update TOML file with new document path
 */
function updateTomlReference(sprintPath, taskId, field, oldPath, newPath) {
  const content = fs.readFileSync(sprintPath, 'utf-8');

  // Replace old path with new path
  const oldPathEscaped = oldPath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${field}\\s*=\\s*")${oldPathEscaped}(")`, 'g');
  const updatedContent = content.replace(regex, `$1${newPath}$2`);

  if (!DRY_RUN) {
    fs.writeFileSync(sprintPath, updatedContent, 'utf-8');
  }

  return updatedContent !== content;
}

/**
 * Main migration function
 */
async function migrateTaskDocs() {
  console.log(DRY_RUN ? 'üîç DRY RUN: Preview migration (no changes)\n' : 'üöÄ Migrating task documents to sprint-aware naming...\n');

  const changes = [];

  // Step 1: Load all sprint TOML files
  const sprintFiles = fs.readdirSync(SPRINTS_DIR)
    .filter(f => f.startsWith('ACTIVE_SPRINT') && f.endsWith('.toml'));

  const allTasks = new Map();

  for (const sprintFile of sprintFiles) {
    const sprintId = extractSprintId(sprintFile);
    const sprintPath = path.join(SPRINTS_DIR, sprintFile);
    const content = fs.readFileSync(sprintPath, 'utf-8');
    const data = toml.parse(content);

    if (!data.tasks) continue;

    for (const [taskId, task] of Object.entries(data.tasks)) {
      allTasks.set(taskId, { sprint: sprintFile, sprintId, sprintPath, task });
    }
  }

  console.log(`Found ${allTasks.size} tasks in ${sprintFiles.length} sprint files\n`);

  // Step 2: Find all old-format documents
  let filesRenamed = 0;
  let tomlUpdates = 0;

  for (const [dirName, tomlField] of Object.entries(DOC_TYPES)) {
    const dirPath = path.join(SPRINTS_DIR, dirName);
    if (!fs.existsSync(dirPath)) continue;

    const files = fs.readdirSync(dirPath);

    for (const file of files) {
      const parsed = parseOldFilename(file);
      if (!parsed) continue; // Skip templates or already migrated

      const { taskId, docType } = parsed;
      const owner = findTaskOwner(taskId, allTasks);

      if (!owner) {
        console.log(`‚ö†Ô∏è  Skipping ${file}: Task ${taskId} not found in any sprint`);
        continue;
      }

      // Generate new filename
      const newFilename = `${owner.sprintId}_${taskId}_${docType}.md`;
      const oldPath = path.join(dirPath, file);
      const newPath = path.join(dirPath, newFilename);

      // Check if already migrated
      if (file.includes(owner.sprintId)) {
        console.log(`‚úÖ Already migrated: ${file}`);
        continue;
      }

      // Rename file
      console.log(`üìù Renaming: ${file}`);
      console.log(`   ‚Üí ${newFilename}`);

      if (!DRY_RUN) {
        fs.renameSync(oldPath, newPath);
      }
      filesRenamed++;

      // Update TOML reference
      const oldTomlPath = `internal/sprints/${dirName}/${file}`;
      const newTomlPath = `internal/sprints/${dirName}/${newFilename}`;

      console.log(`   Updating TOML: [tasks.${taskId}].${tomlField}`);
      console.log(`   ${owner.sprint}`);

      const updated = updateTomlReference(
        owner.sprintPath,
        taskId,
        tomlField,
        oldTomlPath,
        newTomlPath
      );

      if (updated) {
        tomlUpdates++;
      }

      console.log();

      changes.push({
        taskId,
        oldFile: file,
        newFile: newFilename,
        sprint: owner.sprint
      });
    }
  }

  // Step 3: Summary
  console.log('‚îÅ'.repeat(60));
  console.log('\nüìä Migration Summary:\n');
  console.log(`Files renamed: ${filesRenamed}`);
  console.log(`TOML references updated: ${tomlUpdates}`);
  console.log(`Total changes: ${changes.length}`);

  if (DRY_RUN) {
    console.log('\n‚ö†Ô∏è  DRY RUN: No changes made. Run without --dry-run to execute migration.');
  } else {
    console.log('\n‚úÖ Migration complete!');
    console.log('\nNext steps:');
    console.log('1. Run validation: node scripts/validate-task-docs.js');
    console.log('2. Review changes: git status && git diff');
    console.log('3. Commit changes: git add . && git commit -m "docs: Migrate to sprint-aware naming (INFRA-003)"');
  }

  return changes.length;
}

// Run migration
migrateTaskDocs()
  .then(count => {
    process.exit(0);
  })
  .catch(err => {
    console.error('‚ùå Migration failed:', err);
    process.exit(1);
  });
```

### 3.3 Test Migration Script (Dry Run)

**Run Dry Run**:
```bash
node scripts/migrate-task-docs.js --dry-run
```

**Expected Output**:
```
üîç DRY RUN: Preview migration (no changes)

Found 13 tasks in 1 sprint files

üìù Renaming: BUG-002_ENHANCED_PROMPT.md
   ‚Üí 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
   Updating TOML: [tasks.BUG-002].enhanced_prompt
   ACTIVE_SPRINT_17.1_BUGS.toml

üìù Renaming: BUG-003_ENHANCED_PROMPT.md
   ‚Üí 17.1-BUGS_BUG-003_ENHANCED_PROMPT.md
   ...

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Migration Summary:

Files renamed: 13
TOML references updated: 13
Total changes: 13

‚ö†Ô∏è  DRY RUN: No changes made. Run without --dry-run to execute migration.
```

**Review Changes**: If output looks correct, proceed to execution in next step.

---

## Step 4: Create Hook Installer

### 4.1 Script Implementation

**Create File**: `scripts/install-hooks.js`

```javascript
/**
 * Install Git Hooks for Task Document Validation
 *
 * Usage: node scripts/install-hooks.js
 */

const fs = require('fs');
const path = require('path');

const PRE_COMMIT_HOOK = `#!/bin/bash
# Pre-commit hook: Validate task document links
# Generated by scripts/install-hooks.js (Pattern-DOCS-002)

echo "üîç Validating task document links..."
node scripts/validate-task-docs.js

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Task document validation failed!"
  echo "Fix errors above or use --no-verify to skip (NOT RECOMMENDED)"
  exit 1
fi

echo "‚úÖ Task document validation passed"
`;

const hookPath = path.join('.git', 'hooks', 'pre-commit');

// Check if .git directory exists
if (!fs.existsSync('.git')) {
  console.error('‚ùå Error: .git directory not found. Is this a git repository?');
  process.exit(1);
}

// Check if hooks directory exists
if (!fs.existsSync(path.join('.git', 'hooks'))) {
  fs.mkdirSync(path.join('.git', 'hooks'), { recursive: true });
}

// Write hook
fs.writeFileSync(hookPath, PRE_COMMIT_HOOK, { mode: 0o755 });

console.log('‚úÖ Pre-commit hook installed:', hookPath);
console.log('\nThe hook will run automatically before every commit.');
console.log('To bypass (emergency only): git commit --no-verify');
```

### 4.2 Install Hook

**Run Installer**:
```bash
node scripts/install-hooks.js
```

**Expected Output**:
```
‚úÖ Pre-commit hook installed: .git/hooks/pre-commit

The hook will run automatically before every commit.
To bypass (emergency only): git commit --no-verify
```

---

## Step 5: Execute Migration

### 5.1 Run Migration (Execute)

**IMPORTANT**: Dry-run completed successfully in Step 3.3. Now execute for real.

```bash
node scripts/migrate-task-docs.js
```

**Expected Output**:
```
üöÄ Migrating task documents to sprint-aware naming...

Found 13 tasks in 1 sprint files

üìù Renaming: BUG-002_ENHANCED_PROMPT.md
   ‚Üí 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
   Updating TOML: [tasks.BUG-002].enhanced_prompt
   ACTIVE_SPRINT_17.1_BUGS.toml

... (13 files renamed) ...

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Migration Summary:

Files renamed: 13
TOML references updated: 13
Total changes: 13

‚úÖ Migration complete!

Next steps:
1. Run validation: node scripts/validate-task-docs.js
2. Review changes: git status && git diff
3. Commit changes: git add . && git commit -m "docs: Migrate to sprint-aware naming (INFRA-003)"
```

### 5.2 Validate Migration

**Run Validation**:
```bash
node scripts/validate-task-docs.js
```

**Expected Output**:
```
üîç Validating task document links...

Found 1 sprint files

Found 13 tasks

Found 14 task documents

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Validation Results:

‚úÖ All checks passed!
   - 13 tasks validated
   - 14 documents linked
   - 0 errors, 0 warnings
```

**If Errors**: Fix them before proceeding. Review migration output and TOML updates.

### 5.3 Review Changes

**Git Status**:
```bash
git status
```

**Expected**:
```
Renamed:
  internal/sprints/enhanced_prompts/BUG-002_ENHANCED_PROMPT.md ‚Üí internal/sprints/enhanced_prompts/17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
  internal/sprints/enhanced_prompts/BUG-003_ENHANCED_PROMPT.md ‚Üí internal/sprints/enhanced_prompts/17.1-BUGS_BUG-003_ENHANCED_PROMPT.md
  ... (13 total renames)

Modified:
  internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml (TOML references updated)

New files:
  scripts/validate-task-docs.js
  scripts/migrate-task-docs.js
  scripts/install-hooks.js
```

**Git Diff TOML**:
```bash
git diff internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | head -50
```

**Expected**: See `enhanced_prompt` paths updated from old to new format.

---

## Step 6: Add npm Scripts

### 6.1 Update package.json

**File**: `package.json` (root)

**Add Scripts**:
```json
{
  "scripts": {
    "validate-docs": "node scripts/validate-task-docs.js",
    "migrate-docs": "node scripts/migrate-task-docs.js",
    "install-hooks": "node scripts/install-hooks.js",
    "test": "cd vscode-lumina && npm test",
    "compile": "cd vscode-lumina && npm run compile",
    "publish-release": "node scripts/publish-release.js"
  }
}
```

### 6.2 Test npm Scripts

**Test Validation**:
```bash
npm run validate-docs
```

**Expected**: ‚úÖ All checks passed (same as Step 5.2)

**Test Install Hooks** (already installed, should report success):
```bash
npm run install-hooks
```

---

## Step 7: Test Pre-Commit Hook

### 7.1 Test Hook Allows Valid Commits

**Create Test Commit**:
```bash
git add scripts/validate-task-docs.js
git commit -m "test: Validate hook allows valid commits"
```

**Expected Output**:
```
üîç Validating task document links...

Found 1 sprint files
Found 13 tasks
Found 14 task documents

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Validation Results:

‚úÖ All checks passed!
   - 13 tasks validated
   - 14 documents linked
   - 0 errors, 0 warnings

‚úÖ Task document validation passed

[feature/v0.17.2-bug-fixes abc1234] test: Validate hook allows valid commits
 1 file changed, 250 insertions(+)
```

**Result**: ‚úÖ Commit succeeded

### 7.2 Test Hook Blocks Orphaned Documents

**Create Orphaned Document**:
```bash
# Create document without TOML link
echo "# Test Orphaned Doc" > internal/sprints/enhanced_prompts/17.1-BUGS_TEST-999_ENHANCED_PROMPT.md

git add internal/sprints/enhanced_prompts/17.1-BUGS_TEST-999_ENHANCED_PROMPT.md
git commit -m "test: Should be blocked by hook"
```

**Expected Output**:
```
üîç Validating task document links...

Found 1 sprint files
Found 13 tasks
Found 15 task documents

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Validation Results:

‚ùå Errors (1):

1. Orphaned document: enhanced_prompts/17.1-BUGS_TEST-999_ENHANCED_PROMPT.md
  Task TEST-999 not found in any sprint TOML
  Fix: Add [tasks.TEST-999] to a sprint TOML file

Fix errors above before committing.

‚ùå Task document validation failed!
Fix errors above or use --no-verify to skip (NOT RECOMMENDED)
```

**Result**: ‚ùå Commit blocked (CORRECT!)

**Cleanup**:
```bash
rm internal/sprints/enhanced_prompts/17.1-BUGS_TEST-999_ENHANCED_PROMPT.md
git reset HEAD .
```

### 7.3 Test Hook Blocks Sprint ID Mismatches

**Create Document with Wrong Sprint ID**:
```bash
# Create document with wrong sprint ID (3 instead of 17.1-BUGS)
echo "# Test Sprint Mismatch" > internal/sprints/enhanced_prompts/3_BUG-002_ENHANCED_PROMPT.md

git add internal/sprints/enhanced_prompts/3_BUG-002_ENHANCED_PROMPT.md
git commit -m "test: Should be blocked by hook"
```

**Expected Output**:
```
‚ùå Errors (1):

1. Sprint ID mismatch: enhanced_prompts/3_BUG-002_ENHANCED_PROMPT.md
  Document sprint: 3
  Task belongs to: 17.1-BUGS (ACTIVE_SPRINT_17.1_BUGS.toml)
  Fix: Rename file to 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md

‚ùå Task document validation failed!
```

**Result**: ‚ùå Commit blocked (CORRECT!)

**Cleanup**:
```bash
rm internal/sprints/enhanced_prompts/3_BUG-002_ENHANCED_PROMPT.md
git reset HEAD .
```

---

## Step 8: Update Documentation

### 8.1 Update CLAUDE.md

**File**: `.claude/CLAUDE.md`

**Find Section**: "Before Using Edit/Write Tools"

**Add New Checklist Item**:

```markdown
### Before Using Edit/Write Tools:

**STOP. Answer these questions OUT LOUD in your response:**

1. ‚úÖ **Did I read the target file first?**
   - If NO ‚Üí Read it NOW with Read tool
   - Never edit a file you haven't read in this session

2. ‚úÖ **Did I verify the format/structure I'm following?**
   - If NO ‚Üí Read the parser/loader code that will read this file
   - Never guess the format

3. ‚úÖ **Am I following an existing pattern?**
   - If NO ‚Üí Search for similar code and copy the pattern
   - Never invent new patterns without user approval

4. ‚úÖ **Did I use sprint-aware naming for task documents?** (NEW)
   - Format: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
   - Example: 17.1-BUGS_BUG-013_ENHANCED_PROMPT.md
   - Sprint ID from TOML filename: ACTIVE_SPRINT_17.1_BUGS.toml ‚Üí 17.1-BUGS
   - See: Pattern-DOCS-002 for full details

5. ‚úÖ **Did I link the document in sprint TOML?** (NEW)
   - All enhanced prompts MUST have enhanced_prompt field
   - All questions docs MUST have questions_doc field
   - Pre-commit hook will block if missing
```

**Add to Enforcement Mechanism**:
```markdown
**Historical bugs caused by skipping this checklist:**
- **2025-11-03:** Used `[[epic.*.tasks]]` instead of `[tasks.ID]` ‚Üí Sprint panel broken (2 hours debugging)
- **2025-01-13:** Forgot to link BUG-012 enhanced prompt in TOML ‚Üí Document orphaned (caught manually)
- **Before INFRA-003:** No validation ‚Üí orphaned documents accumulating
```

### 8.2 Add to Project Overview

**File**: `.claude/CLAUDE.md`

**Find Section**: "Reference Documentation"

**Add Pattern-DOCS-002**:
```markdown
### Reference Documentation

- **[KNOWN_ISSUES.md](../docs/KNOWN_ISSUES.md)** - Historical bugs & fixes (15+ hours of debugging lessons)
- **[PUBLISHING.md](../PUBLISHING.md)** - Publishing guide
- **[SPRINT_TEMPLATE_GUIDE.md](../internal/SPRINT_TEMPLATE_GUIDE.md)** - Sprint template system guide (27 normalized tasks)
- **[Pattern-DOCS-002](../docs/patterns/Pattern-DOCS-002-TaskDocumentLinking.md)** - Task document linking & organization (NEW)
  - Sprint-aware naming convention
  - Automated validation with pre-commit hook
  - 100% enforcement (zero orphaned documents)
- **[Pattern Library Index](../docs/patterns/INDEX.md)** - All 76+ patterns
```

---

## Step 9: Final Validation & Commit

### 9.1 Run Final Validation

**Validate Everything**:
```bash
npm run validate-docs
```

**Expected**: ‚úÖ All checks passed, 0 errors, 0 warnings

### 9.2 Review All Changes

**Git Status**:
```bash
git status
```

**Expected Files**:
```
New files:
  scripts/validate-task-docs.js
  scripts/migrate-task-docs.js
  scripts/install-hooks.js
  internal/sprints/enhanced_prompts/17.1-BUGS_INFRA-003_ENHANCED_PROMPT.md

Renamed:
  internal/sprints/enhanced_prompts/BUG-002_ENHANCED_PROMPT.md ‚Üí 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
  ... (12 more renames)
  internal/sprints/questions/BUG-011_QUESTIONS.md ‚Üí 17.1-BUGS_BUG-011_QUESTIONS.md

Modified:
  internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml (TOML references + INFRA-003 status)
  package.json (npm scripts added)
  .claude/CLAUDE.md (documentation updated)

Untracked (git-ignored):
  .git/hooks/pre-commit (installed but not tracked)
```

### 9.3 Commit Changes

**Stage All Changes**:
```bash
git add scripts/validate-task-docs.js
git add scripts/migrate-task-docs.js
git add scripts/install-hooks.js
git add internal/sprints/enhanced_prompts/
git add internal/sprints/questions/
git add internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml
git add package.json
git add .claude/CLAUDE.md
```

**Commit**:
```bash
git commit -m "feat(docs): Implement automated task document linking enforcement (INFRA-003)

- Created validation script: scripts/validate-task-docs.js (250 lines)
  - Validates sprint-aware naming: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
  - Detects orphaned documents (not linked in TOML)
  - Detects broken links (TOML references non-existent files)
  - Detects sprint ID mismatches (document sprint != task owner)
  - Clear error messages with fix instructions

- Created migration script: scripts/migrate-task-docs.js (150 lines)
  - Migrated 13 enhanced prompts to sprint-aware naming
  - Migrated 1 questions document to sprint-aware naming
  - Updated all TOML references automatically
  - Dry-run mode for preview

- Installed pre-commit hook: .git/hooks/pre-commit
  - Blocks commits with orphaned docs
  - Blocks commits with broken links
  - Blocks commits with sprint ID mismatches
  - 100% enforcement (zero human error possible)

- Added npm scripts: validate-docs, migrate-docs, install-hooks
- Updated CLAUDE.md with new pre-flight checklist items
- Pattern reference: Pattern-DOCS-002 v1.1 (sprint-aware naming)

Benefits:
‚úÖ No collisions when multiple sprints have same task IDs
‚úÖ All task documents follow consistent naming convention
‚úÖ All task documents linked in sprint TOML
‚úÖ Discoverable by sprint + task ID
‚úÖ Zero orphaned documents possible

Testing:
‚úÖ Hook allows valid commits
‚úÖ Hook blocks orphaned documents
‚úÖ Hook blocks sprint ID mismatches
‚úÖ Validation passes with 0 errors

Closes INFRA-003
Estimated time: 4 hours (actual: ____)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**Pre-commit Hook Runs**:
```
üîç Validating task document links...
‚úÖ All checks passed!
‚úÖ Task document validation passed

[feature/v0.17.2-bug-fixes def5678] feat(docs): Implement automated task document linking enforcement (INFRA-003)
 18 files changed, 450 insertions(+), 13 deletions(-)
```

---

## Step 10: Mark Task Complete

### 10.1 Update Task Status

**File**: `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml`

**Update INFRA-003**:
```toml
[tasks.INFRA-003]
id = "INFRA-003"
name = "Implement automated task document linking enforcement system"
status = "completed"  # CHANGE FROM "pending"
phase = "documentation-infrastructure"
agent = "infrastructure-agent"
enhanced_prompt = "internal/sprints/enhanced_prompts/17.1-BUGS_INFRA-003_ENHANCED_PROMPT.md"  # ADD THIS
# ... rest unchanged
```

**Add Completion Notes**:
```toml
completion_notes = """
## Implementation Summary

Successfully implemented 100% automated enforcement system for task document linking with sprint-aware naming convention.

## Files Created

### 1. scripts/validate-task-docs.js (250 lines)
- Validates sprint-aware naming: {SPRINT_ID}_{TASK_ID}_{TYPE}.md
- Detects orphaned documents, broken links, sprint ID mismatches
- Clear error messages with fix instructions
- Runtime: < 1 second for current codebase

### 2. scripts/migrate-task-docs.js (150 lines)
- Migrated 13 enhanced prompts + 1 questions doc to sprint-aware naming
- Updated all TOML references automatically
- Dry-run mode for preview
- 100% success rate (0 errors)

### 3. scripts/install-hooks.js (50 lines)
- Installs pre-commit hook automatically
- Creates .git/hooks/pre-commit with validation
- Executable permissions set correctly

### 4. .git/hooks/pre-commit (20 lines)
- Runs validation script before every commit
- Blocks commits with errors (orphaned docs, broken links, sprint ID mismatches)
- Can bypass with --no-verify (emergency only)

## Migration Results

Files migrated: 14 total
- 13 enhanced prompts renamed
- 1 questions document renamed
- All TOML references updated
- Validation passes with 0 errors

## Testing Results

‚úÖ Validation script runs successfully
‚úÖ Pre-commit hook blocks orphaned documents
‚úÖ Pre-commit hook blocks sprint ID mismatches
‚úÖ Pre-commit hook allows valid commits
‚úÖ npm scripts work correctly
‚úÖ All 14 migrated documents validated

## Benefits Achieved

‚úÖ 100% enforcement (pre-commit hook blocks bad commits)
‚úÖ No collisions when multiple sprints have same task IDs
‚úÖ Sprint ID validation prevents wrong-sprint assignment
‚úÖ All task documents linked in sprint TOML
‚úÖ Zero orphaned documents possible
‚úÖ Discoverable by sprint + task ID
‚úÖ Clear error messages guide users to fixes

## Documentation Updated

- .claude/CLAUDE.md: Added pre-flight checklist items for sprint-aware naming
- package.json: Added npm scripts (validate-docs, migrate-docs, install-hooks)
- Pattern-DOCS-002 v1.1: Complete reference (6,500+ lines)

## Performance

- Validation time: < 1 second (14 documents, 1 sprint file)
- Hook overhead: < 1 second per commit
- No performance impact on development workflow

## Time Spent

Estimated: 4-5 hours
Actual: ____ hours
Breakdown:
- Validation script: ____ hours
- Migration script: ____ hours
- Hook installer: ____ hours
- Migration execution: ____ hours
- Testing: ____ hours
- Documentation: ____ hours
"""
```

### 10.2 Commit Status Update

```bash
git add internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml
git commit -m "chore: Mark INFRA-003 as completed

‚úÖ Automated task document linking enforcement system implemented
‚úÖ All 14 documents migrated to sprint-aware naming
‚úÖ Pre-commit hook installed and tested
‚úÖ Zero orphaned documents possible

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## Success Impact

### After INFRA-003 Complete:

**Organizational Benefits**:
- ‚úÖ 100% enforcement (pre-commit hook blocks bad commits)
- ‚úÖ All task documents follow sprint-aware naming convention
- ‚úÖ No collisions when multiple sprints have same task IDs
- ‚úÖ Sprint ID validation prevents wrong-sprint assignment
- ‚úÖ All task documents linked in sprint TOML
- ‚úÖ No orphaned documents possible
- ‚úÖ Validation script finds issues instantly
- ‚úÖ Clear error messages with fix instructions
- ‚úÖ Discoverable by sprint + task ID (ls internal/sprints/*/17.1-BUGS_BUG-013*)
- ‚úÖ TOML serves as single source of truth
- ‚úÖ Zero human error possible (automated)
- ‚úÖ Existing docs migrated to new naming format

**Developer Experience**:
- ‚úÖ Pre-commit hook catches issues before push
- ‚úÖ Clear error messages guide to fix
- ‚úÖ npm scripts for validation (npm run validate-docs)
- ‚úÖ Migration script for existing docs (npm run migrate-docs)
- ‚úÖ Hook installer for new clones (npm run install-hooks)

**System Health**:
- ‚úÖ Pattern-DOCS-002 v1.1 fully implemented
- ‚úÖ Zero technical debt accumulation (100% enforcement)
- ‚úÖ Consistent organization across all sprints
- ‚úÖ Future-proof (sprint-aware naming supports multiple active sprints)

---

## Troubleshooting Guide

### Issue: Validation Script Fails with TOML Parse Error

**Possible Cause**: Sprint TOML file has syntax error

**Solution**:
```bash
# Test TOML parsing
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml', 'utf-8'));"

# If error: Fix TOML syntax
# Then re-run validation
```

### Issue: Pre-Commit Hook Not Running

**Possible Cause 1**: Hook not executable

**Solution**:
```bash
chmod +x .git/hooks/pre-commit
```

**Possible Cause 2**: Hook not installed

**Solution**:
```bash
npm run install-hooks
```

**Possible Cause 3**: Git hooks disabled

**Solution**:
```bash
git config --get core.hooksPath
# If set to something other than .git/hooks:
git config --unset core.hooksPath
```

### Issue: Migration Script Renames Wrong Files

**Possible Cause**: Task not found in sprint TOML

**Solution**:
```bash
# Dry-run first to see what would be renamed
node scripts/migrate-task-docs.js --dry-run

# If incorrect, fix TOML first:
# 1. Ensure task exists in sprint TOML
# 2. Ensure task ID matches filename
# 3. Re-run dry-run
```

### Issue: Hook Blocks Valid Commit

**Possible Cause**: Document not linked in TOML

**Solution**:
```bash
# See what's wrong
npm run validate-docs

# Fix based on error message:
# - Add enhanced_prompt field to TOML
# - Or: Remove orphaned document
# Or: Rename document to match sprint ID
```

**Emergency Bypass** (NOT RECOMMENDED):
```bash
git commit --no-verify -m "message"
```

---

## Estimated Time Breakdown

**Total: 4-5 hours**

- Step 0: Pre-task analysis: 30 minutes ‚úÖ (done in enhanced prompt)
- Step 1: Workflow check: 5 minutes
- Step 2: Create validation script: 1.5 hours (250 lines, testing)
- Step 3: Create migration script: 1 hour (150 lines, dry-run testing)
- Step 4: Create hook installer: 20 minutes (50 lines)
- Step 5: Execute migration: 20 minutes (review, execute, validate)
- Step 6: Add npm scripts: 10 minutes
- Step 7: Test pre-commit hook: 20 minutes (3 tests)
- Step 8: Update documentation: 20 minutes (CLAUDE.md)
- Step 9: Final validation & commit: 10 minutes
- Step 10: Mark task complete: 5 minutes

**Actual Time Will Vary**: If tests pass immediately, could be done in 3-4 hours.

---

## Pattern-COMPLETION-001: Completion Notes

**MANDATORY: Fill this out BEFORE final commit**

### What Was Completed

**Files Created**:
```
1. scripts/validate-task-docs.js (250 lines)
   - Sprint-aware naming validation
   - Orphaned document detection
   - Broken link detection
   - Sprint ID mismatch detection

2. scripts/migrate-task-docs.js (150 lines)
   - Automatic file renaming
   - TOML reference updates
   - Dry-run mode

3. scripts/install-hooks.js (50 lines)
   - Pre-commit hook installer
   - Automatic permission setting

4. .git/hooks/pre-commit (20 lines)
   - Validation on every commit
   - Clear error messages

5. internal/sprints/enhanced_prompts/17.1-BUGS_INFRA-003_ENHANCED_PROMPT.md
   - This enhanced prompt document
```

**Files Modified**:
```
1. package.json
   - Added npm scripts: validate-docs, migrate-docs, install-hooks

2. .claude/CLAUDE.md
   - Added sprint-aware naming to pre-flight checklist
   - Added Pattern-DOCS-002 reference

3. internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml
   - Updated INFRA-003 status to completed
   - Added enhanced_prompt reference
   - Added completion notes
```

**Files Migrated** (13 + 1 = 14):
```
Renamed all old-format documents to sprint-aware format:
- BUG-002_ENHANCED_PROMPT.md ‚Üí 17.1-BUGS_BUG-002_ENHANCED_PROMPT.md
- BUG-003_ENHANCED_PROMPT.md ‚Üí 17.1-BUGS_BUG-003_ENHANCED_PROMPT.md
- ... (13 enhanced prompts total)
- BUG-011_QUESTIONS.md ‚Üí 17.1-BUGS_BUG-011_QUESTIONS.md
```

### Test Results

**Validation Script Tests**:
```
Test 1: Run validation on existing docs
Result: ‚úÖ PASS - 0 errors after migration

Test 2: Create orphaned document
Result: ‚úÖ PASS - Error detected, clear fix message

Test 3: Create broken TOML link
Result: ‚úÖ PASS - Error detected, clear fix message

Test 4: Create sprint ID mismatch
Result: ‚úÖ PASS - Error detected, clear fix message
```

**Pre-Commit Hook Tests**:
```
Test 1: Valid commit (validation passes)
Result: ‚úÖ PASS - Commit allowed

Test 2: Orphaned document commit
Result: ‚úÖ PASS - Commit blocked with clear error

Test 3: Sprint ID mismatch commit
Result: ‚úÖ PASS - Commit blocked with clear error
```

**Migration Script Tests**:
```
Test 1: Dry-run preview
Result: ‚úÖ PASS - Correct preview of 14 file renames

Test 2: Execute migration
Result: ‚úÖ PASS - 14 files renamed, 14 TOML references updated

Test 3: Validation after migration
Result: ‚úÖ PASS - 0 errors, 0 warnings
```

### Known Issues

**None** - All tests passed, 100% enforcement working.

### Time Spent

**Estimated**: 4-5 hours
**Actual**: [Fill in actual time]
**Variance**: [If > 6 hours, explain why]

**Breakdown**:
- Validation script: __ hours
- Migration script: __ hours
- Hook installer: __ hours
- Migration execution: __ hours
- Testing: __ hours
- Documentation: __ hours

### User Impact

**Before INFRA-003**:
- ‚ùå Manual linking (error-prone)
- ‚ùå Orphaned documents possible
- ‚ùå No collision prevention (Sprint 3 BUG-001 vs Sprint 17.1 BUG-001)
- ‚ùå Inconsistent organization
- ‚ùå Lost documentation

**After INFRA-003**:
- ‚úÖ 100% automated enforcement
- ‚úÖ Zero orphaned documents possible
- ‚úÖ No collisions (sprint-aware naming)
- ‚úÖ Consistent organization
- ‚úÖ All documents discoverable
- ‚úÖ Clear error messages guide fixes

**Net Result**: Organizational debt eliminated, future-proof system implemented.

---

**END OF ENHANCED PROMPT**

**Next Steps**:
1. Review this enhanced prompt with user if needed
2. Execute Steps 1-10 sequentially
3. Fill in Pattern-COMPLETION-001 notes before final commit
4. Mark INFRA-003 as completed in sprint TOML
5. Move to next task in sprint

**Estimated Total Time**: 4-5 hours (3 scripts + migration + testing + docs)
