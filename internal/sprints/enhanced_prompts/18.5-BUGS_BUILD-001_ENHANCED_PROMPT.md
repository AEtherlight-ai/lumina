# BUILD-001: Build Mac Desktop App Binaries (.dmg for Intel and Apple Silicon)

**Generated**: 2025-11-20
**Sprint**: 18.5 Bugs (Sprint 18.2_Sprint_2_Bugs)
**Task ID**: BUILD-001
**Phase**: phase_4_build
**Agent**: infrastructure-agent
**Priority**: Medium (Mac compatibility - Phase 2 of Mac support strategy)
**Template Version**: v1.4.3 (Breadcrumb-based architecture, adapted for build tasks)

---

## âš ï¸ MANDATORY: Pre-Task Analysis (Pattern-TASK-ANALYSIS-001)

**YOU MUST COMPLETE THIS SECTION BEFORE STARTING BUILD PROCESS.**

Answer these 8 questions OUT LOUD in your response:

### 1. Git Status Check
**Question**: What is the current git status? Are there uncommitted changes that might conflict?

**Action**: Run `git status` and `git diff` to check for uncommitted changes.

**Note**: This is a build task, not code changes. Git status check ensures clean working directory before build.

### 2. Task Understanding
**Question**: What is the EXACT problem BUILD-001 solves?

**Expected Answer**:
- **Problem**: Mac users cannot use voice capture features (no desktop app binaries exist)
- **Current State**: Only Windows desktop app binaries exist (.exe, .msi)
- **Impact**: Mac users limited to VS Code extension only, no voice transcription
- **Root Cause**: Mac desktop app has never been built or published
- **Solution**: Build Mac .dmg files for Intel (x64) and Apple Silicon (aarch64)
- **Context**: Part of Mac Support Strategy (Phase 2) - MAC-001 (terminal fix) completed in Phase 1

**User Experience Impact**:
```
BEFORE BUILD-001:
Mac user â†’ Installs Ã†therLight â†’ Voice features unavailable â†’ Desktop app missing

AFTER BUILD-001:
Mac user â†’ Installs Ã†therLight â†’ Downloads .dmg â†’ Installs desktop app â†’ Voice features work âœ…
```

### 3. Current State vs. Required State
**Question**: What is MISSING now, and what should exist after the build?

**Current State (Windows-only binaries)**:
```
GitHub Releases (v0.18.4, v0.18.2, v0.18.0, v0.17.12, v0.17.10):
âœ… Lumina_0.18.4_x64.exe          (Windows installer)
âœ… Lumina_0.18.4_x64.msi          (Windows MSI)
âŒ Lumina_0.18.4_x64.dmg          (Intel Mac - MISSING)
âŒ Lumina_0.18.4_aarch64.dmg      (Apple Silicon - MISSING)
```

**Required State (Cross-platform binaries)**:
```
GitHub Releases (v0.18.5 target):
âœ… Lumina_0.18.5_x64.exe          (Windows installer)
âœ… Lumina_0.18.5_x64.msi          (Windows MSI)
âœ… Lumina_0.18.5_x64.dmg          (Intel Mac - TO BUILD)
âœ… Lumina_0.18.5_aarch64.dmg      (Apple Silicon - TO BUILD)
```

**Desktop App Architecture**:
```
products/lumina-desktop/
â”œâ”€â”€ src/                  # Frontend (TypeScript + React)
â”œâ”€â”€ src-tauri/            # Backend (Rust)
â”‚   â”œâ”€â”€ tauri.conf.json   # Tauri configuration
â”‚   â”œâ”€â”€ Cargo.toml        # Rust dependencies
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ main.rs       # Rust backend code
â”œâ”€â”€ package.json          # Node.js dependencies
â””â”€â”€ target/               # Build outputs (after build)
    â””â”€â”€ release/
        â””â”€â”€ bundle/
            â””â”€â”€ dmg/      # â† .dmg files created here
```

### 4. Build Environment Requirements
**Question**: What tools and dependencies are needed to build Mac binaries?

**Expected Answer**:
```bash
# Build Environment Checklist (macOS required):
âœ… macOS machine (physical Mac or macOS VM/cloud runner)
âœ… Xcode Command Line Tools (xcode-select --install)
âœ… Rust toolchain (rustc, cargo)
âœ… Node.js >= 18.0.0
âœ… npm (comes with Node.js)
âœ… Tauri CLI

# Optional (for distribution):
âšª Apple Developer Account (for code signing)
âšª Code signing certificates (optional for first release)
âšª Notarization credentials (Apple's security requirement)
```

**Verification Commands**:
```bash
# Check macOS version
sw_vers

# Check Xcode CLI Tools
xcode-select -p

# Check Rust
rustc --version
cargo --version

# Check Node.js
node --version
npm --version

# Check Tauri CLI
cargo tauri --version
# OR
npm run tauri -- --version
```

### 5. Affected Files and Build Artifacts
**Question**: Which files are involved, and what artifacts will be created?

**Expected Answer**:

**Configuration Files (NO CHANGES NEEDED)**:
- `products/lumina-desktop/src-tauri/tauri.conf.json` (line 33: `"targets": "all"` - already configured)
- `products/lumina-desktop/package.json` (build scripts already defined)
- `products/lumina-desktop/src-tauri/Cargo.toml` (Rust dependencies already defined)

**Build Artifacts (TO BE CREATED)**:
- `products/lumina-desktop/target/release/bundle/dmg/Lumina_0.18.5_x64.dmg` (Intel Mac)
- `products/lumina-desktop/target/release/bundle/dmg/Lumina_0.18.5_aarch64.dmg` (Apple Silicon)

**Documentation Files (TO UPDATE)**:
- `PUBLISHING.md` (add Mac build steps)
- `products/lumina-desktop/MAC_BUILD_GUIDE.md` (create if doesn't exist)
- `.github/workflows/publish.yml` (add macOS build job if using CI)

### 6. Dependencies and Blockers
**Question**: What must be completed BEFORE starting, and what could block progress?

**Expected Dependencies**:
- âœ… MAC-001 completed (terminal fix for Mac compatibility)
- âšª Access to macOS build environment (user must provide or use CI)
- âšª Sufficient disk space (~5-10 GB for Rust toolchain + build artifacts)

**Potential Blockers**:
```
Blocker 1: No macOS machine available
â†’ Solution: Use GitHub Actions macOS runner (CI build)

Blocker 2: Rust/Tauri build failures
â†’ Solution: Check Tauri requirements (https://tauri.app/v1/guides/getting-started/prerequisites)

Blocker 3: Code signing errors (if attempting signed build)
â†’ Solution: Build unsigned .dmg first (users will see security warning but can install)

Blocker 4: Missing native dependencies (CoreAudio, WebKit)
â†’ Solution: Install Xcode Command Line Tools

Blocker 5: Build time too long (15+ minutes)
â†’ Solution: Use release build profile, enable caching
```

### 7. Testing Strategy
**Question**: How will we verify the build succeeded and works correctly?

**Expected Testing Approach**:

**Phase 1: Build Verification (immediate)**
```bash
# After build completes:
1. Check .dmg files exist in target/release/bundle/dmg/
2. Verify file sizes (should be 10-50 MB each)
3. Check architecture: file Lumina_0.18.5_x64.dmg
4. Check architecture: file Lumina_0.18.5_aarch64.dmg
```

**Phase 2: Installation Testing (manual)**
```bash
# On Intel Mac (or Apple Silicon with Rosetta):
1. Mount Lumina_0.18.5_x64.dmg
2. Drag Lumina.app to Applications
3. Launch app (Security warning: "Open anyway" in System Preferences)
4. Verify app launches without crash

# On Apple Silicon Mac:
1. Mount Lumina_0.18.5_aarch64.dmg
2. Drag Lumina.app to Applications
3. Launch app (native, no Rosetta)
4. Verify app launches without crash
```

**Phase 3: Functional Testing (critical paths)**
```bash
# After installation:
1. App window opens (UI renders)
2. Menu bar icon appears (system tray integration)
3. Microphone permission requested (CoreAudio access)
4. Voice capture works (record audio)
5. Whisper transcription works (API call succeeds)
6. IPC with VS Code extension works (desktop app detected)
```

**Success Criteria**:
- âœ… .dmg files build without errors
- âœ… .dmg files mount correctly on macOS
- âœ… App installs to /Applications/
- âœ… App launches without crash
- âœ… Voice capture functional
- âœ… Extension detects desktop app via IPC

### 8. Rollback Plan
**Question**: What is the rollback plan if the build fails or binaries are broken?

**Expected Rollback Strategy**:

**Scenario 1: Build fails (compilation errors)**
```bash
Action: Fix Rust/Tauri errors, retry build
Impact: No rollback needed (no artifacts created)
Timeline: Immediate retry after fixes
```

**Scenario 2: Binaries build but crash on launch**
```bash
Action: Don't publish .dmg files to GitHub release yet
Impact: Mac users continue without desktop app (extension-only)
Timeline: Debug locally, publish when fixed
```

**Scenario 3: Binaries published but users report issues**
```bash
Action: Remove .dmg files from GitHub release
Impact: Mac users install v0.18.4 or earlier (no voice features)
Timeline: Hotfix in next patch release (v0.18.6)
Notification: Update README with known issue
```

**Recovery Steps**:
```bash
# If build artifacts are corrupted:
1. Clean build directory: cargo clean (in src-tauri/)
2. Remove target/: rm -rf target/
3. Re-install Rust toolchain: rustup update
4. Retry build: npm run tauri build
```

---

## ðŸ“‹ Build Process (Step-by-Step)

### PHASE 1: Environment Setup (One-Time Setup)

**1.1 Verify macOS Build Environment**
```bash
# Check macOS version (10.14+ required)
sw_vers

# Expected output:
# ProductName: macOS
# ProductVersion: 14.x.x (or higher)
```

**1.2 Install Xcode Command Line Tools**
```bash
# Install if not present
xcode-select --install

# Verify installation
xcode-select -p
# Expected: /Library/Developer/CommandLineTools
```

**1.3 Install/Verify Rust Toolchain**
```bash
# Install Rust (if not present)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Or update existing installation
rustup update

# Verify Rust
rustc --version
# Expected: rustc 1.75.0 (or higher)

cargo --version
# Expected: cargo 1.75.0 (or higher)
```

**1.4 Install/Verify Node.js**
```bash
# Check Node.js version (18.0.0+ required)
node --version
# Expected: v18.x.x or v20.x.x

npm --version
# Expected: 9.x.x or 10.x.x
```

**1.5 Install Dependencies**
```bash
# Navigate to desktop app directory
cd products/lumina-desktop

# Install npm dependencies (frontend)
npm install

# Install Rust dependencies (backend - automatic during build)
# cargo build handles this automatically
```

### PHASE 2: Pre-Build Verification

**2.1 Check Configuration Files**
```bash
# Verify Tauri config includes macOS targets
cat src-tauri/tauri.conf.json | grep -A 5 "targets"

# Expected output:
# "targets": "all"  â† Builds for all platforms including macOS
```

**2.2 Clean Previous Build Artifacts**
```bash
# Remove old build artifacts (optional but recommended)
cd src-tauri
cargo clean
cd ..
```

**2.3 Verify Disk Space**
```bash
# Check available disk space (need ~5-10 GB)
df -h .

# Expected: At least 10 GB free
```

### PHASE 3: Build Execution

**3.1 Run Tauri Build (Release Mode)**
```bash
# From products/lumina-desktop/ directory
npm run tauri build

# This command:
# 1. Builds frontend (npm run build)
# 2. Compiles Rust backend (cargo build --release)
# 3. Bundles macOS .app
# 4. Creates .dmg installers

# Expected output (abbreviated):
# info: Finished release [optimized] target(s) in 8m 32s
# info: Bundling Lumina.app (...)
# info: Bundling dmg (Lumina_0.18.5_x64.dmg)
# info: Bundling dmg (Lumina_0.18.5_aarch64.dmg)
```

**Build Time Expectations**:
- **First build**: 10-15 minutes (downloads Rust crates, compiles dependencies)
- **Incremental build**: 2-5 minutes (only recompiles changed code)
- **Clean build**: 8-12 minutes (recompiles everything)

**3.2 Monitor Build Progress**
```bash
# Build process shows:
# [1/4] Compiling frontend (npm run build)
# [2/4] Compiling Rust backend (cargo build --release)
# [3/4] Bundling macOS application
# [4/4] Creating .dmg installers

# Watch for errors:
# - Rust compilation errors â†’ Check src-tauri/src/
# - Frontend build errors â†’ Check src/
# - Bundling errors â†’ Check Tauri configuration
```

### PHASE 4: Build Verification

**4.1 Verify Build Artifacts Created**
```bash
# List .dmg files in output directory
ls -lh target/release/bundle/dmg/

# Expected output:
# Lumina_0.18.5_x64.dmg          (Intel Mac, ~20-40 MB)
# Lumina_0.18.5_aarch64.dmg      (Apple Silicon, ~20-40 MB)
```

**4.2 Verify File Integrity**
```bash
# Check file type
file target/release/bundle/dmg/Lumina_0.18.5_x64.dmg
# Expected: Lumina_0.18.5_x64.dmg: Apple Driver Update, blocksize 512

# Check architecture
lipo -info target/release/bundle/dmg/Lumina_0.18.5_x64.dmg
# Intel: x86_64
```

**4.3 Verify .app Bundle**
```bash
# Check .app bundle structure
ls -la target/release/bundle/macos/Lumina.app/Contents/

# Expected directories:
# MacOS/       (Executable binary)
# Resources/   (Icons, assets)
# Info.plist   (App metadata)
```

### PHASE 5: Local Installation Testing

**5.1 Mount .dmg and Install**
```bash
# Mount the .dmg (opens Finder window)
open target/release/bundle/dmg/Lumina_0.18.5_x64.dmg

# Manually: Drag Lumina.app to Applications folder
# OR via command line:
cp -R /Volumes/Lumina/Lumina.app /Applications/

# Eject .dmg
hdiutil detach /Volumes/Lumina
```

**5.2 Launch App (Handle Security Warning)**
```bash
# First launch attempt (will be blocked by macOS Gatekeeper)
open /Applications/Lumina.app

# Expected: Security warning dialog
# "Lumina.app can't be opened because it is from an unidentified developer"

# Solution: Override security settings
# System Preferences â†’ Security & Privacy â†’ General â†’ "Open Anyway"

# OR via command line (remove quarantine flag):
xattr -d com.apple.quarantine /Applications/Lumina.app
open /Applications/Lumina.app
```

**5.3 Verify App Launches**
```bash
# Check app launches without crash
# Expected:
# - App window opens
# - Menu bar icon appears
# - No crash or immediate quit
```

### PHASE 6: Functional Testing (Critical Paths)

**6.1 Test Voice Capture**
```bash
# Manual test:
1. Grant microphone permission (macOS will prompt)
2. Click "Start Recording" in app
3. Speak into microphone
4. Stop recording
5. Verify audio captured (waveform visible)
```

**6.2 Test Whisper Transcription**
```bash
# Manual test:
1. Record audio (see 6.1)
2. App sends audio to Whisper API
3. Verify transcription appears
4. Check for API errors in console
```

**6.3 Test VS Code Extension Integration**
```bash
# Manual test:
1. Open VS Code with Ã†therLight extension installed
2. Desktop app should auto-detect (IPC connection)
3. Check extension status: "Desktop app connected âœ…"
4. Test voice-to-terminal feature
```

### PHASE 7: Prepare for Distribution

**7.1 Copy Artifacts to Release Directory**
```bash
# Create release artifacts directory
mkdir -p ../../release-artifacts/v0.18.5/

# Copy .dmg files
cp target/release/bundle/dmg/*.dmg ../../release-artifacts/v0.18.5/

# Verify copies
ls -lh ../../release-artifacts/v0.18.5/
```

**7.2 Generate Checksums (Optional but Recommended)**
```bash
# Create SHA256 checksums for verification
cd ../../release-artifacts/v0.18.5/
shasum -a 256 *.dmg > checksums.txt

# Example checksums.txt content:
# a1b2c3d4... Lumina_0.18.5_x64.dmg
# e5f6g7h8... Lumina_0.18.5_aarch64.dmg
```

**7.3 Update Documentation**
```bash
# Update PUBLISHING.md with Mac build steps
# Update CHANGELOG.md with v0.18.5 Mac binaries
# Create MAC_INSTALLATION_GUIDE.md for users
```

---

## ðŸš¨ Troubleshooting Common Build Errors

### Error 1: "xcrun: error: unable to find utility 'metal'"
```
Cause: Xcode Command Line Tools not installed or outdated
Solution:
  sudo rm -rf /Library/Developer/CommandLineTools
  xcode-select --install
  # Retry build after installation
```

### Error 2: "error: linker `cc` not found"
```
Cause: C compiler not in PATH
Solution:
  export PATH="/Library/Developer/CommandLineTools/usr/bin:$PATH"
  # Add to ~/.zshrc or ~/.bash_profile for persistence
```

### Error 3: "Failed to bundle project: error running bundle_dmg.sh"
```
Cause: Missing system dependencies for .dmg creation
Solution:
  # Install create-dmg tool
  brew install create-dmg
  # Retry build
```

### Error 4: "Cargo.lock is out of date"
```
Cause: Dependency version mismatch
Solution:
  cd src-tauri
  cargo update
  cd ..
  npm run tauri build
```

### Error 5: ".dmg created but app crashes on launch"
```
Cause: Missing runtime dependencies or incorrect code signing
Solution:
  1. Check Console.app for crash logs
  2. Verify all dylibs bundled correctly
  3. Try unsigned build first (user will see warning but can install)
```

### Error 6: "Build succeeds but .dmg files not created"
```
Cause: Tauri bundler configuration issue
Solution:
  1. Check src-tauri/tauri.conf.json â†’ bundle â†’ macOS settings
  2. Verify "targets": "all" or "dmg" is set
  3. Check build logs for "Skipping dmg bundling" messages
```

---

## ðŸ“Š Success Criteria Summary

**Build Phase**:
- [ ] Rust toolchain installed and verified
- [ ] Node.js dependencies installed successfully
- [ ] `npm run tauri build` completes without errors
- [ ] Build time < 15 minutes (first build) or < 5 minutes (incremental)

**Artifacts Phase**:
- [ ] `Lumina_0.18.5_x64.dmg` created in target/release/bundle/dmg/
- [ ] `Lumina_0.18.5_aarch64.dmg` created in target/release/bundle/dmg/
- [ ] File sizes reasonable (10-50 MB each)
- [ ] Checksums generated for verification

**Installation Phase**:
- [ ] .dmg mounts correctly on macOS
- [ ] Drag-to-Applications workflow works
- [ ] App launches without crash (after security override)
- [ ] Menu bar icon appears

**Functional Phase**:
- [ ] Microphone permission requested and granted
- [ ] Voice capture works (audio recorded)
- [ ] Whisper transcription works (API call succeeds)
- [ ] VS Code extension detects desktop app (IPC connection)

**Distribution Phase**:
- [ ] Artifacts copied to release directory
- [ ] Checksums generated and verified
- [ ] Documentation updated (PUBLISHING.md, CHANGELOG.md)
- [ ] Ready for GitHub release attachment

---

## ðŸ”— Related Documentation

- **Tauri Build Guide**: https://tauri.app/v1/guides/building/macos
- **Mac Setup Guide**: vscode-lumina/MAC_SETUP.md
- **Pattern-PUBLISH-001**: Automated release pipeline
- **Pattern-PUBLISH-004**: Pre-publish validation
- **Sprint 18.5**: ACTIVE_SPRINT_v0.18.5_BUGS.toml
- **Mac Compatibility Strategy**: Sprint 18.5 metadata (lines 47-53)

---

## ðŸŽ¯ Next Steps After BUILD-001 Completes

1. **Test on both Mac architectures** (Intel and Apple Silicon)
2. **Update PUB-004** (Generate release artifacts) with Mac .dmg files
3. **Update CHANGELOG.md** with Mac support announcement
4. **Create GitHub release v0.18.5** with all binaries (Windows + Mac)
5. **Update README.md** with Mac installation instructions
6. **Announce Mac support** to user community

---

**Remember**: This is a CRITICAL step for Mac feature parity. After BUILD-001, Mac users gain full voice capture functionality. Take your time, verify each build artifact, and test thoroughly before distribution.
