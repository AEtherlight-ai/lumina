# Enhanced Task Prompt: BUG-005

**Generated**: 2025-01-13
**Sprint**: Sprint 17.1 - Desktop Authentication Bug Fixes
**Task ID**: BUG-005
**Status**: pending
**Agent**: ui-agent
**Enhanced Prompt**: internal/sprints/enhanced_prompts/BUG-005_ENHANCED_PROMPT.md
**Template**: MVP-003-PromptEnhancer-TaskTemplate-v1.4.3

---

## ‚ö†Ô∏è MANDATORY: Pre-Task Analysis (Pattern-TASK-ANALYSIS-001)

**STOP. Before reading ANY code or writing ANY solution, complete this 8-step analysis OUT LOUD:**

### 8-Step Pre-Task Analysis

1. ‚úÖ **Understand the Problem**
   - What is broken? LicenseActivationDialog component exists (BUG-002) but is not integrated into App.tsx
   - What are the symptoms? Users cannot enter license key because dialog never shows

2. ‚úÖ **Identify Root Cause**
   - Why is it broken? BUG-002 created the component but explicitly deferred App.tsx integration
   - Is this a symptom of a deeper problem? No - intentional task decomposition (backend + component separate from integration)

3. ‚úÖ **Define Success Criteria**
   - How do I know when it's fixed? Dialog appears on first launch when license_key is empty
   - What does "done" look like? Users can activate license, dialog closes on success, app continues to main interface

4. ‚úÖ **List Dependencies**
   - What other tasks/files/systems does this affect? App.tsx first-run flow, settings management
   - What needs to be done first? BUG-002 (license activation backend + component) - COMPLETED ‚úÖ
   - What does this unblock? Full first-time user experience, license activation flow end-to-end

5. ‚úÖ **Estimate Complexity**
   - Simple fix (< 1 hour) or complex refactor (> 4 hours)? Medium complexity - 4-5 hours
   - Single file or multi-file change? Multi-file (App.tsx modify, useLicenseActivation.ts create, tests create)

6. ‚úÖ **Choose Approach**
   - What's the best way to solve this? Create React hook for license activation state, integrate dialog into App.tsx with event listeners
   - Are there alternative approaches? Could put all logic directly in App.tsx, but custom hook is better separation of concerns
   - Why is this one best? Hook is reusable, testable, keeps App.tsx clean

7. ‚úÖ **Identify Risks**
   - What could go wrong? Dialog could interfere with existing first-run wizard (InstallationWizard)
   - What could break? Existing first-run flow, settings loading
   - What are the edge cases? License_key exists but invalid, user closes dialog without activating, network errors during activation

8. ‚úÖ **Plan Testing**
   - How will I validate this works? Manual testing with empty license_key, test dialog shows/hides correctly
   - What tests need to be written? React Testing Library tests for dialog rendering, event handling, hook state management

### Code Workflow Announcement (Pattern-CODE-001)

**Before starting Step 1 (Implementation), announce OUT LOUD:**

"I am about to start coding for task BUG-005. I have completed:
‚úÖ Pattern-TASK-ANALYSIS-001 (8-step pre-task analysis - see above)
‚úÖ Ready to proceed with Pattern-GIT-001 (Git status check)
‚úÖ Ready to proceed with Pattern-TDD-001 (Write tests FIRST)
‚úÖ Ready to proceed with Pattern-TRACKING-001 (TodoWrite tracking)

I am now proceeding with implementation."

---

## Task Overview

**Name**: Create frontend license activation dialog

**Why**:

Missing UI: No frontend dialog for license activation.

Current State:
- Backend has activate_license() Tauri command (after BUG-002)
- LicenseActivationDialog component exists (created in BUG-002)
- Component NOT imported or used in App.tsx
- Users cannot enter license key

Expected State:
- Dialog integrated into App.tsx
- Dialog shows on first launch when license_key is empty
- Dialog listens for backend 'show-license-prompt' event
- Dialog closes after successful activation
- App continues to main interface after activation

Impact: Users cannot activate desktop app without UI integration.
Severity: HIGH - Required for first-run experience.

**Current State (BROKEN)**:
- File: `products/lumina-desktop/src/App.tsx:1-600`
- Issue: Does not import or render LicenseActivationDialog
- Issue: Has license_key in settings but doesn't check if empty
- Issue: No event listeners for backend activation events

**Required State (CORRECT)**:
- File: `products/lumina-desktop/src/App.tsx`
- Fix: Import LicenseActivationDialog, show when license_key is empty
- File: `products/lumina-desktop/src/hooks/useLicenseActivation.ts` (NEW)
- Fix: Create React hook for activation state management

**Impact**: Complete first-time user activation flow

**Severity**: HIGH

---

## Context Gathered

### Git Status
- **Branch**: feature/v0.17.2-bug-fixes
- **Status**: Clean (from conversation context)
- **Ready for**: BUG-005 implementation

### Sprint TOML
- **File**: `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml`
- **Task Entry**: Lines 1388-1499
- **Management**: Use `/sprint-task-lifecycle` skill (see Pattern-TRACKING-001)

### Related Files

1. `products/lumina-desktop/src/App.tsx:1-600` - Main app component (MUST UPDATE)
2. `products/lumina-desktop/src/hooks/useLicenseActivation.ts` - React hook for activation (MUST CREATE)
3. `products/lumina-desktop/src/components/LicenseActivationDialog.tsx:1-253` - Dialog component (REFERENCE ONLY - created in BUG-002)
4. `products/lumina-desktop/src-tauri/src/main.rs:757-799` - activate_license() Tauri command (REFERENCE ONLY)

### What BUG-002 Already Did (DO NOT DUPLICATE)

**Files Created by BUG-002**:
- ‚úÖ `auth.rs` (260 lines) - Backend validation logic
- ‚úÖ `LicenseActivationDialog.tsx` (240 lines) - React component
- ‚úÖ `activate_license()` Tauri command

**BUG-002 Commit Message** explicitly said:
```
## Next Steps (Not in This Commit)
- [ ] Integrate LicenseActivationDialog into App.tsx
- [ ] Manual testing with live API
```

**This task (BUG-005) does the integration that BUG-002 deferred.**

### Patterns Referenced
- **Pattern-TASK-ANALYSIS-001**: 8-step pre-task analysis (MANDATORY)
- **Pattern-CODE-001**: Code workflow + announcement (MANDATORY)
- **Pattern-TRACKING-001**: Task tracking + Sprint TOML lifecycle
- **Pattern-GIT-001**: Git workflow integration
- **Pattern-TDD-001**: Test-driven development
- **Pattern-VALIDATION-001**: Pre-flight checklist enforcement
- **Pattern-COMPLETION-001**: Post-completion documentation (Step N-2)
- **Pattern-UI-006**: React component integration patterns

---

## Pre-Flight Checklist

**STOP. Complete Pattern-VALIDATION-001 checklist OUT LOUD:**

‚úÖ Did I read target files first? (Never edit without reading)
‚úÖ Did I verify format/structure? (Read parser code if unsure)
‚úÖ Did I check Sprint TOML format? (SprintLoader.ts:292-333)
‚úÖ Did I validate dependencies? (BUG-002 complete - YES)

**Full Checklist**: Pattern-VALIDATION-001 (4 categories, 15+ questions)

**Automated Validation**: Pre-commit hooks run 8 validators automatically

---

## Implementation Steps (TDD Approach)

**Patterns**: Pattern-TDD-001 (RED ‚Üí GREEN ‚Üí REFACTOR), Pattern-GIT-001 (Git workflow), Pattern-TRACKING-001 (Sprint TOML lifecycle)

**REMINDER**: If you haven't completed Section 0 (Pre-Task Analysis + Code Workflow Announcement), STOP and complete it NOW.

### Step 0: Git Status + Sprint TOML Update (2 min)

**Update Sprint Status**:
```bash
/sprint-task-lifecycle start BUG-005
```

**Fallback** (if skill unavailable): Follow Pattern-TRACKING-001 manual process

**Check Git Status**:
```bash
git status
git branch --show-current
```

**Goal**: Status = "in_progress", on feature/v0.17.2-bug-fixes branch, clean working tree

---

### Step 1: Read Current App.tsx and LicenseActivationDialog (15 min)
**Tool**: Read

**Files to Read**:
1. `products/lumina-desktop/src/App.tsx` (full file - understand structure)
2. `products/lumina-desktop/src/components/LicenseActivationDialog.tsx` (review component API)

**Goal**: Understand existing first-run flow and dialog component props

**What to Look For**:
- How does App.tsx handle first run? (isFirstRun state, InstallationWizard)
- What props does LicenseActivationDialog accept? (onActivated callback)
- Where should license check happen? (useEffect after settings load)
- Any conflicts with InstallationWizard? (both show on first run)

---

### Step 2: Design Integration Architecture (10 min)
**Tool**: Planning (no code yet)

**Goal**: Plan how dialog integrates with existing App.tsx flow

**Design Decisions**:

1. **Dialog Show Logic**:
   - Check if license_key is empty after settings load
   - Show dialog ONLY if license_key is empty (not on every first run)
   - InstallationWizard shows first (if first run), then activation dialog

2. **React Hook (`useLicenseActivation`)**:
   ```typescript
   interface UseLicenseActivationReturn {
     showDialog: boolean;
     licenseKey: string;
     isActivating: boolean;
     error: string | null;
     handleActivate: (key: string) => Promise<void>;
     handleClose: () => void; // Only closes if activated
   }
   ```

3. **Event Listeners**:
   - Listen for backend `'show-license-prompt'` event
   - Emitted when API returns 401 (invalid license) or 403 (device not active)

4. **Integration Points**:
   - App.tsx checks license_key on mount
   - Shows dialog if empty
   - Dialog calls activate_license() Tauri command
   - On success: reload settings, close dialog, continue to main interface

---

### Step 3: Write Tests FIRST - RED Phase (30 min)
**Pattern**: Pattern-TDD-001 (full workflow details in pattern)

**Test File**: `products/lumina-desktop/src/hooks/__tests__/useLicenseActivation.test.ts` (NEW)

**Tests to Write**:

1. **test_hook_initializes_with_show_dialog_false**
   - Render hook with non-empty license_key
   - Assert: showDialog = false

2. **test_hook_shows_dialog_when_license_key_empty**
   - Render hook with empty license_key
   - Assert: showDialog = true

3. **test_handle_activate_calls_invoke_with_license_key**
   - Mock invoke('activate_license')
   - Call handleActivate('TEST-KEY')
   - Assert: invoke called with correct key

4. **test_handle_activate_success_closes_dialog**
   - Mock successful invoke response
   - Call handleActivate('TEST-KEY')
   - Assert: showDialog = false after success

5. **test_handle_activate_error_shows_error_message**
   - Mock invoke rejection
   - Call handleActivate('INVALID-KEY')
   - Assert: error !== null, showDialog = true

6. **test_handle_close_does_not_close_if_not_activated**
   - Call handleClose() without successful activation
   - Assert: showDialog = true (can't close without activation)

**Test Framework**: React Testing Library + @testing-library/react-hooks

**Expected Result**: Tests FAIL (RED) because hook doesn't exist yet

---

### Step 4: Create useLicenseActivation Hook (45 min) - GREEN Phase
**Pattern**: Pattern-TDD-001
**Tool**: Write
**File**: `products/lumina-desktop/src/hooks/useLicenseActivation.ts` (NEW)

**Goal**: Create React hook for license activation state management

**Implementation**:

```typescript
import { useState, useEffect, useCallback } from 'react';
import { invoke } from '@tauri-apps/api/core';
import { listen } from '@tauri-apps/api/event';

interface UseLicenseActivationOptions {
  licenseKey: string;
}

interface UseLicenseActivationReturn {
  showDialog: boolean;
  isActivating: boolean;
  error: string | null;
  handleActivate: (key: string) => Promise<void>;
  handleClose: () => void;
}

/**
 * React hook for license activation state management (BUG-005)
 *
 * DESIGN DECISION: Separate hook for activation logic
 * WHY: Keeps App.tsx clean, logic is testable, reusable if needed elsewhere
 *
 * REASONING CHAIN:
 * 1. Hook checks if license_key is empty on mount
 * 2. If empty ‚Üí showDialog = true
 * 3. User enters key ‚Üí handleActivate() calls backend
 * 4. On success ‚Üí showDialog = false, onSuccess callback
 * 5. On error ‚Üí error state set, dialog stays open
 * 6. Backend can also emit 'show-license-prompt' event (401/403 errors)
 *
 * PATTERN: Pattern-UI-006 (React Hooks for State Management)
 * RELATED: LicenseActivationDialog.tsx (UI component), auth.rs (backend validation)
 */
export function useLicenseActivation(
  options: UseLicenseActivationOptions
): UseLicenseActivationReturn {
  const { licenseKey } = options;
  const [showDialog, setShowDialog] = useState(false);
  const [isActivating, setIsActivating] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasActivated, setHasActivated] = useState(false);

  // Check if license_key is empty on mount
  useEffect(() => {
    if (!licenseKey || licenseKey.trim() === '') {
      setShowDialog(true);
    }
  }, [licenseKey]);

  // Listen for backend 'show-license-prompt' event (emitted on 401/403 errors)
  useEffect(() => {
    const unlisten = listen('show-license-prompt', (event) => {
      console.log('Backend requested license activation:', event);
      setShowDialog(true);
    });

    return () => {
      unlisten.then((fn) => fn());
    };
  }, []);

  // Handle license activation
  const handleActivate = useCallback(async (key: string) => {
    setIsActivating(true);
    setError(null);

    try {
      const result = await invoke<string>('activate_license', {
        licenseKey: key.trim(),
      });

      console.log('License activation successful:', result);
      setHasActivated(true);
      setShowDialog(false); // Close dialog on success

      // Reload page to refresh settings
      window.location.reload();
    } catch (err) {
      console.error('License activation failed:', err);
      setError(String(err));
      // Keep dialog open on error
    } finally {
      setIsActivating(false);
    }
  }, []);

  // Handle dialog close (only allowed if already activated)
  const handleClose = useCallback(() => {
    if (hasActivated) {
      setShowDialog(false);
    } else {
      // Can't close without activation
      console.log('Cannot close dialog without activating license');
    }
  }, [hasActivated]);

  return {
    showDialog,
    isActivating,
    error,
    handleActivate,
    handleClose,
  };
}
```

**Run Tests**:
```bash
cd products/lumina-desktop
npm test -- useLicenseActivation.test.ts
```

**Expected Result**: Tests PASS (GREEN)

---

### Step 5: Integrate Hook into App.tsx (30 min) - GREEN Phase
**Tool**: Edit
**File**: `products/lumina-desktop/src/App.tsx`

**Goal**: Import LicenseActivationDialog, use hook, render dialog conditionally

**Changes to Make**:

1. **Add imports at top**:
   ```typescript
   import { LicenseActivationDialog } from './components/LicenseActivationDialog';
   import { useLicenseActivation } from './hooks/useLicenseActivation';
   ```

2. **Add hook after existing useState declarations** (around line 50):
   ```typescript
   // License activation hook (BUG-005)
   const {
     showDialog: showLicenseDialog,
     isActivating,
     error: licenseError,
     handleActivate,
     handleClose,
   } = useLicenseActivation({
     licenseKey: settings.license_key,
   });
   ```

3. **Add dialog to render (before closing </div> of App)**:
   ```typescript
   {/* License Activation Dialog (BUG-005) */}
   {showLicenseDialog && (
     <LicenseActivationDialog
       onActivated={() => {
         console.log('License activated successfully');
         // Hook will handle reload
       }}
     />
   )}
   ```

**Location**: Add dialog render after existing modals (InstallationWizard, InvitationPanel)

---

### Step 6: Handle Dialog Lifecycle Edge Cases (20 min)
**Tool**: Edit
**File**: `products/lumina-desktop/src/App.tsx`

**Goal**: Ensure dialog doesn't conflict with InstallationWizard

**Logic to Add**:

```typescript
// Show license dialog ONLY if:
// 1. Not first run (InstallationWizard not showing)
// 2. OR first run is complete
// 3. AND license_key is empty

const shouldShowLicenseDialog = showLicenseDialog && (isFirstRun === false || !isFirstRun);
```

**Update render**:
```typescript
{/* Installation Wizard (first run) */}
{isFirstRun && (
  <InstallationWizard onComplete={() => setIsFirstRun(false)} />
)}

{/* License Activation Dialog (after first run or on 401/403 errors) */}
{shouldShowLicenseDialog && (
  <LicenseActivationDialog
    onActivated={() => {
      console.log('License activated successfully');
    }}
  />
)}
```

---

### Step 7: Add Component Tests (30 min)
**Tool**: Write
**File**: `products/lumina-desktop/src/components/__tests__/LicenseActivationDialog.test.tsx` (NEW)

**Goal**: Test dialog integration in App.tsx

**Tests to Write**:

1. **test_dialog_renders_when_license_key_empty**
   - Render App with empty license_key
   - Assert: LicenseActivationDialog is in document

2. **test_dialog_not_renders_when_license_key_exists**
   - Render App with non-empty license_key
   - Assert: LicenseActivationDialog not in document

3. **test_dialog_closes_after_successful_activation**
   - Render App with empty license_key
   - Mock successful invoke response
   - Activate license
   - Assert: Dialog closes

**Test Framework**: React Testing Library

---

### Step 8: Manual Testing (30 min)
**Tool**: Manual testing in running app

**Test Cases**:

1. **Test Empty License Key**:
   - Clear license_key in settings.json
   - Launch app
   - Expected: LicenseActivationDialog shows
   - Enter test key: CD7W-AJDK-RLQT-LUFA
   - Expected: Dialog closes, app continues

2. **Test Existing License Key**:
   - Set valid license_key in settings.json
   - Launch app
   - Expected: No dialog shows, app goes directly to main interface

3. **Test Invalid License Key**:
   - Clear license_key
   - Launch app
   - Enter invalid key: INVALID-0000-0000-0000
   - Expected: Error message shows, dialog stays open

4. **Test 401 Event** (if possible):
   - Revoke license from dashboard
   - Use voice capture hotkey
   - Expected: Dialog shows with error message

**Manual Test Procedure**:
```bash
# Build desktop app
cd products/lumina-desktop/src-tauri
cargo build

# Run desktop app
cargo run
```

---

### Step 9: Verify All Tests Pass (10 min)
**Tool**: Bash

```bash
cd products/lumina-desktop
npm test
npx tsc --noEmit
```

**Expected Result**: All tests pass, no TypeScript errors

---

### Step 10: Update Sprint TOML Completion Notes (5 min) - MANDATORY üõë

**‚ö†Ô∏è CRITICAL REQUIREMENT**: This step is MANDATORY. DO NOT proceed to Step 11 (Commit) until this is complete.

**Pattern**: Pattern-COMPLETION-001

**Why This Step Exists**: Historical audits (BUG-002A, BUG-003, BUG-002) found agents skipped completion documentation. This step MUST be completed BEFORE committing changes. If you skip this, your commit will be considered incomplete.

---

**Update Sprint TOML with completion_notes field:**

Open `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml` and add the following to your task section (after `completed_date`):

```toml
[tasks.BUG-005]
status = "completed"
completed_date = "2025-01-13"  # Today's date

completion_notes = """
Completed 2025-01-13 by AI agent (ui-agent)

Changes Made:
- Created useLicenseActivation React hook for license activation state management
- Integrated LicenseActivationDialog into App.tsx
- Added event listeners for backend 'show-license-prompt' event
- Added conditional rendering logic (show dialog when license_key empty)
- Handled dialog lifecycle (show on first launch, close on success)
- Added edge case handling (dialog doesn't conflict with InstallationWizard)

Technical Details:
- File(s): App.tsx (~30 lines added), useLicenseActivation.ts (110 lines new file)
- Lines Added/Modified: ~140 lines
- Test Coverage: [COVERAGE]% ([TEST_COUNT] tests, all passing)
- Breaking Change: No (backward compatible)
- Commit: [COMMIT_HASH] (will add after Step 11)

Testing:
- Hook tests: [HOOK_TEST_RESULTS]
- Component tests: [COMPONENT_TEST_RESULTS]
- Manual testing: First-launch flow tested (empty license_key ‚Üí dialog shows ‚Üí activation succeeds ‚Üí dialog closes)

Impact:
- Unblocks: Full first-time user experience, license activation flow end-to-end
- Fixes: Users can now enter license key on first launch
- Enables: Complete desktop app activation without manual settings.json editing

Dependencies:
- Blocked by: BUG-002 (license activation backend + component) - completed ‚úÖ
- Related: BUG-004 (error handling can trigger dialog with 401/403 events)

Next Steps:
- Manual testing with live API (test credentials: CD7W-AJDK-RLQT-LUFA)
- Consider adding toast notifications on successful activation
- Add deactivation flow in settings (release license from device)
"""
```

---

**Validation (MANDATORY - Run BEFORE proceeding to Step 11):**

```bash
# Check if status is "completed"
grep -A 5 "^\[tasks.BUG-005\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep 'status = "completed"'

# Check if completed_date exists
grep -A 5 "^\[tasks.BUG-005\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep "completed_date"

# Check if completion_notes exists
grep -A 50 "^\[tasks.BUG-005\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep "completion_notes"
```

**Expected Output:**
```
status = "completed"
completed_date = "2025-01-13"
completion_notes = """
```

**‚ùå If ANY command returns empty**: Sprint TOML is NOT updated. Do NOT proceed to Step 11. Fix it NOW.

**‚úÖ If ALL commands return results**: Sprint TOML is updated correctly. Proceed to Step 11.

---

**üõë BLOCKER**: DO NOT proceed to Step 11 (Commit) until ALL validation commands return expected output.

---

### Step 11: Commit Changes (5 min)

**‚ö†Ô∏è PREREQUISITE CHECK**: Did you complete Step 10 (Update Sprint TOML Completion Notes)?

**If NO**: STOP. Go back to Step 10 and complete it NOW.

**If YES**: Verify by running the 3 validation commands from Step 10. All 3 MUST return results.

---

**Pattern**: Pattern-GIT-001 (full commit format + workflow)

```bash
git add products/lumina-desktop/src/App.tsx
git add products/lumina-desktop/src/hooks/useLicenseActivation.ts
git add products/lumina-desktop/src/hooks/__tests__/useLicenseActivation.test.ts
git add products/lumina-desktop/src/components/__tests__/LicenseActivationDialog.test.tsx
git add internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml

# Commit (use HEREDOC for proper formatting)
git commit -m "$(cat <<'EOF'
feat(desktop): Integrate license activation dialog into App.tsx (BUG-005)

- Create useLicenseActivation React hook for state management
- Integrate LicenseActivationDialog into App.tsx
- Add event listeners for backend 'show-license-prompt' event
- Show dialog on first launch when license_key is empty
- Handle dialog lifecycle (show/close, activation success/error)
- Add edge case handling (no conflict with InstallationWizard)

Files Created:
- useLicenseActivation.ts (110 lines) - React hook for activation state
- useLicenseActivation.test.ts - Hook tests (6 tests)
- LicenseActivationDialog.test.tsx - Component integration tests (3 tests)

Files Modified:
- App.tsx (~30 lines) - Import dialog, use hook, conditional render

Testing:
- Hook tests: [TEST_COUNT] passed
- Component tests: [TEST_COUNT] passed
- Manual testing: First-launch flow verified

Completes first-time user license activation flow (BUG-002 created component, BUG-005 integrates).

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

**After Commit**: Get commit hash and add it to completion_notes (optional but recommended):
```bash
git log -1 --format=%h
# Copy hash and update completion_notes "Commit: {hash}" field
```

---

### Step 12: Update Sprint Status to Completed (2 min)
**Pattern**: Pattern-TRACKING-001

```bash
/sprint-task-lifecycle complete BUG-005
```

**Fallback** (if skill unavailable): Follow Pattern-TRACKING-001 manual process

**Validation**: Verify status = "completed" and completed_date added

**‚ö†Ô∏è v2.0 ENFORCEMENT**: If `/sprint-task-lifecycle complete` returns error about missing completion_notes, go back to Step 10 and complete it NOW.

---

## Acceptance Criteria

- [ ] Pre-Task Analysis completed (Pattern-TASK-ANALYSIS-001)
- [ ] Code Workflow Announcement made (Pattern-CODE-001)
- [ ] useLicenseActivation hook created with state management
- [ ] Hook listens for 'show-license-prompt' backend event
- [ ] LicenseActivationDialog imported in App.tsx
- [ ] Dialog shows on first launch when license_key is empty
- [ ] Dialog closes after successful activation
- [ ] Dialog stays open on activation error
- [ ] No conflict with InstallationWizard (first run)
- [ ] 6 hook tests pass (initialization, activation, error handling)
- [ ] 3 component tests pass (render, close, integration)
- [ ] Manual testing completed (first-launch flow works)
- [ ] Sprint TOML completion_notes added (Step 10 - Pattern-COMPLETION-001) üõë MANDATORY
- [ ] Sprint TOML validation commands pass (Step 10 - all 3 commands return results)
- [ ] TypeScript compilation passes (no errors)
- [ ] Sprint TOML updated to "completed" (Pattern-TRACKING-001)
- [ ] Changes committed (Pattern-GIT-001)
- [ ] Ready for manual testing with live API

---

## Error Handling

### Issue 1: Dialog Shows Behind InstallationWizard

**Problem**: Both dialogs show at same time on first run

**Cause**: Both check isFirstRun or license_key independently

**Solution**: Add conditional logic:
```typescript
const shouldShowLicenseDialog = showLicenseDialog && (isFirstRun === false);
```

### Issue 2: Hook Doesn't Detect Empty License Key

**Problem**: Hook shows showDialog = false even when license_key is empty

**Cause**: Settings not loaded yet when hook initializes

**Solution**: Add dependency to useEffect:
```typescript
useEffect(() => {
  if (!licenseKey || licenseKey.trim() === '') {
    setShowDialog(true);
  }
}, [licenseKey]); // Re-run when licenseKey changes
```

### Issue 3: Dialog Closes Too Early

**Problem**: Dialog closes before settings reload, app shows empty state

**Cause**: window.location.reload() is async

**Solution**: Already handled - reload happens in hook after activation

### Issue 4: Event Listener Memory Leak

**Problem**: Event listener not cleaned up on unmount

**Cause**: Missing cleanup function in useEffect

**Solution**: Already handled - unlisten() called in cleanup:
```typescript
return () => {
  unlisten.then((fn) => fn());
};
```

### Issue 5: TypeScript Import Errors

**Problem**: Cannot find module '@tauri-apps/api/core'

**Cause**: Wrong Tauri import path (v1 vs v2)

**Solution**: Use correct Tauri v2 imports:
```typescript
import { invoke } from '@tauri-apps/api/core'; // ‚úÖ Correct (v2)
import { listen } from '@tauri-apps/api/event'; // ‚úÖ Correct (v2)
```

---

## Rollback Plan

**If tests fail** (Step 3-4):
```bash
git checkout -- products/lumina-desktop/src/hooks/useLicenseActivation.ts
# Review LicenseActivationDialog.tsx API, update hook, retry
```

**If App.tsx integration breaks** (Step 5):
```bash
git checkout -- products/lumina-desktop/src/App.tsx
# Review existing first-run flow, update integration, retry
```

**Emergency Rollback**:
```bash
git stash  # Save work
git reset --hard HEAD  # Reset
git stash pop  # Restore if needed
```

---

## Time Estimate

- Pre-Task Analysis (Pattern-TASK-ANALYSIS-001): 5-10 min
- Step 0 (Git + Sprint): 2 min
- Step 1 (Read files): 15 min
- Step 2 (Design architecture): 10 min
- Step 3 (Tests - RED): 30 min
- Step 4 (Create hook - GREEN): 45 min
- Step 5 (Integrate into App.tsx): 30 min
- Step 6 (Handle edge cases): 20 min
- Step 7 (Component tests): 30 min
- Step 8 (Manual testing): 30 min
- Step 9 (Verify tests): 10 min
- Step 10 (Sprint TOML Completion Notes): 5 min üõë MANDATORY
- Step 11 (Commit): 5 min
- Step 12 (Sprint Complete): 2 min

**Total**: 4-5 hours (as estimated)

---

## Dependencies

**Blocks**: Full first-time user experience, end-to-end activation flow

**Blocked By**: BUG-002 (license activation backend + component - COMPLETED ‚úÖ)

**Related**: BUG-004 (error handling system can emit 'show-license-prompt' event on 401/403)

---

## Success Impact

After BUG-005 complete:

‚úÖ Activation dialog appears on first launch when license_key is empty
‚úÖ Users can enter license key from dashboard
‚úÖ Dialog closes after successful activation
‚úÖ App continues to main interface after activation
‚úÖ Backend events (401/403) can trigger dialog to re-show
‚úÖ No conflict with InstallationWizard on first run
‚úÖ Complete first-time user experience (BUG-002 backend + BUG-005 integration)
‚úÖ Reduced support burden (users can self-activate)

---

## Notes

### Design Decisions

**Why create a React hook?**
- Separation of concerns (logic separate from UI)
- Testable in isolation (easier to mock backend calls)
- Reusable (could use in settings panel for re-activation)

**Why reload page after activation?**
- Settings need to be reloaded from disk (license_key, user_id, device_id, tier)
- Simpler than manually updating all state
- Ensures consistent state across app

**Why listen for backend events?**
- Backend can detect 401/403 errors during voice capture
- Need to show activation dialog even when app is already running
- Allows for automatic re-activation flow

### Integration with BUG-002

This task completes the work started in BUG-002:
- BUG-002: Backend validation + component creation
- BUG-005: App.tsx integration + event wiring

Together they form the complete license activation system.

### Frontend Testing Notes

- Hook tests use @testing-library/react-hooks
- Component tests use React Testing Library
- Manual testing required for end-to-end flow (hook + component + backend)

---

**This enhanced prompt follows template v1.4.3 (breadcrumb-based with mandatory pre-task analysis + completion notes in workflow). All universal protocols are in patterns/skills for token efficiency.**

**Pattern References**:
- Pattern-TASK-ANALYSIS-001: 8-step pre-task analysis (MANDATORY)
- Pattern-CODE-001: Code workflow + announcement (MANDATORY)
- Pattern-COMPLETION-001: Post-completion documentation (MANDATORY - Step 10)
- Pattern-TRACKING-001: Sprint TOML lifecycle
- Pattern-GIT-001: Git workflow + commit format
- Pattern-TDD-001: Test-driven development
- Pattern-VALIDATION-001: Pre-flight checklist
- Pattern-UI-006: React component integration patterns

**Skill References**:
- sprint-task-lifecycle: Automated Sprint TOML updates (v2.0 with completion_notes validation)

**Token Savings**: ~2,100-2,400 tokens (54%+ reduction from v1.0, maintains enforcement)

---

**IMPORTANT**: Completion notes documentation (formerly Section 12) is now **Step 10** in the implementation workflow. This ensures agents complete documentation BEFORE committing changes, not after. See Step 10 for full instructions.
