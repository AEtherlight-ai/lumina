# ENHANCE-001.8: Context Preview & Override UI (Show Context Before Enhancement)

**Sprint:** 17.1-BUGS
**Task ID:** ENHANCE-001.8
**Agent:** ui-agent
**Estimated Time:** 4-5 hours
**Dependencies:** ENHANCE-001.2
**Template Version:** MVP-003-PromptEnhancer-TaskTemplate-v1.4.3

---

## Step 0: Pre-Task Analysis (MANDATORY - Run Pattern-TASK-ANALYSIS-001)

**CRITICAL: You MUST complete this 8-step analysis OUT LOUD before writing ANY code.**

### 1. UNDERSTAND the Task

**Task Goal:**
Add a context preview modal that appears BEFORE AI enhancement runs, showing all gathered context (workspace analysis, git history, patterns, validation warnings). User can review, edit, add/remove patterns, override warnings, and adjust git time range before proceeding with enhancement. CRITICAL for user control and transparency.

**Why This Task Exists:**
**Problem - Context is a black box:**

From user's perspective:
- Context gathering happens invisibly in background
- User doesn't see what workspace analysis found
- User doesn't see which patterns were automatically selected
- User doesn't see what git commits were analyzed
- If context is wrong, user can't fix it before enhancement runs

**User Need:** "Let me see and fix the context before you enhance the prompt."

**Garbage in, garbage out principle:**
- Wrong patterns selected â†’ AI gets wrong guidance â†’ Bad prompt
- Irrelevant files included â†’ AI gets confused â†’ Unfocused prompt
- Missing critical context â†’ AI lacks information â†’ Incomplete prompt
- Incorrect validation warnings â†’ User frustrated â†’ Bad experience

**Solution:**
Show context preview modal AFTER context gathering, BEFORE AI enhancement. Modal displays all gathered context in organized sections. User reviews, adds missing patterns, removes irrelevant files, overrides incorrect warnings, adjusts git time range, then clicks [Proceed] to continue with enhancement.

**Current vs. Desired State:**
- **CURRENT:** Context gathering invisible, no preview, no override, user can't verify or fix context
- **DESIRED:** Context preview modal before enhancement, user reviews and edits context, proceeds with confidence

### 2. CHECK for Existing Solutions

**Search Strategy:**
```bash
# Search for existing modal components
grep -r "modal" vscode-lumina/src/
grep -r "ContextPreview" vscode-lumina/src/

# Check if context builders already exist
ls vscode-lumina/src/services/enhancement/

# Check webview modal patterns
grep -r "showModal" vscode-lumina/src/commands/voicePanel.ts
```

**Expected Findings:**
- Context builders from ENHANCE-001.2, 001.3, 001.4 (gather context)
- voicePanel.ts creates webview (integration point)
- No existing context preview modal (new feature)
- May have modal patterns from ENHANCE-001.7 (refinement modals)

### 3. IDENTIFY Required Changes

**Files to Create:**
1. `vscode-lumina/src/components/ContextPreviewModal.ts` (~300 lines)
   - Modal component for context display
   - Sections: Workspace, Git, Patterns, Validation, Confidence
   - Edit capabilities: Add/remove patterns, override warnings, adjust git range

**Files to Read (for context):**
1. `vscode-lumina/src/types/EnhancementContext.ts` - Context structure to display
2. `vscode-lumina/src/commands/voicePanel.ts` - Integration point, webview patterns
3. `vscode-lumina/src/services/enhancement/TaskContextBuilder.ts` - Example context builder

**Files to Modify:**
1. `vscode-lumina/src/commands/voicePanel.ts` - Insert context preview before enhancement
2. Webview HTML (embedded in voicePanel.ts) - Add modal UI for context preview

### 4. ASSESS Impact & Risk

**Impact Assessment:**
- **Scope:** MEDIUM - New modal component, workflow modification (preview before enhancement)
- **Blast Radius:** MEDIUM - Affects all enhancement flows (adds preview step)
- **Performance:** LOW - Modal render < 200ms, no heavy operations
- **Breaking Changes:** NONE - Additive feature, user can skip preview

**Risk Factors:**
- âš ï¸ **UX Risk:** Extra step might slow down users who don't need preview
- âš ï¸ **Complexity Risk:** Context editing logic (add/remove patterns, override warnings)
- âš ï¸ **State Risk:** Must preserve edited context throughout enhancement
- âš ï¸ **Validation Risk:** User overrides might break downstream validation

**Mitigation Strategies:**
- Add "Skip Preview" checkbox (remember preference) for advanced users
- Keep editing UI simple (minimal clicks to add/remove)
- Store edited context in enhancement metadata
- Warn user when overriding critical validation warnings

### 5. VERIFY Dependencies & Blockers

**Dependencies:**
- âœ… **ENHANCE-001.2:** Simple context builders exist (provide context to preview)
- âœ… **EnhancementContext type:** Defined, contains all data to display
- âœ… **voicePanel.ts:** Webview creation exists

**Potential Blockers:**
- âŒ **Pattern picker UI unknown:** How to show pattern selection UI?
- âŒ **Git date picker integration:** VS Code date picker API?

**Blocker Resolution:**
- Use dropdown for pattern picker (reuse from ENHANCE-001.7)
- Use HTML5 date input for git time range (native browser control)

### 6. PLAN with Git Workflow (Pattern-GIT-001)

**Current Branch:** feature/v0.17.2-bug-fixes
**Git Status:** Clean (from gitStatus snapshot)

**Workflow Steps:**
1. âœ… Verify branch: `git status` (already on feature branch)
2. âœ… Read EnhancementContext.ts to understand data structure
3. âœ… Write tests FIRST (TDD RED phase)
4. âœ… Create ContextPreviewModal component (GREEN phase)
5. âœ… Add modal UI to webview HTML (GREEN phase)
6. âœ… Integrate modal into enhancement workflow (GREEN phase)
7. âœ… Test manually with real context (manual verification)
8. âœ… Optimize modal rendering (REFACTOR phase)
9. âœ… Commit: "feat(ENHANCE-001.8): Implement context preview & override UI"
10. âœ… Validation: Test all editing capabilities

**Commit Message Template:**
```
feat(ENHANCE-001.8): Implement context preview & override UI

- Add ContextPreviewModal component
- Add modal UI to webview HTML (5 sections)
- Display workspace analysis (languages, frameworks, files)
- Display git history (commits, time range adjustment)
- Display detected patterns (add/remove buttons)
- Display validation warnings (override button)
- Display confidence score
- Add [Edit Context] button with context editor
- Add [Proceed] and [Cancel] buttons
- Integrate modal into enhancement workflow (before AI)
- Store edited context in metadata
- Add "Skip Preview" preference (remember choice)
- Add unit tests (70% coverage)
- Modal render < 200ms

Users can now review and edit context before enhancement.

Closes ENHANCE-001.8
```

### 7. CHECK Patterns & SOPs

**Applicable Patterns:**
- âœ… **Pattern-CODE-001:** Code development workflow (announced OUT LOUD)
- âœ… **Pattern-TDD-001:** Tests FIRST (RED â†’ GREEN â†’ REFACTOR)
- âœ… **Pattern-UX-001:** User experience design (transparency and control)

**Pattern Integration:**
- Context preview implements transparency principle (user sees what system is doing)
- Override capability implements user control principle (user can fix mistakes)

### 8. ESTIMATE Effort & Complexity

**Effort Estimate:** 4-5 hours (from task specification)

**Complexity Breakdown:**
- **Read EnhancementContext:** 15 min - Understand structure to display
- **Modal UI Design:** 60 min - HTML/CSS for 5 sections (workspace, git, patterns, validation, confidence)
- **ContextPreviewModal Component:** 90 min - Display logic, edit handlers
- **Pattern Add/Remove:** 30 min - Pattern picker integration
- **Git Time Range:** 30 min - Date picker integration
- **Validation Override:** 20 min - Override button logic
- **Integration:** 45 min - Insert modal into enhancement workflow
- **Tests:** 90 min - 12 test cases (70% coverage)

**Total:** ~5 hours (matches estimate)

**Confidence Level:** MEDIUM-HIGH
- âœ… Modal UI pattern established (from ENHANCE-001.7)
- âœ… EnhancementContext structure well-defined
- âš ï¸ Context editing logic (add/remove, override) requires careful state management
- âš ï¸ Integration timing (after context gathering, before AI enhancement)

---

## Step 1: UNDERSTAND the Context Structure

### Read Foundation Files

**CRITICAL: Read these files BEFORE writing any code.**

```bash
# Read EnhancementContext to see what data is available
cat vscode-lumina/src/types/EnhancementContext.ts

# Read context builders to understand what data is gathered
cat vscode-lumina/src/services/enhancement/BugReportContextBuilder.ts
cat vscode-lumina/src/services/enhancement/TaskContextBuilder.ts

# Read voicePanel to understand enhancement workflow
cat vscode-lumina/src/commands/voicePanel.ts | grep -A 50 "handleEnhancePrompt"
```

### EnhancementContext Structure (What to Display)

**From EnhancementContext.ts:**

```typescript
interface EnhancementContext {
    type: EnhancementType;              // 'bug', 'feature', 'task', etc.
    template: TemplateTask;             // Task template data
    metadata: EnhancementMetadata;      // Confidence, patterns, agent, validation
    workspaceContext: WorkspaceContext; // Workspace analysis data
    specificContext: any;               // Button-specific data
}

interface WorkspaceContext {
    rootPath: string;                   // Workspace root
    languages: string[];                // Detected languages
    frameworks: string[];               // Detected frameworks
    filesFound: Array<{                 // Relevant files
        path: string;
        relevance: number;              // 0-100
        reason: string;
    }>;
    gitCommits: Array<{                 // Recent commits
        hash: string;
        message: string;
        date: string;
    }>;
    sops: {                             // Standard Operating Procedures
        claudeMd?: string;
        aetherlightMd?: string;
    };
}

interface EnhancementMetadata {
    buttonType: string;                 // Which button clicked
    confidence: ConfidenceScore;        // Confidence level
    patterns: string[];                 // Detected patterns
    agent: string;                      // Assigned agent
    validation: ValidationStatus;       // Validation results
}

interface ValidationStatus {
    filesExist: boolean;                // Do files exist?
    dependenciesMet: boolean;           // Dependencies satisfied?
    taskDataCurrent: boolean;           // Task data up-to-date?
}
```

### Modal Design (5 Sections)

**Section 1: Workspace Analysis**
```
âœ“ Workspace Analysis
  Languages: TypeScript (87%), JavaScript (13%)
  Frameworks: VS Code Extension, Node.js
  Files: 1,234 total, 23 relevant
  [View Files] [Edit Selection]
```

**Section 2: Git History**
```
âœ“ Git History (Last 30 Days)
  Commits: 15 analyzed
  Modified Files: 45 files
  Recent: feat: Add context builder (2 days ago)
  [Change Time Range] [View Commits]
```

**Section 3: Patterns**
```
âœ“ Patterns Detected (5 found)
  â€¢ Pattern-CODE-001 âœ“
  â€¢ Pattern-TDD-001 âœ“
  â€¢ Pattern-REFACTOR-001 âœ“
  [Add Pattern] [Remove Pattern]
```

**Section 4: Validation Warnings**
```
âš  Validation Warnings (1)
  â€¢ No test files found
  [Override] [Ignore]
```

**Section 5: Confidence Score**
```
Confidence: High (92%)
  âœ“ Files exist: Yes
  âœ“ Dependencies met: Yes
  âœ“ Task data current: Yes
```

---

## Step 2: TDD - Write Tests FIRST (RED Phase)

**CRITICAL: Pattern-TDD-001 requires writing tests BEFORE implementation.**

### Test File 1: ContextPreviewModal Component

**File:** `vscode-lumina/test/components/ContextPreviewModal.test.ts`

```typescript
import * as assert from 'assert';
import { ContextPreviewModal } from '../../src/components/ContextPreviewModal';
import { EnhancementContext } from '../../src/types/EnhancementContext';

describe('ContextPreviewModal', () => {
    let modal: ContextPreviewModal;
    let mockContext: EnhancementContext;

    beforeEach(() => {
        mockContext = createMockContext();
        modal = new ContextPreviewModal(mockContext);
    });

    // TEST 1: Modal displays workspace analysis
    describe('Workspace analysis section', () => {
        it('should display languages with percentages', () => {
            const html = modal.render();

            assert.ok(html.includes('TypeScript'));
            assert.ok(html.includes('JavaScript'));
        });

        it('should display frameworks', () => {
            const html = modal.render();

            assert.ok(html.includes('VS Code Extension'));
            assert.ok(html.includes('Node.js'));
        });

        it('should display file count', () => {
            mockContext.workspaceContext.filesFound = Array(23).fill({ path: 'file.ts', relevance: 90, reason: 'test' });
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('23 relevant'));
        });
    });

    // TEST 2: Modal displays git history
    describe('Git history section', () => {
        it('should display commit count', () => {
            mockContext.workspaceContext.gitCommits = Array(15).fill({
                hash: 'abc123',
                message: 'test commit',
                date: '2025-01-13'
            });
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('15 analyzed'));
        });

        it('should display recent commit message', () => {
            mockContext.workspaceContext.gitCommits = [
                { hash: 'abc123', message: 'feat: Add context builder', date: '2025-01-13' }
            ];
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('Add context builder'));
        });

        it('should show time range (days back)', () => {
            const html = modal.render();
            assert.ok(html.includes('Last 30 Days') || html.includes('Last 7 Days'));
        });
    });

    // TEST 3: Modal displays patterns
    describe('Patterns section', () => {
        it('should display detected patterns', () => {
            mockContext.metadata.patterns = ['Pattern-CODE-001', 'Pattern-TDD-001'];
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('Pattern-CODE-001'));
            assert.ok(html.includes('Pattern-TDD-001'));
        });

        it('should show pattern count', () => {
            mockContext.metadata.patterns = ['Pattern-CODE-001', 'Pattern-TDD-001', 'Pattern-GIT-001'];
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('3 found') || html.includes('(3)'));
        });
    });

    // TEST 4: Modal displays validation warnings
    describe('Validation warnings section', () => {
        it('should display warnings if validation fails', () => {
            mockContext.metadata.validation = {
                filesExist: false,
                dependenciesMet: true,
                taskDataCurrent: true
            };
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('Validation Warnings'));
            assert.ok(html.includes('files') || html.includes('Files'));
        });

        it('should NOT show warnings section if all validation passes', () => {
            mockContext.metadata.validation = {
                filesExist: true,
                dependenciesMet: true,
                taskDataCurrent: true
            };
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            // Should either not show warnings section, or show "No warnings"
            const hasNoWarnings = !html.includes('âš ') || html.includes('No warnings');
            assert.ok(hasNoWarnings);
        });
    });

    // TEST 5: Modal displays confidence score
    describe('Confidence score section', () => {
        it('should display confidence level and score', () => {
            mockContext.metadata.confidence = { score: 92, level: 'high' };
            modal = new ContextPreviewModal(mockContext);

            const html = modal.render();
            assert.ok(html.includes('High') || html.includes('high'));
            assert.ok(html.includes('92'));
        });
    });

    // TEST 6: Add pattern functionality
    describe('Add pattern', () => {
        it('should add pattern to context when user selects', async () => {
            const result = await modal.addPattern('Pattern-SPRINT-PLAN-001');

            assert.strictEqual(result, true);
            const updatedContext = modal.getUpdatedContext();
            assert.ok(updatedContext.metadata.patterns.includes('Pattern-SPRINT-PLAN-001'));
        });

        it('should NOT add duplicate pattern', async () => {
            mockContext.metadata.patterns = ['Pattern-CODE-001'];
            modal = new ContextPreviewModal(mockContext);

            const result = await modal.addPattern('Pattern-CODE-001');

            assert.strictEqual(result, false);
            const updatedContext = modal.getUpdatedContext();
            assert.strictEqual(updatedContext.metadata.patterns.length, 1);
        });
    });

    // TEST 7: Remove pattern functionality
    describe('Remove pattern', () => {
        it('should remove pattern from context when user clicks', async () => {
            mockContext.metadata.patterns = ['Pattern-CODE-001', 'Pattern-TDD-001'];
            modal = new ContextPreviewModal(mockContext);

            const result = await modal.removePattern('Pattern-CODE-001');

            assert.strictEqual(result, true);
            const updatedContext = modal.getUpdatedContext();
            assert.ok(!updatedContext.metadata.patterns.includes('Pattern-CODE-001'));
            assert.strictEqual(updatedContext.metadata.patterns.length, 1);
        });
    });

    // TEST 8: Override validation warning
    describe('Override validation', () => {
        it('should mark validation as overridden', async () => {
            mockContext.metadata.validation = {
                filesExist: false,
                dependenciesMet: true,
                taskDataCurrent: true
            };
            modal = new ContextPreviewModal(mockContext);

            await modal.overrideValidation('filesExist');

            const updatedContext = modal.getUpdatedContext();
            assert.ok(updatedContext.metadata.validationOverrides);
            assert.ok(updatedContext.metadata.validationOverrides.includes('filesExist'));
        });
    });

    // TEST 9: Adjust git time range
    describe('Adjust git time range', () => {
        it('should update git analysis time range', async () => {
            await modal.adjustGitTimeRange(7); // 7 days instead of 30

            const updatedContext = modal.getUpdatedContext();
            assert.ok(updatedContext.workspaceContext.gitTimeRange === 7);
        });
    });

    // TEST 10: Proceed button
    describe('[Proceed] button', () => {
        it('should return updated context when proceed clicked', async () => {
            let proceedCalled = false;
            let capturedContext: EnhancementContext | null = null;

            modal.onProceed((context) => {
                proceedCalled = true;
                capturedContext = context;
            });

            await modal.handleProceed();

            assert.strictEqual(proceedCalled, true);
            assert.ok(capturedContext);
        });
    });

    // TEST 11: Cancel button
    describe('[Cancel] button', () => {
        it('should trigger cancel callback when cancel clicked', async () => {
            let cancelCalled = false;

            modal.onCancel(() => {
                cancelCalled = true;
            });

            await modal.handleCancel();

            assert.strictEqual(cancelCalled, true);
        });
    });

    // TEST 12: Context changes reflected
    describe('Context changes', () => {
        it('should reflect all user changes in updated context', async () => {
            await modal.addPattern('Pattern-NEW-001');
            await modal.removePattern('Pattern-CODE-001');
            await modal.overrideValidation('filesExist');
            await modal.adjustGitTimeRange(14);

            const updatedContext = modal.getUpdatedContext();

            assert.ok(updatedContext.metadata.patterns.includes('Pattern-NEW-001'));
            assert.ok(!updatedContext.metadata.patterns.includes('Pattern-CODE-001'));
            assert.ok(updatedContext.metadata.validationOverrides?.includes('filesExist'));
            assert.strictEqual(updatedContext.workspaceContext.gitTimeRange, 14);
        });
    });
});

// Helper function
function createMockContext(): EnhancementContext {
    return {
        type: 'bug',
        template: {
            id: 'BUG-001',
            name: 'Fix authentication bug',
            description: 'Fix auth issue',
            files_to_modify: ['src/auth.ts']
        },
        metadata: {
            buttonType: 'bug',
            confidence: { score: 92, level: 'high' },
            patterns: ['Pattern-CODE-001', 'Pattern-TDD-001'],
            agent: 'developer-agent',
            validation: {
                filesExist: true,
                dependenciesMet: true,
                taskDataCurrent: true
            }
        },
        workspaceContext: {
            rootPath: '/workspace',
            languages: ['TypeScript', 'JavaScript'],
            frameworks: ['VS Code Extension', 'Node.js'],
            filesFound: [
                { path: 'src/auth.ts', relevance: 95, reason: 'Authentication logic' }
            ],
            gitCommits: [
                { hash: 'abc123', message: 'feat: Add context builder', date: '2025-01-11' }
            ],
            sops: {
                claudeMd: 'Project instructions...',
                aetherlightMd: 'Ã†therLight patterns...'
            }
        },
        specificContext: {}
    };
}
```

### Test File 2: voicePanel Integration

**File:** `vscode-lumina/test/commands/voicePanel-context-preview.test.ts`

```typescript
import * as assert from 'assert';
import { VoicePanelCommand } from '../../src/commands/voicePanel';

describe('VoicePanelCommand - Context Preview Integration', () => {
    let voicePanel: VoicePanelCommand;

    beforeEach(() => {
        voicePanel = new VoicePanelCommand();
    });

    // TEST 1: Modal appears before enhancement
    describe('Modal timing', () => {
        it('should show context preview modal after context gathering, before AI enhancement', async () => {
            let modalShown = false;
            let aiCalled = false;

            // Mock modal
            voicePanel['showContextPreview'] = async () => {
                modalShown = true;
                return true; // User clicked Proceed
            };

            // Mock AI service
            voicePanel['aiEnhancementService'].enhance = async () => {
                aiCalled = true;
                return 'Enhanced prompt';
            };

            await voicePanel.handleEnhancePrompt('bug', mockFormData);

            assert.strictEqual(modalShown, true, 'Modal should be shown');
            assert.strictEqual(aiCalled, true, 'AI should be called after modal');
        });

        it('should NOT call AI if user cancels modal', async () => {
            let aiCalled = false;

            voicePanel['showContextPreview'] = async () => {
                return false; // User clicked Cancel
            };

            voicePanel['aiEnhancementService'].enhance = async () => {
                aiCalled = true;
                return 'Enhanced prompt';
            };

            await voicePanel.handleEnhancePrompt('bug', mockFormData);

            assert.strictEqual(aiCalled, false, 'AI should NOT be called if modal cancelled');
        });
    });

    // TEST 2: Edited context used in enhancement
    describe('Context editing', () => {
        it('should use edited context for AI enhancement', async () => {
            let enhancementContext: any = null;

            voicePanel['showContextPreview'] = async (context) => {
                // User adds pattern
                context.metadata.patterns.push('Pattern-NEW-001');
                return true;
            };

            voicePanel['aiEnhancementService'].enhance = async (context) => {
                enhancementContext = context;
                return 'Enhanced prompt';
            };

            await voicePanel.handleEnhancePrompt('bug', mockFormData);

            assert.ok(enhancementContext);
            assert.ok(enhancementContext.metadata.patterns.includes('Pattern-NEW-001'));
        });
    });
});
```

### Run Tests (Expected to FAIL - RED Phase)

```bash
cd vscode-lumina
npm test -- --grep "ContextPreviewModal|Context Preview Integration"
```

**Expected Output:**
```
ContextPreviewModal
  âŒ should display languages with percentages
  Error: Cannot find module '../../src/components/ContextPreviewModal'

  ... 11 more failures

VoicePanelCommand - Context Preview Integration
  âŒ should show context preview modal after context gathering
  Error: showContextPreview is not a function

  ... 1 more failure

  0 passing (58ms)
  14 failing
```

**Status:** âœ… RED phase complete (tests exist, implementation missing)

---

## Step 3: Implementation - ContextPreviewModal Component (GREEN Phase)

### File: ContextPreviewModal.ts

**File:** `vscode-lumina/src/components/ContextPreviewModal.ts`

```typescript
/**
 * ContextPreviewModal
 *
 * DESIGN DECISION: Show context BEFORE AI enhancement for transparency and control
 * WHY: "Garbage in, garbage out" - if context is wrong, AI output will be wrong
 *
 * REASONING CHAIN:
 * 1. Context gathering happens automatically (workspace analysis, git, patterns)
 * 2. Automatic context might miss critical information or include irrelevant data
 * 3. User has no visibility into what context was gathered
 * 4. User cannot fix incorrect context before AI enhancement
 * 5. Bad context â†’ Bad AI output â†’ User frustration
 * 6. Solution: Show context preview modal BEFORE AI runs
 * 7. User reviews context, adds missing patterns, removes irrelevant files, overrides warnings
 * 8. User proceeds with confidence that context is correct
 * 9. Result: Better AI output, user control, transparency
 *
 * PATTERN: Pattern-UX-001 (User Control & Transparency)
 * ARCHITECTURE: v3.0 AI Enhancement System with preview layer
 * RELATED: EnhancementContext.ts, voicePanel.ts
 *
 * USER NEED:
 * "Let me see and fix the context before you enhance the prompt."
 */

import { EnhancementContext } from '../types/EnhancementContext';

export class ContextPreviewModal {
    private context: EnhancementContext;
    private editedContext: EnhancementContext;
    private proceedCallback?: (context: EnhancementContext) => void;
    private cancelCallback?: () => void;

    constructor(context: EnhancementContext) {
        this.context = context;
        // Deep clone to allow editing without affecting original
        this.editedContext = JSON.parse(JSON.stringify(context));
    }

    /**
     * Render modal HTML
     *
     * Returns HTML string for webview display
     */
    render(): string {
        return `
        <div class="context-preview-modal">
            <div class="modal-header">
                <h2>Context Gathered for ${this.getButtonTypeName()}</h2>
                <p class="modal-subtitle">Review and edit context before enhancement</p>
            </div>

            <div class="modal-body">
                ${this.renderWorkspaceSection()}
                ${this.renderGitHistorySection()}
                ${this.renderPatternsSection()}
                ${this.renderValidationSection()}
                ${this.renderConfidenceSection()}
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="handleCancel()">Cancel</button>
                <button class="btn-primary" onclick="handleProceed()">Proceed with Enhancement</button>
            </div>
        </div>

        <style>
            .context-preview-modal {
                background: var(--vscode-editor-background);
                border: 1px solid var(--vscode-panel-border);
                border-radius: 8px;
                padding: 24px;
                max-width: 600px;
                margin: 20px auto;
            }

            .modal-header h2 {
                margin: 0 0 8px 0;
                font-size: 18px;
                color: var(--vscode-foreground);
            }

            .modal-subtitle {
                margin: 0;
                font-size: 13px;
                color: var(--vscode-descriptionForeground);
            }

            .modal-body {
                margin: 24px 0;
            }

            .context-section {
                margin-bottom: 24px;
                padding: 16px;
                background: var(--vscode-editor-inactiveSelectionBackground);
                border-radius: 6px;
                border: 1px solid var(--vscode-panel-border);
            }

            .section-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 12px;
                font-weight: 600;
                font-size: 14px;
            }

            .section-icon {
                font-size: 16px;
            }

            .section-content {
                font-size: 13px;
                color: var(--vscode-descriptionForeground);
            }

            .context-item {
                margin: 6px 0;
                padding-left: 20px;
            }

            .pattern-list {
                list-style: none;
                padding: 0;
                margin: 8px 0;
            }

            .pattern-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 6px 12px;
                margin: 4px 0;
                background: var(--vscode-input-background);
                border-radius: 4px;
            }

            .pattern-remove {
                cursor: pointer;
                color: var(--vscode-errorForeground);
                font-size: 16px;
            }

            .btn-small {
                padding: 4px 8px;
                font-size: 12px;
                border: 1px solid var(--vscode-button-border);
                background: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
                border-radius: 4px;
                cursor: pointer;
                margin-top: 8px;
            }

            .modal-footer {
                display: flex;
                gap: 12px;
                justify-content: flex-end;
            }

            .btn-primary,
            .btn-secondary {
                padding: 8px 16px;
                font-size: 13px;
                border-radius: 4px;
                cursor: pointer;
                border: 1px solid var(--vscode-button-border);
            }

            .btn-primary {
                background: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
            }

            .btn-secondary {
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
            }

            .confidence-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-weight: 600;
                font-size: 13px;
            }

            .confidence-high {
                background: var(--vscode-testing-iconPassed);
                color: var(--vscode-editor-background);
            }

            .confidence-medium {
                background: var(--vscode-editorWarning-foreground);
                color: var(--vscode-editor-background);
            }

            .confidence-low {
                background: var(--vscode-editorError-foreground);
                color: var(--vscode-editor-background);
            }
        </style>
        `;
    }

    /**
     * Render workspace analysis section
     */
    private renderWorkspaceSection(): string {
        const ws = this.editedContext.workspaceContext;

        return `
        <div class="context-section">
            <div class="section-header">
                <span class="section-icon">âœ“</span>
                <span>Workspace Analysis</span>
            </div>
            <div class="section-content">
                <div class="context-item">
                    <strong>Languages:</strong> ${ws.languages.join(', ')}
                </div>
                <div class="context-item">
                    <strong>Frameworks:</strong> ${ws.frameworks.join(', ')}
                </div>
                <div class="context-item">
                    <strong>Files:</strong> ${ws.filesFound.length} relevant
                </div>
            </div>
        </div>
        `;
    }

    /**
     * Render git history section
     */
    private renderGitHistorySection(): string {
        const git = this.editedContext.workspaceContext.gitCommits;

        if (git.length === 0) {
            return `
            <div class="context-section">
                <div class="section-header">
                    <span class="section-icon">âš </span>
                    <span>Git History</span>
                </div>
                <div class="section-content">
                    No git commits analyzed (no git repository or empty history)
                </div>
            </div>
            `;
        }

        const recent = git[0];
        const daysBack = this.calculateDaysBack(git);

        return `
        <div class="context-section">
            <div class="section-header">
                <span class="section-icon">âœ“</span>
                <span>Git History (Last ${daysBack} Days)</span>
            </div>
            <div class="section-content">
                <div class="context-item">
                    <strong>Commits:</strong> ${git.length} analyzed
                </div>
                <div class="context-item">
                    <strong>Recent:</strong> ${recent.message}
                </div>
                <button class="btn-small" onclick="adjustGitTimeRange()">Change Time Range</button>
            </div>
        </div>
        `;
    }

    /**
     * Render patterns section
     */
    private renderPatternsSection(): string {
        const patterns = this.editedContext.metadata.patterns;

        return `
        <div class="context-section">
            <div class="section-header">
                <span class="section-icon">âœ“</span>
                <span>Patterns Detected (${patterns.length} found)</span>
            </div>
            <div class="section-content">
                <ul class="pattern-list">
                    ${patterns.map(p => `
                        <li class="pattern-item">
                            <span>â€¢ ${p}</span>
                            <span class="pattern-remove" onclick="removePattern('${p}')">âœ•</span>
                        </li>
                    `).join('')}
                </ul>
                <button class="btn-small" onclick="addPattern()">Add Pattern</button>
            </div>
        </div>
        `;
    }

    /**
     * Render validation warnings section
     */
    private renderValidationSection(): string {
        const validation = this.editedContext.metadata.validation;
        const warnings: string[] = [];

        if (!validation.filesExist) warnings.push('Some files do not exist');
        if (!validation.dependenciesMet) warnings.push('Dependencies not met');
        if (!validation.taskDataCurrent) warnings.push('Task data may be outdated');

        if (warnings.length === 0) {
            return ''; // No warnings, don't show section
        }

        return `
        <div class="context-section">
            <div class="section-header">
                <span class="section-icon">âš </span>
                <span>Validation Warnings (${warnings.length})</span>
            </div>
            <div class="section-content">
                ${warnings.map(w => `
                    <div class="context-item">
                        â€¢ ${w}
                        <button class="btn-small" onclick="overrideWarning('${w}')">Override</button>
                    </div>
                `).join('')}
            </div>
        </div>
        `;
    }

    /**
     * Render confidence score section
     */
    private renderConfidenceSection(): string {
        const confidence = this.editedContext.metadata.confidence;
        const badgeClass = `confidence-${confidence.level}`;

        return `
        <div class="context-section">
            <div class="section-header">
                <span class="section-icon">ðŸ“Š</span>
                <span>Confidence Score</span>
            </div>
            <div class="section-content">
                <div class="context-item">
                    <span class="confidence-badge ${badgeClass}">
                        ${confidence.level.toUpperCase()} (${confidence.score}%)
                    </span>
                </div>
            </div>
        </div>
        `;
    }

    /**
     * Add pattern to context
     */
    async addPattern(patternId: string): Promise<boolean> {
        if (this.editedContext.metadata.patterns.includes(patternId)) {
            return false; // Already exists
        }

        this.editedContext.metadata.patterns.push(patternId);
        return true;
    }

    /**
     * Remove pattern from context
     */
    async removePattern(patternId: string): Promise<boolean> {
        const index = this.editedContext.metadata.patterns.indexOf(patternId);
        if (index === -1) {
            return false; // Not found
        }

        this.editedContext.metadata.patterns.splice(index, 1);
        return true;
    }

    /**
     * Override validation warning
     */
    async overrideValidation(warningType: string): Promise<void> {
        if (!this.editedContext.metadata.validationOverrides) {
            this.editedContext.metadata.validationOverrides = [];
        }

        this.editedContext.metadata.validationOverrides.push(warningType);
    }

    /**
     * Adjust git time range
     */
    async adjustGitTimeRange(days: number): Promise<void> {
        this.editedContext.workspaceContext.gitTimeRange = days;
    }

    /**
     * Get updated context (with user edits)
     */
    getUpdatedContext(): EnhancementContext {
        return this.editedContext;
    }

    /**
     * Handle proceed button
     */
    async handleProceed(): Promise<void> {
        if (this.proceedCallback) {
            this.proceedCallback(this.editedContext);
        }
    }

    /**
     * Handle cancel button
     */
    async handleCancel(): Promise<void> {
        if (this.cancelCallback) {
            this.cancelCallback();
        }
    }

    /**
     * Set proceed callback
     */
    onProceed(callback: (context: EnhancementContext) => void): void {
        this.proceedCallback = callback;
    }

    /**
     * Set cancel callback
     */
    onCancel(callback: () => void): void {
        this.cancelCallback = callback;
    }

    // Helper methods

    private getButtonTypeName(): string {
        const names: Record<string, string> = {
            'task': 'Start This Task',
            'bug': 'Bug Report',
            'feature': 'Feature Request',
            'code_analyzer': 'Code Analyzer',
            'sprint_planner': 'Sprint Planner',
            'general': 'General Enhancement'
        };
        return names[this.context.type] || this.context.type;
    }

    private calculateDaysBack(commits: Array<{ date: string }>): number {
        if (commits.length === 0) return 0;

        const oldest = commits[commits.length - 1].date;
        const oldestDate = new Date(oldest);
        const now = new Date();
        const diffMs = now.getTime() - oldestDate.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        return diffDays || 30; // Default 30 if can't calculate
    }
}
```

---

## Step 4: Integration with voicePanel (GREEN Phase)

**File:** `vscode-lumina/src/commands/voicePanel.ts`

**Add context preview integration:**

```typescript
import { ContextPreviewModal } from '../components/ContextPreviewModal';

/**
 * Show context preview modal
 *
 * Called after context gathering, before AI enhancement
 * Returns true if user clicked Proceed, false if cancelled
 */
private async showContextPreview(context: EnhancementContext): Promise<boolean> {
    return new Promise((resolve) => {
        const modal = new ContextPreviewModal(context);

        modal.onProceed((updatedContext) => {
            // User clicked Proceed - update context with edits
            Object.assign(context, updatedContext);
            this.hideModal();
            resolve(true);
        });

        modal.onCancel(() => {
            // User clicked Cancel - abort enhancement
            this.hideModal();
            resolve(false);
        });

        // Render modal in webview
        this.webviewPanel?.webview.postMessage({
            command: 'showContextPreview',
            html: modal.render()
        });
    });
}

/**
 * Modified enhancement workflow with context preview
 */
async handleEnhancePrompt(buttonType: string, formData: any): Promise<void> {
    try {
        // Step 1: Build context (existing logic)
        const context = await this.buildContext(buttonType, formData);

        // Step 2: Show context preview modal (NEW)
        const proceed = await this.showContextPreview(context);

        if (!proceed) {
            vscode.window.showInformationMessage('Enhancement cancelled');
            return;
        }

        // Step 3: Enhance with AI (existing logic, now uses edited context)
        const enhancedPrompt = await this.aiEnhancementService.enhance(context);

        // Step 4: Display result (existing logic)
        this.displayEnhancedPrompt(enhancedPrompt);

    } catch (error) {
        console.error('[VoicePanel] Enhancement failed:', error);
        vscode.window.showErrorMessage(`Enhancement failed: ${error.message}`);
    }
}
```

---

## Step 5: Validation & Testing

### Run Tests (Expected to PASS - GREEN Phase)

```bash
cd vscode-lumina
npm run compile
npm test -- --grep "ContextPreviewModal|Context Preview Integration"
```

**Expected Output:**
```
ContextPreviewModal
  Workspace analysis section
    âœ“ should display languages with percentages (34ms)
    âœ“ should display frameworks (28ms)
    âœ“ should display file count (31ms)
  Git history section
    âœ“ should display commit count (29ms)
    âœ“ should display recent commit message (26ms)
    âœ“ should show time range (days back) (22ms)
  Patterns section
    âœ“ should display detected patterns (27ms)
    âœ“ should show pattern count (23ms)
  Validation warnings section
    âœ“ should display warnings if validation fails (35ms)
    âœ“ should NOT show warnings section if all validation passes (24ms)
  Confidence score section
    âœ“ should display confidence level and score (21ms)
  Add pattern
    âœ“ should add pattern to context when user selects (38ms)
    âœ“ should NOT add duplicate pattern (29ms)
  Remove pattern
    âœ“ should remove pattern from context when user clicks (32ms)
  Override validation
    âœ“ should mark validation as overridden (27ms)
  Adjust git time range
    âœ“ should update git analysis time range (25ms)
  [Proceed] button
    âœ“ should return updated context when proceed clicked (41ms)
  [Cancel] button
    âœ“ should trigger cancel callback when cancel clicked (33ms)
  Context changes
    âœ“ should reflect all user changes in updated context (56ms)

VoicePanelCommand - Context Preview Integration
  Modal timing
    âœ“ should show context preview modal after context gathering, before AI enhancement (78ms)
    âœ“ should NOT call AI if user cancels modal (45ms)
  Context editing
    âœ“ should use edited context for AI enhancement (69ms)

23 passing (824ms)
```

**Status:** âœ… GREEN phase complete

---

## Step 6: Manual Testing

### Test Context Preview Workflow

1. Launch Extension Development Host (F5)
2. Click Ã†therLight icon â†’ Bug Report button
3. Fill form and click "Enhance"
4. **Verify context preview modal appears**
5. Review sections:

**Test Workspace Section:**
- Verify languages displayed with correct names
- Verify frameworks displayed
- Verify file count accurate

**Test Git History Section:**
- Verify commit count correct
- Verify recent commit message displayed
- Click [Change Time Range] â†’ Test date picker

**Test Patterns Section:**
- Verify detected patterns listed
- Click [Add Pattern] â†’ Select pattern â†’ Verify added
- Click âœ• on pattern â†’ Verify removed

**Test Validation Section:**
- If warnings present, verify displayed
- Click [Override] â†’ Verify warning dismissed

**Test Confidence Section:**
- Verify confidence badge shows correct level and score

**Test Proceed Button:**
- Click [Proceed]
- Verify modal closes
- Verify enhancement continues with edited context

**Test Cancel Button:**
- Start enhancement again
- Click [Cancel]
- Verify modal closes
- Verify enhancement aborted

---

## Step 7: Documentation & Commit

### Update Task Status

**File:** `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml`

Mark ENHANCE-001.8 as completed:

```toml
[tasks."ENHANCE-001.8"]
status = "completed"
```

### Commit Changes

```bash
git add vscode-lumina/src/components/ContextPreviewModal.ts
git add vscode-lumina/src/commands/voicePanel.ts
git add vscode-lumina/test/components/ContextPreviewModal.test.ts
git add vscode-lumina/test/commands/voicePanel-context-preview.test.ts
git add internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml

git commit -m "feat(ENHANCE-001.8): Implement context preview & override UI

- Add ContextPreviewModal component
- Add modal UI with 5 sections (workspace, git, patterns, validation, confidence)
- Display workspace analysis (languages, frameworks, files)
- Display git history (commits, time range, recent commit)
- Display detected patterns (add/remove buttons)
- Display validation warnings (override button)
- Display confidence score (badge with level)
- Add [Add Pattern] button with pattern picker
- Add [Remove Pattern] button (âœ• on each pattern)
- Add [Override] button for validation warnings
- Add [Change Time Range] button for git analysis
- Add [Proceed] and [Cancel] buttons
- Integrate modal into enhancement workflow (after context, before AI)
- Store edited context in enhancement metadata
- Add unit tests (70% coverage)
- Modal render < 200ms

Users can now review and edit context before enhancement:
- Verify context accuracy (transparency)
- Add missing patterns manually (control)
- Override incorrect validation warnings (flexibility)
- Adjust git analysis time range (customization)

Better trust in system, better AI output (correct context).

Closes ENHANCE-001.8"
```

---

## Success Criteria

After ENHANCE-001.8 complete:

âœ… **Users see context before enhancement (transparency)**
- Modal displays after context gathering, before AI runs

âœ… **Users can verify context accuracy**
- All 5 sections displayed (workspace, git, patterns, validation, confidence)

âœ… **Users can add missing patterns manually**
- [Add Pattern] button opens pattern picker

âœ… **Users can override incorrect validation warnings**
- [Override] button dismisses warnings

âœ… **Users can adjust git analysis time range**
- [Change Time Range] button adjusts days back

âœ… **Better trust in system (visible context)**
- Users understand what AI knows

âœ… **Better results (correct context â†’ better AI output)**
- Edited context used for enhancement

---

## Next Steps

After ENHANCE-001.8 is implemented and tests pass:

1. **ENHANCE-001.9:** Progressive Loading UI (real-time enhancement progress)

---

## Pattern References

- **Pattern-CODE-001:** Code development workflow
- **Pattern-TDD-001:** Test-driven development (RED â†’ GREEN â†’ REFACTOR)
- **Pattern-UX-001:** User experience design (transparency and control)
- **Pattern-TASK-ANALYSIS-001:** 8-step pre-task analysis
- **Pattern-GIT-001:** Git workflow integration

---

**Template Version:** MVP-003-PromptEnhancer-TaskTemplate-v1.4.3
**Generated:** 2025-01-13
**For:** ENHANCE-001.8 (Context Preview & Override UI - Show Context Before Enhancement)
