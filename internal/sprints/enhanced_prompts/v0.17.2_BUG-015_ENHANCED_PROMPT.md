# Enhanced Prompt: BUG-015 - Fix TOML Syntax Error (Markdown Code Blocks)

**Sprint**: v0.17.2 (Critical TOML Syntax Fixes & Modal Regressions)
**Task ID**: BUG-015
**Agent**: infrastructure-agent
**Template Version**: MVP-003-PromptEnhancer-TaskTemplate-v1.4.3
**Created**: 2025-01-14
**Estimated Time**: 1-2 hours
**Estimated Lines**: 100

---

## Step 0: Pre-Task Analysis (8 Steps - Answer OUT LOUD)

**CRITICAL: Complete this checklist BEFORE modifying TOML files.**

### PRE-FLIGHT CHECKLIST

**Before Modifying ACTIVE_SPRINT.toml Files:**

1. ‚úÖ **Did I read the TOML parser error message?**
   - If NO ‚Üí Check VS Code console for exact error NOW
   - Expected error: "Can't redefine existing key" at row 442
   - Error cause: Markdown code blocks (```json, ```rust) in multi-line strings

2. ‚úÖ **Did I understand why markdown code blocks break TOML?**
   - If NO ‚Üí Read NOW:
   - TOML triple-quoted strings: `'''content'''`
   - Backticks (```) inside triple quotes confuse parser
   - Parser interprets ``` as syntax, not string content
   - Result: "duplicate key" or "escape character" errors

3. ‚úÖ **Did I backup the TOML file before editing?**
   - If NO ‚Üí Backup NOW:
   ```bash
   cp internal/sprints/ACTIVE_SPRINT.toml internal/sprints/ACTIVE_SPRINT.toml.backup
   ```
   - Safety: Can restore if parser still fails after edits

4. ‚úÖ **Did I identify ALL locations with markdown code blocks?**
   - If NO ‚Üí Search NOW:
   ```bash
   grep -n '```' internal/sprints/ACTIVE_SPRINT.toml
   ```
   - Expected: Multiple matches (completion_notes, context fields)
   - Must fix ALL occurrences, not just row 442

5. ‚úÖ **Did I validate TOML syntax with parser?**
   - If NO ‚Üí Prepare validation command NOW:
   ```bash
   node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8')); console.log('‚úì TOML valid');"
   ```
   - Run AFTER each fix to verify parser accepts changes

6. ‚úÖ **Did I review Pattern-VALIDATION-001 for TOML best practices?**
   - If NO ‚Üí Read checklist in .claude/CLAUDE.md NOW
   - Key rule: No template literals (backticks with ${})
   - Key rule: No markdown code blocks (```)
   - Key rule: Always validate after edits

**If you answered NO to ANY question, STOP and complete it NOW.**

---

## Task Overview

### What Needs to Be Done

Remove all markdown code blocks (```json, ```rust, ```bash, etc.) from TOML multi-line strings and replace with plain text or indented code (no backticks).

### Why This Matters

**CRITICAL CASCADE FAILURE:**

When TOML parsing fails ‚Üí Sprint Panel cannot load tasks ‚Üí ALL modal features break:
- ‚ùå Code Analyzer modal: Cannot find tasks
- ‚ùå Sprint Planner modal: Cannot find tasks
- ‚ùå Prompt enhancement: Cannot load task context
- ‚ùå Task buttons: "Task not found" errors
- ‚ùå Sprint dropdown: "No tasks loaded"

**Impact**: 100% feature failure. Extension is completely broken for users.

**Root Cause**: TOML parser interprets backticks (```) as syntax, not string content.

### Success Criteria

After BUG-015 complete:
- ‚úÖ TOML parses successfully (no errors in console)
- ‚úÖ Sprint Panel loads tasks in dropdown
- ‚úÖ Code Analyzer modal can find and display tasks
- ‚úÖ Sprint Planner modal can find and display tasks
- ‚úÖ Task buttons work correctly (no "not found" errors)
- ‚úÖ Prompt enhancement can load task context
- ‚úÖ No "duplicate key" or "escape character" errors

---

## Implementation Plan

### Phase 1: Identify All Problematic Code Blocks (15 minutes)

**1.1 Search for All Markdown Code Blocks**
```bash
# Find all lines with markdown code blocks
grep -n '```' internal/sprints/ACTIVE_SPRINT.toml

# Example output:
# 442:```json
# 443:{
# 445:```
# 892:```rust
# 920:```bash
```

**1.2 Document Each Location**
Create a list of all occurrences:
```
Row 442: ```json (completion_notes field - BUG-002A.1)
Row 892: ```rust (context field - PROTECT-001)
Row 920: ```bash (deliverables field - CONFIG-002)
[Add all matches here]
```

**1.3 Categorize by Field Type**
```
completion_notes fields: [442, ...]
context fields: [892, ...]
deliverables fields: [920, ...]
why fields: [...]
description fields: [...]
```

**Validation:**
- [ ] All ``` occurrences identified
- [ ] Categorized by field type
- [ ] Row numbers documented

---

### Phase 2: Fix Markdown Code Blocks (30-45 minutes)

**2.1 Understand TOML String Escaping Rules**

TOML allows these string types:
```toml
# 1. Basic strings (with escapes)
key = "value with \"quotes\" and \n newlines"

# 2. Multi-line basic strings (with escapes)
key = """
Multi-line content
with "quotes" allowed
"""

# 3. Literal strings (no escapes, no backticks!)
key = 'value with no \n escapes'

# 4. Multi-line literal strings (no escapes, NO BACKTICKS!)
key = '''
Multi-line content
NO BACKTICKS ALLOWED (```)
'''
```

**CRITICAL RULE: Backticks (`) are NOT TOML syntax. They break parsing.**

**2.2 Fix Strategy: Replace Code Blocks with Plain Text**

**BEFORE (BREAKS TOML):**
```toml
completion_notes = '''
API Response (ACTUAL):
```json
{
  "success": true,
  "data": {...}
}
```
'''
```

**AFTER (VALID TOML - Option 1: Plain Text):**
```toml
completion_notes = '''
API Response (ACTUAL):

JSON Response:
{
  "success": true,
  "data": {...}
}

Note: Code block formatting removed for TOML compatibility.
'''
```

**AFTER (VALID TOML - Option 2: Indented Code):**
```toml
completion_notes = '''
API Response (ACTUAL):

    {
      "success": true,
      "data": {...}
    }

(JSON response - backticks removed for TOML parser)
'''
```

**2.3 Fix Each Occurrence Systematically**

**Step-by-step process:**
1. Read TOML file at identified row number
2. Locate the ```language marker
3. Remove opening ```language line
4. Keep the code content (indent if needed)
5. Remove closing ``` line
6. Add clarifying comment if needed (e.g., "JSON response:")
7. Validate TOML parses after EACH fix
8. Move to next occurrence

**Example fix sequence:**

**Fix 1: Row 442 (completion_notes - JSON code block)**
```bash
# Before:
# Row 442: ```json
# Row 443: {
# Row 444:   "success": true
# Row 445: }
# Row 446: ```

# After:
# Row 442: JSON Response:
# Row 443: {
# Row 444:   "success": true
# Row 445: }
# (removed closing ```)

# Validate:
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8')); console.log('‚úì Fix 1 valid');"
```

**Fix 2: Row 892 (context - Rust code block)**
```bash
# Before:
# ```rust
# fn main() {
#     println!("Hello");
# }
# ```

# After:
# Rust Code Example:
#     fn main() {
#         println!("Hello");
#     }

# Validate:
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8')); console.log('‚úì Fix 2 valid');"
```

**Validation after each fix:**
- [ ] TOML parses successfully
- [ ] No new errors introduced
- [ ] Content preserved (code still readable)
- [ ] Move to next occurrence

---

### Phase 3: Comprehensive Validation (15 minutes)

**3.1 Validate TOML Syntax**
```bash
# Test 1: TOML parser validation
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); const parsed = toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8')); console.log('‚úì TOML valid - Tasks loaded:', Object.keys(parsed.tasks).length);"

# Expected output:
# ‚úì TOML valid - Tasks loaded: 42
```

**3.2 Verify No Backticks Remain**
```bash
# Test 2: Search for remaining backticks
grep -n '`' internal/sprints/ACTIVE_SPRINT.toml

# Expected output:
# (empty - no matches)

# If matches found ‚Üí Review each:
# - Single backticks in task names/descriptions are OK
# - Triple backticks (```) must be removed
```

**3.3 Test Sprint Panel in Extension**
```
1. Launch Extension Development Host (F5 in VS Code)
2. Open √ÜtherLight sidebar
3. Click Sprint Panel dropdown
4. Verify tasks appear in list

Expected: All tasks loaded successfully
Bug criteria: "No tasks loaded" or dropdown empty ‚Üí TOML still broken
```

**3.4 Test Code Analyzer Modal**
```
1. In Extension Development Host
2. Click "Code Analyzer" button
3. Verify modal opens with task list

Expected: Modal opens, tasks selectable
Bug criteria: Modal fails or "Task not found" ‚Üí TOML still broken
```

**3.5 Test Sprint Planner Modal**
```
1. In Extension Development Host
2. Click "Sprint Planner" button
3. Verify modal opens with sprint structure

Expected: Modal displays sprint phases and tasks
Bug criteria: Modal fails to open ‚Üí TOML still broken
```

**Validation Complete:**
- [ ] TOML parser validation passes
- [ ] No backticks remaining (grep search clean)
- [ ] Sprint Panel loads tasks
- [ ] Code Analyzer modal opens
- [ ] Sprint Planner modal opens
- [ ] No console errors

---

### Phase 4: Documentation and Prevention (10 minutes)

**4.1 Document Changes in Commit Message**
```
fix(toml): Remove markdown code blocks breaking TOML parser (BUG-015)

WHAT: Removed all markdown code blocks (```json, ```rust, etc.) from TOML multi-line strings

WHY:
- TOML parser interprets backticks as syntax, not string content
- Error: "Can't redefine existing key" at row 442
- Cascade failure: Sprint Panel cannot load ‚Üí all modals break

HOW:
- Searched for all ``` occurrences in ACTIVE_SPRINT.toml
- Replaced with plain text or indented code (no backticks)
- Validated TOML syntax after each fix

IMPACT:
- ‚úÖ Sprint Panel loads tasks successfully
- ‚úÖ Code Analyzer modal works
- ‚úÖ Sprint Planner modal works
- ‚úÖ Prompt enhancement restored
- ‚úÖ No parser errors

FIXES CHANGED:
- Row 442: JSON code block (completion_notes)
- Row 892: Rust code block (context)
- [List all fixes]

VALIDATION:
- ‚úÖ TOML parses successfully
- ‚úÖ No backticks remaining
- ‚úÖ All modals functional
- ‚úÖ No console errors

TASK: BUG-015 (Sprint v0.17.2)
AGENT: infrastructure-agent
TIME: 1-2 hours
```

**4.2 Update Pre-Flight Checklist (CLAUDE.md)**

Add to `.claude/CLAUDE.md` (if not already present):
```markdown
### Before Modifying ACTIVE_SPRINT.toml:

4. ‚úÖ **Did I check for markdown code blocks?**
   - Search for: backticks (```)
   - If found ‚Üí Replace with plain text or indented code
   - Example: ```json ‚Üí "JSON Response:"
   - TOML parser does NOT support markdown syntax
```

**4.3 Add TOML Validation to Pre-Commit Hook**

Consider adding to `scripts/validate-sprint-schema.js`:
```javascript
// Check for problematic backticks in TOML strings
function validateNoMarkdownCodeBlocks(tomlContent) {
  const lines = tomlContent.split('\n');
  const issues = [];

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('```')) {
      issues.push({
        line: i + 1,
        issue: 'Markdown code block (```) found in TOML - will break parser',
        fix: 'Replace with plain text or indented code (no backticks)'
      });
    }
  }

  return issues;
}
```

**Documentation Complete:**
- [ ] Commit message written
- [ ] Pre-flight checklist updated
- [ ] Prevention mechanism considered
- [ ] Future developers warned

---

## Validation Checklist

**After executing BUG-015, verify:**

### TOML Syntax Validation
- [ ] Parser validation passes: `node -e "require('@iarna/toml').parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8'))"`
- [ ] No "duplicate key" errors in console
- [ ] No "escape character" errors in console
- [ ] No backticks remain: `grep -c '```' internal/sprints/ACTIVE_SPRINT.toml` returns 0

### Extension Functionality
- [ ] Sprint Panel dropdown shows tasks
- [ ] Sprint Panel dropdown has correct task count (not "No tasks loaded")
- [ ] Code Analyzer modal opens successfully
- [ ] Code Analyzer modal shows task list
- [ ] Sprint Planner modal opens successfully
- [ ] Sprint Planner modal displays sprint structure
- [ ] Task buttons work (no "Task not found" errors)
- [ ] Prompt enhancement loads task context

### Console Verification
- [ ] No TOML parser errors in VS Code Output panel
- [ ] No Sprint Panel errors in VS Code Output panel
- [ ] No modal rendering errors in Developer Tools console
- [ ] SprintLoader.loadSprint() succeeds (check logs)

### Manual Testing
- [ ] Extension Development Host (F5) launches without errors
- [ ] All sidebar panels render correctly
- [ ] All modals accessible from UI buttons
- [ ] Task data loads in modals (not empty/undefined)

---

## Expected Outcome

**After BUG-015 completion:**

1. **TOML File Clean:**
   - No markdown code blocks (```) in multi-line strings
   - All code examples formatted as plain text or indented code
   - TOML parser validation passes

2. **Sprint Panel Restored:**
   - Tasks load successfully from ACTIVE_SPRINT.toml
   - Dropdown shows correct task count
   - No "No tasks loaded" errors

3. **Modals Functional:**
   - Code Analyzer modal opens and displays tasks
   - Sprint Planner modal opens and displays sprint structure
   - Task buttons trigger correct behavior

4. **Prompt Enhancement Working:**
   - Enhanced prompts can load task context from TOML
   - "Start This Task" feature works
   - Task metadata accessible to AI

5. **No Errors:**
   - Console clean (no TOML parser errors)
   - No cascade failures to dependent features
   - Extension fully functional

---

## Pattern References

**Workflow Protocols:**
- **Pattern-VALIDATION-001**: Pre-flight checklist for TOML modifications
- **Pattern-TRACKING-001**: Sprint TOML status management
- **Pattern-CODE-001**: Code development workflow (for prevention mechanisms)

**Quality Assurance:**
- **Pattern-TDD-001**: Test-driven approach (validation after each fix)

**Documentation:**
- **Pattern-DOCS-001**: Documentation philosophy (update pre-flight checklist)

**Historical Bugs:**
- **2025-11-03**: Wrong TOML format (2 hours debugging)
  - ‚úÖ Prevention: Pre-flight checklist validation
- **BUG-015**: Markdown code blocks break parser (CASCADE FAILURE)
  - ‚úÖ Prevention: No backticks in TOML strings
- **BUG-016**: Template literals break parser (CRITICAL)
  - ‚úÖ Prevention: Use string concatenation, not template literals

---

## TDD Approach

**Test 1: TOML Parser Validation**
```bash
# RED: Current state (parser fails)
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8'));"
# Expected: Error: Can't redefine existing key

# GREEN: After fixes (parser succeeds)
node -e "const toml = require('@iarna/toml'); const fs = require('fs'); toml.parse(fs.readFileSync('internal/sprints/ACTIVE_SPRINT.toml', 'utf-8')); console.log('‚úì TOML valid');"
# Expected: ‚úì TOML valid

# REFACTOR: Add pre-commit validation
```

**Test 2: No Backticks Remaining**
```bash
# RED: Current state (backticks present)
grep -c '```' internal/sprints/ACTIVE_SPRINT.toml
# Expected: 12 (multiple code blocks)

# GREEN: After fixes (no backticks)
grep -c '```' internal/sprints/ACTIVE_SPRINT.toml
# Expected: 0

# REFACTOR: Add automated check to pre-commit hook
```

**Test 3: Sprint Panel Loads Tasks**
```
# RED: Current state (no tasks loaded)
1. Launch Extension Development Host (F5)
2. Open Sprint Panel
3. Check dropdown
Expected: "No tasks loaded" or empty dropdown

# GREEN: After fixes (tasks loaded)
1. Launch Extension Development Host (F5)
2. Open Sprint Panel
3. Check dropdown
Expected: 42 tasks visible in dropdown

# REFACTOR: Add automated E2E test (future)
```

**Test 4: Code Analyzer Modal Opens**
```
# RED: Current state (modal fails)
1. Click Code Analyzer button
Expected: Error notification or modal failure

# GREEN: After fixes (modal opens)
1. Click Code Analyzer button
Expected: Modal opens with task list

# REFACTOR: Add modal integration test
```

**Test 5: Prompt Enhancement Works**
```bash
# RED: Current state (cannot load task context)
1. Click "Start This Task" on any task
Expected: "Task not found" error

# GREEN: After fixes (loads context)
1. Click "Start This Task" on any task
Expected: Enhanced prompt generated with task context

# REFACTOR: Add automated test for TaskPromptExporter
```

---

## Error Scenarios and Recovery

### Error 1: TOML Still Fails After Fix
```
Symptom: Parser still throws error after removing code blocks
Cause: Missed occurrence or different syntax error

Recovery:
1. Check exact error message and row number
2. Read TOML file at error row
3. Look for other escape characters (backticks, unescaped quotes)
4. Validate each field independently
5. Binary search: comment out sections until parser succeeds
```

### Error 2: Tasks Not Loading After Fix
```
Symptom: TOML parses but Sprint Panel shows "No tasks loaded"
Cause: Broken task structure or field validation failing

Recovery:
1. Check SprintSchemaValidator.ts for validation rules
2. Verify all tasks have required fields (id, name, status, phase, agent)
3. Check for circular dependencies
4. Validate task IDs match section keys ([tasks.BUG-015] ‚Üí id = "BUG-015")
```

### Error 3: Modal Still Broken After Fix
```
Symptom: TOML parses and tasks load, but modals fail
Cause: Different root cause (not TOML syntax)

Recovery:
1. Check browser console for JavaScript errors
2. Verify message handlers exist (Code Analyzer, Sprint Planner)
3. Test modal rendering with minimal task data
4. May be separate bug (not BUG-015)
```

### Error 4: Content Lost During Fix
```
Symptom: Code examples deleted or corrupted
Cause: Overly aggressive editing

Recovery:
1. Restore from backup: cp ACTIVE_SPRINT.toml.backup ACTIVE_SPRINT.toml
2. Re-apply fixes more carefully
3. Keep code content, only remove ``` markers
4. Preserve indentation and structure
```

---

## Sprint TOML Context

**Task Details:** `internal/sprints/ACTIVE_SPRINT_v0.17.2_BUG_FIXES.toml:46-121`

```toml
[tasks.BUG-015]
id = "BUG-015"
name = "Fix TOML syntax error at row 442 (markdown code blocks)"
status = "pending"
phase = "toml-syntax-fixes"
agent = "infrastructure-agent"
estimated_time = "1-2 hours"
estimated_lines = 100
dependencies = []
```

**Sprint Context:**
- Sprint: v0.17.2 (Critical TOML Syntax Fixes & Modal Regressions)
- Priority: PHASE 0 - CRITICAL BLOCKER (must fix first)
- Severity: CRITICAL - Cascade failure to all extension features
- Root Cause: Markdown code blocks (```) in TOML multi-line strings
- Impact: 100% feature failure (Sprint Panel, modals, prompt enhancement)

**Related Bugs:**
- BUG-016: Template literal escapes (backticks with ${})
- Both must be fixed for extension to function

---

## Commit Message Template

```
fix(toml): Remove markdown code blocks breaking TOML parser (BUG-015)

WHAT: Removed all markdown code blocks (```json, ```rust, etc.) from TOML multi-line strings

WHY:
- TOML parser interprets backticks (```) as syntax, not string content
- Error: "Can't redefine existing key" at row 442
- CASCADE FAILURE: Sprint Panel cannot load ‚Üí all modals break
- Impact: 100% feature failure (Code Analyzer, Sprint Planner, prompt enhancement)

HOW:
- Searched for all ``` occurrences in ACTIVE_SPRINT.toml
- Replaced with plain text descriptions or indented code
- Validated TOML syntax after each fix
- Tested Sprint Panel, modals, and prompt enhancement

FIXES APPLIED:
- Row 442: JSON code block (completion_notes) ‚Üí Plain text
- Row 892: Rust code block (context) ‚Üí Indented code
- Row 920: Bash code block (deliverables) ‚Üí Plain text
- [Total: X occurrences fixed]

DELIVERABLES:
- ‚úÖ TOML parses successfully (no parser errors)
- ‚úÖ Sprint Panel loads 42 tasks
- ‚úÖ Code Analyzer modal opens
- ‚úÖ Sprint Planner modal opens
- ‚úÖ Prompt enhancement works
- ‚úÖ No backticks remaining in TOML

VALIDATION:
- ‚úÖ TOML parser validation passes
- ‚úÖ grep '```' returns 0 matches
- ‚úÖ Sprint Panel functional
- ‚úÖ All modals functional
- ‚úÖ No console errors

PREVENTION:
- Updated pre-flight checklist (CLAUDE.md)
- Added backtick validation to checklist
- Documented TOML syntax rules

TASK: BUG-015 (Sprint v0.17.2)
AGENT: infrastructure-agent
TIME: 1-2 hours
SEVERITY: CRITICAL (cascade failure fixed)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

**Next Steps After BUG-015:**
1. Mark BUG-015 as completed in Sprint TOML
2. Immediately start BUG-016 (template literal escapes - same severity)
3. Test all modals comprehensively
4. Verify no regressions in related features
5. Update CHANGELOG.md with critical bug fix
