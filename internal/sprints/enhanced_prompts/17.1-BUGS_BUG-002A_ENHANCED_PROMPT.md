# Enhanced Task Prompt: BUG-002A

**Generated**: 2025-11-12
**Sprint**: v0.17.1 Bug Fixes
**Task ID**: BUG-002A
**Status**: Pending
**Agent**: tauri-desktop-agent
**Skill**: None (manual implementation)
**Enhanced Prompt**: internal/sprints/enhanced_prompts/BUG-002A_ENHANCED_PROMPT.md
**Template**: MVP-003-PromptEnhancer-TaskTemplate-v1.0

---

## Task Overview

**Name**: Migrate TranscriptionResponse struct from USD to tokens

**Why**: CRITICAL CORRECTION from consensus validation - Desktop app expects USD-based response (cost_usd, balance_remaining_usd) but the website API returns token-based response (tokens_used, tokens_balance). This causes deserialization failures.

**Current State (BROKEN)**:
```rust
// products/lumina-desktop/src-tauri/src/transcription.rs:33-40
struct TranscriptionResponse {
    text: String,
    cost_usd: f64,              // ❌ API doesn't return this
    balance_remaining_usd: f64, // ❌ API doesn't return this
    duration_seconds: u64,
    message: String,            // ❌ API doesn't return this
}
```

**Required State (CORRECT)**:
```rust
struct TranscriptionResponse {
    success: bool,              // ✅ API returns this
    text: String,               // ✅ Correct
    duration_seconds: u64,      // ✅ Correct
    tokens_used: u64,           // ✅ API returns this (not cost_usd)
    tokens_balance: u64,        // ✅ API returns this (not balance_remaining_usd)
    transaction_id: String,     // ✅ API returns this (not message)
}
```

**Impact**: All transcription API calls fail with deserialization errors. Desktop app cannot transcribe voice input.

**Severity**: CRITICAL - Blocks all voice transcription functionality

---

## Context Gathered

### Git Status
- **Branch**: feature/v0.17.2-bug-fixes
- **Status**: Clean (1 completed task: BUG-001)
- **Ready for**: BUG-002A implementation

### Related Files
1. `products/lumina-desktop/src-tauri/src/transcription.rs:33-40` - TranscriptionResponse struct (MUST UPDATE)
2. `products/lumina-desktop/src-tauri/src/transcription.rs:198-250` - handle_transcribe_audio() caller (MUST UPDATE)
3. `products/lumina-desktop/src/components/TokenBalance.svelte` - UI display (MUST UPDATE)
4. `website/app/api/transcription/route.ts` - API contract (REFERENCE ONLY - validates correct format)

### Workspace Structure
- **Desktop App**: Tauri + Rust backend (`src-tauri/`) + Svelte frontend (`src/`)
- **API**: Next.js (website submodule, read-only reference)
- **Test Strategy**: Rust unit tests + integration tests with mock API responses

### Patterns Referenced
- **Pattern-CODE-001**: Code development workflow (8-step analysis → TDD → implementation)
- **Pattern-TDD-001**: Test-driven development (RED → GREEN → REFACTOR)
- **Pattern-TRACKING-001**: Use TodoWrite to track progress

---

## Validation Results

✅ **All files exist and accessible**
✅ **No circular dependencies** (BUG-002A has no dependencies, blocks BUG-002)
✅ **API contract validated** (website/app/api/transcription/route.ts confirms token-based response)
✅ **Rust toolchain ready** (cargo check passes on current code)
✅ **Test framework available** (Rust built-in testing)

---

## Implementation Steps (TDD Approach)

### Step 1: Read Current Struct (5 minutes)
**Tool**: Read
**File**: `products/lumina-desktop/src-tauri/src/transcription.rs`
**Focus**: Lines 33-40 (TranscriptionResponse definition)

**Goal**: Understand current struct and all usages

---

### Step 2: Write Tests FIRST - RED Phase (15 minutes)
**Tool**: Edit
**File**: `products/lumina-desktop/src-tauri/src/transcription.rs` (add test module at end)

**Test Code**:
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_deserialize_transcription_response() {
        // Simulate actual API response from website
        let json = r#"{
            "success": true,
            "text": "This is a test transcription",
            "duration_seconds": 600,
            "tokens_used": 3750,
            "tokens_balance": 996250,
            "transaction_id": "550e8400-e29b-41d4-a716-446655440000"
        }"#;

        let response: TranscriptionResponse = serde_json::from_str(json).unwrap();

        assert_eq!(response.success, true);
        assert_eq!(response.text, "This is a test transcription");
        assert_eq!(response.duration_seconds, 600);
        assert_eq!(response.tokens_used, 3750);
        assert_eq!(response.tokens_balance, 996250);
        assert_eq!(response.transaction_id, "550e8400-e29b-41d4-a716-446655440000");
    }

    #[test]
    fn test_deserialize_failure_response() {
        let json = r#"{
            "success": false,
            "error": "Insufficient tokens",
            "tokens_balance": 0
        }"#;

        let result: Result<TranscriptionResponse, _> = serde_json::from_str(json);
        // Should either deserialize with success=false, or fail gracefully
        assert!(result.is_ok() || result.is_err());
    }
}
```

**Expected Result**: Tests FAIL (RED) because struct has wrong fields

**Validation**:
```bash
cd "products/lumina-desktop/src-tauri"
cargo test transcription::tests -- --nocapture
```

---

### Step 3: Update Struct - GREEN Phase (10 minutes)
**Tool**: Edit
**File**: `products/lumina-desktop/src-tauri/src/transcription.rs:33-40`

**Old Code**:
```rust
#[derive(Debug, Deserialize)]
struct TranscriptionResponse {
    text: String,
    cost_usd: f64,
    balance_remaining_usd: f64,
    duration_seconds: u64,
    message: String,
}
```

**New Code**:
```rust
#[derive(Debug, Deserialize, Serialize)]
pub struct TranscriptionResponse {
    pub success: bool,                  // ← NEW: API success indicator
    pub text: String,                   // ← KEEP: Transcribed text
    pub duration_seconds: u64,          // ← KEEP: Audio duration
    pub tokens_used: u64,               // ← NEW: Replaces cost_usd
    pub tokens_balance: u64,            // ← NEW: Replaces balance_remaining_usd
    pub transaction_id: String,         // ← NEW: Replaces message
}
```

**Expected Result**: Tests PASS (GREEN)

**Validation**:
```bash
cargo test transcription::tests -- --nocapture
```

---

### Step 4: Update Callers (30 minutes)
**Tool**: Edit
**File**: `products/lumina-desktop/src-tauri/src/transcription.rs:198-250`

**Find All Usages**:
```bash
# Search for field accesses
rg "cost_usd|balance_remaining_usd|\.message" products/lumina-desktop/src-tauri/src/
```

**Update handle_transcribe_audio()**:

**Old Code**:
```rust
match result {
    Ok(response) => {
        let transcript_text = response.text;
        let cost = response.cost_usd;
        let balance = response.balance_remaining_usd;
        println!("Cost: ${}, Balance: ${}", cost, balance);
        println!("Message: {}", response.message);
    }
}
```

**New Code**:
```rust
match result {
    Ok(response) => {
        // Check API success indicator
        if !response.success {
            return Err("Transcription failed".into());
        }

        let transcript_text = response.text;
        let tokens = response.tokens_used;
        let balance = response.tokens_balance;

        // Update logging to use tokens instead of USD
        println!("Tokens used: {}, Balance: {} tokens", tokens, balance);
        println!("Transaction ID: {}", response.transaction_id);
    }
}
```

---

### Step 5: Update UI Display (10 minutes)
**Tool**: Edit
**File**: `products/lumina-desktop/src/components/TokenBalance.svelte`

**Search for USD references**:
```bash
rg "\$|USD|cost_usd|balance_remaining_usd" products/lumina-desktop/src/components/
```

**Update Display Logic**:
- Change "Balance: $X.XX USD" → "Balance: X tokens"
- Change "Cost: $X.XX" → "Tokens used: X"
- Remove currency formatting (no decimals needed for token counts)

**Example**:
```svelte
<!-- OLD -->
<div class="balance">${balance.toFixed(2)} USD</div>

<!-- NEW -->
<div class="balance">{balance.toLocaleString()} tokens</div>
```

---

### Step 6: Compile and Verify (5 minutes)
**Tool**: Bash
**Commands**:
```bash
cd "products/lumina-desktop/src-tauri"
cargo check
cargo build
```

**Expected Result**: No compilation errors

---

### Step 7: Run All Tests (5 minutes)
**Tool**: Bash
**Commands**:
```bash
cd "products/lumina-desktop/src-tauri"
cargo test
```

**Expected Result**: All tests pass (including new transcription tests)

---

## Acceptance Criteria Checklist

- [ ] TranscriptionResponse struct updated with 6 correct fields (success, text, duration_seconds, tokens_used, tokens_balance, transaction_id)
- [ ] Old fields removed (cost_usd, balance_remaining_usd, message)
- [ ] Tests written FIRST (RED phase completed)
- [ ] Tests pass after struct update (GREEN phase completed)
- [ ] All callers updated (handle_transcribe_audio and any other functions)
- [ ] UI components updated (TokenBalance.svelte shows tokens, not USD)
- [ ] No compilation errors (cargo check passes)
- [ ] All tests pass (cargo test passes)
- [ ] Grep search confirms no remaining USD references in codebase
- [ ] Ready for BUG-002 integration (struct matches API contract)

---

## Pre-Flight Checklist (Pattern-VALIDATION-001)

Before starting this task, answer these questions OUT LOUD:

1. ✅ **Did I read `transcription.rs` to verify current struct?**
   - If NO → Read it NOW before proceeding

2. ✅ **Did I validate the API contract from website code?**
   - If NO → Read `website/app/api/transcription/route.ts` NOW

3. ✅ **Did I write tests FIRST (RED phase)?**
   - If NO → STOP and write tests before changing struct

4. ✅ **Did I check for all usages of old fields?**
   - If NO → Run `rg "cost_usd|balance_remaining_usd|\.message"` NOW

5. ✅ **Did I update UI components to show tokens instead of USD?**
   - If NO → Search for USD references in Svelte components

---

## Error Handling

### Potential Issues

**Issue 1**: Deserialization fails due to missing fields
- **Cause**: API response doesn't match struct exactly
- **Solution**: Add `#[serde(default)]` to optional fields or use `Option<T>` for nullable fields

**Issue 2**: Compilation errors in callers
- **Cause**: Missed some usages of old field names
- **Solution**: Use `cargo check` to find all errors, update each one systematically

**Issue 3**: UI still shows USD formatting
- **Cause**: Frontend components not updated
- **Solution**: Search all Svelte files for currency formatting, replace with token formatting

**Issue 4**: Tests fail intermittently
- **Cause**: Mock API responses don't match real API exactly
- **Solution**: Copy actual API response from network logs, use that as test fixture

---

## Estimated Time Breakdown

- Step 1 (Read current code): 5 minutes
- Step 2 (Write tests - RED): 15 minutes
- Step 3 (Update struct - GREEN): 10 minutes
- Step 4 (Update callers): 30 minutes
- Step 5 (Update UI): 10 minutes
- Step 6 (Compile): 5 minutes
- Step 7 (Run tests): 5 minutes

**Total Estimated Time**: 1-2 hours

---

## Dependencies

**Blocks**: BUG-002 (needs correct struct before implementing validation flow)

**Blocked By**: None (can start immediately)

---

## Success Impact

After BUG-002A complete:

✅ TranscriptionResponse struct matches actual API contract (token-based, not USD-based)
✅ Deserialization succeeds for all transcription API calls
✅ Desktop app can successfully transcribe voice input
✅ UI displays token counts correctly (not USD amounts)
✅ Ready for BUG-002 integration (license validation flow)
✅ No more "field not found" errors in transcription service

---

## Patterns Referenced

- **Pattern-CODE-001**: Code development workflow
- **Pattern-TDD-001**: Test-driven development (RED → GREEN → REFACTOR)
- **Pattern-TRACKING-001**: Use TodoWrite to track task progress
- **Pattern-VALIDATION-001**: Pre-flight checklist enforcement

---

## Notes

- This is a **data structure migration**, not a feature addition
- **No new functionality**, just fixing broken API contract
- **TDD is critical** - tests ensure we don't break anything during migration
- **Grep is your friend** - use it to find all usages of old fields
- **UI must be updated** - users will notice if we still show USD amounts
- **This unblocks BUG-002** - can't validate licenses without working transcription

---

## Post-Completion Updates

After completing BUG-002A, the following updates should be made:

### Agent Context Files to Update
- **tauri-desktop-agent** (`internal/agents/tauri-desktop-agent.md`)
  - Add capability: "Token-based transcription API integration (migrated from USD)"
  - Update context: "Desktop app now uses tokens_used/tokens_balance fields for all transcription responses"
  - Add pattern reference: Pattern-TDD-001 (struct migration with tests)

### Skills to Update
- **No skills need updating** - This is a bug fix, not a new capability

### Documentation to Update
- **KNOWN_ISSUES.md**: Document fix for "TranscriptionResponse struct mismatch causes deserialization failures"
- **Sprint TOML**: Update BUG-002A status to "completed", add completed_date
- **CHANGELOG.md**: Add entry for v0.17.2 (at release time)

### Sprint TOML Updates
```toml
[tasks.BUG-002A]
status = "completed"
completed_date = "2025-11-XX"  # Fill in actual date
```

### Follow-up Tasks Unblocked
- **BUG-002**: License validation flow (needs working transcription struct)
- **BUG-003**: AppSettings fields (can proceed independently)

---

**Keeping the system up-to-date ensures all future tasks benefit from this work.**

---

**This enhanced prompt was generated by PromptEnhancer (MVP-003) to demonstrate the unified intelligence system for Sprint 17.1. All future "Start This Task" commands will generate prompts like this.**
