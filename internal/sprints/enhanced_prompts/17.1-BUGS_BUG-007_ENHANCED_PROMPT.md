# Enhanced Task Prompt: BUG-007

**Generated**: 2025-01-13
**Sprint**: Sprint 17.1 - Desktop Authentication & Installation Bugs
**Task ID**: BUG-007
**Status**: pending
**Agent**: tauri-desktop-agent
**Enhanced Prompt**: internal/sprints/enhanced_prompts/BUG-007_ENHANCED_PROMPT.md
**Template**: MVP-003-PromptEnhancer-TaskTemplate-v1.4.3

---

## ‚ö†Ô∏è MANDATORY: Pre-Task Analysis (Pattern-TASK-ANALYSIS-001)

**STOP. Before reading ANY code or writing ANY solution, complete this 8-step analysis OUT LOUD:**

### 8-Step Pre-Task Analysis

1. ‚úÖ **Understand the Problem**
   - What is broken? Desktop app doesn't appear in Windows Apps & Features
   - What are the symptoms? User can't find app to uninstall via standard Windows UI
   - What is the actual issue? No Windows Registry entries (portable .exe, no installer)

2. ‚úÖ **Identify Root Cause**
   - Why is it broken? tauri.conf.json missing WiX bundler configuration
   - What caused this? Default Tauri behavior is portable executable (no installer)
   - Is this a symptom of a deeper problem? Yes - entire Windows installer infrastructure missing (no MSI, no registry, no shortcuts)

3. ‚úÖ **Define Success Criteria**
   - How do I know when it's fixed?
     - Build produces .msi installer file
     - Installer appears in Windows Apps & Features after installation
     - Uninstall removes all files from AppData
     - Uninstall removes registry entries
     - Desktop shortcut created during installation (optional)
     - Start Menu shortcut appears in √ÜtherLight folder
   - What does "done" look like?
     - User downloads .msi ‚Üí Runs installer ‚Üí App appears in Apps & Features ‚Üí Can uninstall via standard Windows UI

4. ‚úÖ **List Dependencies**
   - What other tasks/files/systems does this affect?
     - Publishing workflow (must build MSI instead of portable .exe)
     - Distribution (download page should offer MSI, not just .exe)
     - Update mechanism (BUG-006 - MSI upgrades work differently)
   - What needs to be done first? None (no blocking dependencies)
   - What does this unblock? Professional Windows installation experience, easier uninstall

5. ‚úÖ **Estimate Complexity**
   - Simple fix (< 1 hour) or complex refactor (> 4 hours)? MEDIUM-COMPLEX (4-6 hours)
   - Single file or multi-file change? MULTI-FILE (4 files: tauri.conf.json, Cargo.toml, main.wxs, build-windows-installer.js)

6. ‚úÖ **Choose Approach**
   - What's the best way to solve this?
     - Use Tauri's built-in WiX bundler (Windows Installer XML)
     - Configure tauri.conf.json with WiX bundle settings
     - Create custom WiX template (main.wxs) for installer UI
     - Add WiX features to Cargo.toml
     - Create build script for automated MSI generation
     - Registry entries added automatically by WiX
   - Are there alternative approaches? Why is this one best?
     - Alternative 1: NSIS installer (more complex, less Windows-native)
     - Alternative 2: Continue with portable .exe (poor UX, doesn't meet Windows standards)
     - **Best**: WiX bundler (native Windows installer format, automatic registry entries, standard uninstall)

7. ‚úÖ **Identify Risks**
   - What could go wrong? What could break?
     - WiX build fails due to missing Windows SDK (requires wixtoolset installed)
     - Installation requires admin rights (UAC prompt may scare users)
     - Existing portable installations conflict with MSI installation
     - Update mechanism (BUG-006) may need changes for MSI upgrades
     - Code signing required for production (prevents Windows SmartScreen warnings)
   - What are the edge cases?
     - User has portable version installed, then installs MSI (two copies)
     - Upgrade from portable to MSI (uninstall portable first?)
     - Downgrade scenario (MSI to older version)
     - Silent installation for enterprise deployment

8. ‚úÖ **Plan Testing**
   - How will I validate this works?
     - Manual testing on clean Windows machine (VM recommended)
     - Install MSI ‚Üí Check Apps & Features ‚Üí Verify shortcuts ‚Üí Launch app ‚Üí Uninstall ‚Üí Verify cleanup
   - What tests need to be written? (Infrastructure task - manual testing only)
     - 9 manual test scenarios (see test_requirements in task TOML)
     - 3 automated tests (WiX build script, MSI metadata, registry template validation)

### Code Workflow Announcement (Pattern-CODE-001)

**Before starting Step 1 (Implementation), announce OUT LOUD:**

"I am about to start coding for task BUG-007. I have completed:
‚úÖ Pattern-TASK-ANALYSIS-001 (8-step pre-task analysis - see above)
‚úÖ Ready to proceed with Pattern-GIT-001 (Git status check)
‚úÖ Ready to proceed with Pattern-TDD-001 (Write tests FIRST - manual test plan)
‚úÖ Ready to proceed with Pattern-TRACKING-001 (TodoWrite tracking)

I am now proceeding with implementation."

### Edge Case Handling

**Skip this section ONLY if:**
- ‚ùå Typo fix only (comment/variable name) ‚Üí Skip analysis + announcement
- ‚ùå Documentation update (no code change) ‚Üí Skip analysis + announcement

**MUST complete this section if:**
- ‚úÖ Bug fix ‚Üí MUST complete analysis + announcement + write test first
- ‚úÖ New feature ‚Üí MUST complete analysis + announcement + write test first
- ‚úÖ Refactoring ‚Üí MUST complete analysis + announcement + existing tests must pass
- ‚úÖ Experimental code ‚Üí MUST complete analysis + announcement + mark as "spike"

---

**Full Pattern References**:
- Pattern-TASK-ANALYSIS-001: Complete 8-step protocol in pattern file
- Pattern-CODE-001: Complete workflow including git checks, TDD, tracking

**If you skip this section, you WILL break something. This is NOT optional.**

---

## Task Overview

**Name**: Add desktop app to Windows Registry (Apps & Features visibility)

**Why**: User-reported issue: "I've gone to try to uninstall the desktop app and I can't even find it to uninstall it in my Apps and Features. It is in my system tray, it is in my program start menu, but it is not in Apps & Features to uninstall."

Current behavior: Desktop app installs but doesn't register with Windows Registry.
Expected behavior: Desktop app appears in Windows Settings > Apps & Features for easy uninstall.

Impact: Users cannot uninstall app using standard Windows UI, poor UX.
Severity: MEDIUM - Workaround exists (manual file deletion), but violates Windows best practices.

**Current State (BROKEN)**:
- File: `products/lumina-desktop/src-tauri/tauri.conf.json` (missing WiX bundler config)
- File: `products/lumina-desktop/src-tauri/Cargo.toml` (missing WiX features)
- Issue: Portable .exe produced (no installer, no registry entries)

**Required State (CORRECT)**:
- File: `products/lumina-desktop/src-tauri/tauri.conf.json` (WiX bundler configured)
- File: `products/lumina-desktop/src-tauri/Cargo.toml` (WiX features added)
- File: `products/lumina-desktop/src-tauri/wix/main.wxs` (NEW - WiX installer template)
- File: `scripts/build-windows-installer.js` (NEW - automated MSI build script)
- Fix: MSI installer produced with registry entries, appears in Apps & Features

**Impact**: Users can uninstall via standard Windows UI, professional installation experience

**Severity**: MEDIUM

---

## Context Gathered

### Git Status
- **Branch**: feature/v0.17.2-bug-fixes
- **Status**: Clean (no uncommitted changes)
- **Ready for**: BUG-007 implementation

### Sprint TOML
- **File**: `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml`
- **Task Entry**: Lines 1700-1812
- **Management**: Use `/sprint-task-lifecycle` skill (see Pattern-TRACKING-001)

### Related Files

1. **products/lumina-desktop/src-tauri/tauri.conf.json** (MUST UPDATE)
   - Current state: Missing WiX bundler configuration
   - Required changes: Add `tauri.bundle.windows` section with WiX configuration
   - Reference: https://tauri.app/v1/guides/distribution/windows/

2. **products/lumina-desktop/src-tauri/Cargo.toml** (MUST UPDATE)
   - Current state: Missing WiX features
   - Required changes: Add `tauri = { version = "1.x", features = ["...", "wix"] }`

3. **products/lumina-desktop/src-tauri/wix/main.wxs** (CREATE NEW)
   - Purpose: WiX installer template (XML)
   - Defines: UI, registry entries, shortcuts, install location
   - Standard WiX structure with Tauri placeholders

4. **scripts/build-windows-installer.js** (CREATE NEW)
   - Purpose: Automated MSI build script
   - Called by: Publishing workflow
   - Output: lumina-desktop-{version}-x64.msi

### Windows Registry Requirements

**Registry Location**: `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall\{GUID}`

**Required Fields**:
- `DisplayName`: "√ÜtherLight Desktop"
- `DisplayVersion`: "0.17.2"
- `Publisher`: "√ÜtherLight AI"
- `UninstallString`: "msiexec.exe /x {GUID}"
- `InstallLocation`: "C:\Program Files\√ÜtherLight Desktop"
- `DisplayIcon`: "{InstallLocation}\lumina-desktop.exe,0"
- `EstimatedSize`: Size in KB

### Patterns Referenced

- **Pattern-TASK-ANALYSIS-001**: 8-step pre-task analysis (MANDATORY)
- **Pattern-CODE-001**: Code workflow + announcement (MANDATORY)
- **Pattern-TRACKING-001**: Task tracking + Sprint TOML lifecycle
- **Pattern-GIT-001**: Git workflow integration
- **Pattern-TDD-001**: Test-driven development (manual testing for Windows-specific)
- **Pattern-VALIDATION-001**: Pre-flight checklist enforcement
- **Pattern-TESTING-001**: Manual testing protocols

---

## Pre-Flight Checklist

**STOP. Complete Pattern-VALIDATION-001 checklist OUT LOUD:**

‚úÖ Did I read target files first? (Never edit without reading)
‚úÖ Did I verify format/structure? (Read Tauri docs on WiX bundling, existing tauri.conf.json)
‚úÖ Did I check Sprint TOML format? (SprintLoader.ts:292-333)
‚úÖ Did I validate dependencies? (WiX Toolset must be installed on Windows build machine)

**Full Checklist**: Pattern-VALIDATION-001 (4 categories, 15+ questions)

**Automated Validation**: Pre-commit hooks run 8 validators automatically

---

## Implementation Steps (TDD Approach)

**Patterns**: Pattern-TDD-001 (Manual test plan), Pattern-GIT-001 (Git workflow), Pattern-TRACKING-001 (Sprint TOML lifecycle)

**REMINDER**: If you haven't completed Section 0 (Pre-Task Analysis + Code Workflow Announcement), STOP and complete it NOW.

---

### Step 0: Git Status + Sprint TOML Update (2 min)

**Update Sprint Status**:
```bash
/sprint-task-lifecycle start BUG-007
```

**Fallback** (if skill unavailable): Follow Pattern-TRACKING-001 manual process

**Check Git Status**:
```bash
git status
git branch --show-current
```

**Goal**: Status = "in_progress", on feature/v0.17.2-bug-fixes branch, clean working tree

---

### Step 1: Research WiX Bundler Requirements (20 min)
**Tool**: Read + WebFetch
**Files**: Tauri docs + existing tauri.conf.json

**Goal**: Understand WiX bundler requirements and current configuration

**Actions**:
1. Read `products/lumina-desktop/src-tauri/tauri.conf.json` (check current bundle config)
2. Review Tauri WiX documentation (https://tauri.app/v1/guides/distribution/windows/)
3. Review WiX Toolset documentation (https://wixtoolset.org/)
4. Identify required fields for tauri.conf.json bundle.windows section

**Expected Findings**:
- Current tauri.conf.json likely has NO `bundle.windows` section
- WiX Toolset must be installed on build machine (v3.11+ recommended)
- Required: Bundle identifier (GUID), product name, manufacturer, license
- Optional: Custom WiX template (main.wxs), installer UI customization

---

### Step 2: Write Manual Test Plan FIRST (30 min)
**Pattern**: Pattern-TDD-001 (Manual testing for Windows-specific features)
**Tool**: Write
**File**: `products/lumina-desktop/tests/manual/WINDOWS_INSTALLER_TEST.md` (CREATE NEW)

**Goal**: Document 9 manual test scenarios for Windows installer

**Test Plan Template**:

```markdown
# Windows Installer Manual Test Plan (BUG-007)

**Date**: 2025-01-13
**Tester**: [Name]
**Windows Version**: [e.g., Windows 11 23H2]
**Test Environment**: Clean VM (no previous √ÜtherLight installation)

---

## Prerequisites

- [ ] WiX Toolset 3.11+ installed on build machine
- [ ] Windows 10/11 VM with no previous √ÜtherLight installation
- [ ] Admin rights on test machine

---

## Test 1: Build MSI Installer Successfully

**Steps**:
1. Run `npm run build:msi` (or equivalent build script)
2. Check `products/lumina-desktop/src-tauri/target/release/bundle/msi/` directory

**Expected Result**:
- ‚úÖ MSI file created: `lumina-desktop-0.17.2-x64.msi`
- ‚úÖ File size > 10 MB (reasonable size for desktop app)
- ‚úÖ No build errors in console

**Actual Result**: [ ]

---

## Test 2: Install via MSI on Clean Windows Machine

**Steps**:
1. Copy MSI file to clean Windows VM
2. Double-click MSI file
3. Follow installer wizard (default options)
4. Wait for installation to complete

**Expected Result**:
- ‚úÖ UAC prompt appears (requires admin elevation)
- ‚úÖ Installer UI shows √ÜtherLight branding
- ‚úÖ Installation completes without errors
- ‚úÖ Success message shown

**Actual Result**: [ ]

---

## Test 3: Verify App Appears in Apps & Features

**Steps**:
1. Open Windows Settings
2. Navigate to Apps > Installed apps (Windows 11) or Apps & Features (Windows 10)
3. Search for "√ÜtherLight"

**Expected Result**:
- ‚úÖ "√ÜtherLight Desktop" appears in list
- ‚úÖ Version shown: "0.17.2"
- ‚úÖ Publisher shown: "√ÜtherLight AI"
- ‚úÖ Install date shown
- ‚úÖ Size shown (estimated)

**Actual Result**: [ ]

---

## Test 4: Verify Desktop Shortcut Created (Optional)

**Steps**:
1. Check desktop for "√ÜtherLight Desktop" shortcut

**Expected Result**:
- ‚úÖ Shortcut present if user selected option during install
- ‚úÖ Shortcut icon correct (√ÜtherLight logo)
- ‚úÖ Shortcut target: "C:\Program Files\√ÜtherLight Desktop\lumina-desktop.exe"

**Actual Result**: [ ]

---

## Test 5: Verify Start Menu Shortcut Exists

**Steps**:
1. Open Start Menu
2. Search for "√ÜtherLight"
3. Check Start Menu folder structure

**Expected Result**:
- ‚úÖ "√ÜtherLight Desktop" appears in Start Menu
- ‚úÖ Located in "√ÜtherLight" folder (not root)
- ‚úÖ Icon correct

**Actual Result**: [ ]

---

## Test 6: Launch App via Shortcut

**Steps**:
1. Double-click Start Menu shortcut
2. Wait for app to launch

**Expected Result**:
- ‚úÖ App launches without errors
- ‚úÖ System tray icon appears
- ‚úÖ No UAC prompt (app runs as normal user)
- ‚úÖ App functional (can open settings, etc.)

**Actual Result**: [ ]

---

## Test 7: Uninstall via Apps & Features

**Steps**:
1. Open Windows Settings > Apps & Features
2. Find "√ÜtherLight Desktop"
3. Click "Uninstall"
4. Confirm uninstall
5. Wait for uninstall to complete

**Expected Result**:
- ‚úÖ Uninstall confirmation dialog shown
- ‚úÖ Uninstall completes without errors
- ‚úÖ Success message shown
- ‚úÖ App removed from Apps & Features list

**Actual Result**: [ ]

---

## Test 8: Verify All Files Removed from AppData

**Steps**:
1. After uninstall, open File Explorer
2. Navigate to `C:\Users\<USERNAME>\AppData\Local\lumina-desktop`
3. Check if directory exists

**Expected Result**:
- ‚úÖ Directory removed (or only user data remains if configured)
- ‚úÖ No executable files left
- ‚úÖ No DLL files left

**Actual Result**: [ ]

**Note**: User data (settings.json, logs) may be preserved if configured. Verify this is intentional.

---

## Test 9: Verify Registry Entries Removed

**Steps**:
1. After uninstall, open Registry Editor (regedit.exe)
2. Navigate to `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall`
3. Search for "√ÜtherLight" or GUID

**Expected Result**:
- ‚úÖ No √ÜtherLight registry entries found
- ‚úÖ Uninstall registry key removed

**Actual Result**: [ ]

---

## Automated Tests (where possible)

### Test A: WiX Build Script Succeeds

```bash
node scripts/build-windows-installer.js
# Expected: Exit code 0, MSI file created
```

### Test B: MSI File Generated with Correct Metadata

```powershell
# Get MSI properties
$msi = "lumina-desktop-0.17.2-x64.msi"
$installer = New-Object -ComObject WindowsInstaller.Installer
$database = $installer.GetType().InvokeMember("OpenDatabase", "InvokeMethod", $null, $installer, @($msi, 0))

# Check ProductName
$view = $database.GetType().InvokeMember("OpenView", "InvokeMethod", $null, $database, ("SELECT Value FROM Property WHERE Property='ProductName'"))
$view.GetType().InvokeMember("Execute", "InvokeMethod", $null, $view, $null)
$record = $view.GetType().InvokeMember("Fetch", "InvokeMethod", $null, $view, $null)
$productName = $record.GetType().InvokeMember("StringData", "GetProperty", $null, $record, 1)

# Expected: "√ÜtherLight Desktop"
```

### Test C: Registry Entry Template Validates Against Schema

```bash
# Validate WiX XML schema
xmllint --schema wix.xsd products/lumina-desktop/src-tauri/wix/main.wxs
# Expected: No validation errors
```

---

## Test Summary

**Total Tests**: 9 manual + 3 automated
**Passed**: [ ]
**Failed**: [ ]
**Blocked**: [ ]

**Critical Issues Found**: [ ]

**Sign-off**: [ ] Ready for production
```

**Expected Result**: Manual test plan documented (used for Step 9 validation)

---

### Step 3: Configure WiX Bundler in tauri.conf.json (30 min)
**Tool**: Read + Edit
**File**: `products/lumina-desktop/src-tauri/tauri.conf.json`

**Goal**: Add WiX bundler configuration to enable MSI generation

**Read Current Config**:
```bash
# Read to understand current structure
```

**Add WiX Bundle Configuration**:

Open `tauri.conf.json` and add/update `bundle` section:

```json
{
  "tauri": {
    "bundle": {
      "active": true,
      "targets": ["msi"],
      "identifier": "com.aetherlight.lumina-desktop",
      "icon": [
        "icons/32x32.png",
        "icons/128x128.png",
        "icons/128x128@2x.png",
        "icons/icon.icns",
        "icons/icon.ico"
      ],
      "publisher": "√ÜtherLight AI",
      "productName": "√ÜtherLight Desktop",
      "shortDescription": "Voice-to-intelligence platform for developers",
      "longDescription": "√ÜtherLight Desktop provides voice capture and transcription with real-time context sync for VS Code.",
      "windows": {
        "certificateThumbprint": null,
        "digestAlgorithm": "sha256",
        "timestampUrl": "",
        "wix": {
          "language": "en-US",
          "template": "wix/main.wxs",
          "fragmentPaths": [],
          "componentRefs": [],
          "componentGroupRefs": [],
          "featureRefs": [],
          "mergeRefs": [],
          "skipWebviewInstall": false,
          "license": "LICENSE",
          "enableElevatedUpdateTask": true,
          "bannerPath": "icons/banner.png",
          "dialogImagePath": "icons/dialog.png"
        }
      }
    }
  }
}
```

**Key Configuration**:
- `targets: ["msi"]` - Build MSI installer (not portable .exe)
- `identifier` - Unique app identifier (reverse domain notation)
- `publisher` - Company/developer name (appears in Apps & Features)
- `windows.wix.template` - Path to custom WiX template
- `windows.wix.enableElevatedUpdateTask` - Allow updates without admin

**Validation**:
```bash
# Verify JSON is valid
node -e "JSON.parse(require('fs').readFileSync('products/lumina-desktop/src-tauri/tauri.conf.json', 'utf-8'))"
```

---

### Step 4: Add WiX Features to Cargo.toml (10 min)
**Tool**: Read + Edit
**File**: `products/lumina-desktop/src-tauri/Cargo.toml`

**Goal**: Enable WiX bundler features in Tauri dependencies

**Read Current Dependencies**:
```bash
# Read to see current Tauri dependency configuration
```

**Add WiX Feature**:

Open `Cargo.toml` and update `tauri` dependency:

```toml
[dependencies]
tauri = { version = "1.5", features = ["shell-open", "wix"] }
# Add "wix" to existing features array
```

**If Tauri is already listed with features**:
```toml
tauri = { version = "1.5", features = ["shell-open", "system-tray", "window-all", "wix"] }
```

**Verification**:
```bash
cd products/lumina-desktop/src-tauri
cargo check --features wix
```

---

### Step 5: Create WiX Installer Template (60 min)
**Tool**: Write
**File**: `products/lumina-desktop/src-tauri/wix/main.wxs` (CREATE NEW)

**Goal**: Create custom WiX XML template for installer UI and registry entries

**Implementation** (~200 lines):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX Installer Template for √ÜtherLight Desktop (BUG-007)

  DESIGN DECISION: Custom WiX template for branded installer
  WHY: Default Tauri installer is generic, custom template adds branding + registry entries

  REASONING CHAIN:
  1. User downloads MSI installer
  2. Runs MSI ‚Üí Custom installer UI with √ÜtherLight branding
  3. Installation wizard guides user (install location, shortcuts)
  4. MSI installs app to Program Files
  5. Registry entries created automatically by WiX
  6. Shortcuts created (Start Menu, optional Desktop)
  7. App appears in Windows Apps & Features
  8. Uninstall removes everything (files + registry)

  PATTERN: Pattern-TESTING-001 (manual testing for Windows-specific)
-->

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
    Id="*"
    Name="√ÜtherLight Desktop"
    Manufacturer="√ÜtherLight AI"
    Version="$(var.Version)"
    Language="1033"
    Codepage="1252"
    UpgradeCode="12345678-1234-1234-1234-123456789012">

    <Package
      Id="*"
      Keywords="Installer"
      Description="√ÜtherLight Desktop $(var.Version) Installer"
      Manufacturer="√ÜtherLight AI"
      InstallerVersion="500"
      Languages="1033"
      Compressed="yes"
      SummaryCodepage="1252"
      InstallScope="perMachine"
      InstallPrivileges="elevated" />

    <!-- Upgrade logic -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowSameVersionUpgrades="yes"
      Schedule="afterInstallInitialize" />

    <!-- Media -->
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- Icon for Add/Remove Programs -->
    <Icon Id="ProductIcon" SourceFile="$(var.ResourcesDir)\icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />

    <!-- Installation directory -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLDIR" Name="√ÜtherLight Desktop">
          <!-- Main executable -->
          <Component Id="MainExecutable" Guid="*">
            <File
              Id="MainExe"
              Name="lumina-desktop.exe"
              Source="$(var.BinDir)\lumina-desktop.exe"
              KeyPath="yes">

              <!-- Registry entry for Apps & Features (BUG-007 fix) -->
              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="DisplayName"
                Value="[ProductName]"
                Type="string" />

              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="DisplayVersion"
                Value="[ProductVersion]"
                Type="string" />

              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="Publisher"
                Value="[Manufacturer]"
                Type="string" />

              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="UninstallString"
                Value="msiexec.exe /x [ProductCode]"
                Type="string" />

              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="InstallLocation"
                Value="[INSTALLDIR]"
                Type="string" />

              <RegistryValue
                Root="HKLM"
                Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]"
                Name="DisplayIcon"
                Value="[INSTALLDIR]lumina-desktop.exe,0"
                Type="string" />
            </File>
          </Component>

          <!-- WebView2 runtime (if not using skipWebviewInstall) -->
          <Component Id="WebView2" Guid="*">
            <!-- Tauri automatically bundles WebView2 runtime -->
          </Component>
        </Directory>
      </Directory>

      <!-- Start Menu shortcut -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="√ÜtherLight">
          <Component Id="ApplicationShortcut" Guid="*">
            <Shortcut
              Id="ApplicationStartMenuShortcut"
              Name="√ÜtherLight Desktop"
              Description="Voice-to-intelligence platform for developers"
              Target="[INSTALLDIR]lumina-desktop.exe"
              WorkingDirectory="INSTALLDIR"
              Icon="ProductIcon" />

            <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />

            <RegistryValue
              Root="HKCU"
              Key="Software\√ÜtherLight\Desktop"
              Name="installed"
              Type="integer"
              Value="1"
              KeyPath="yes" />
          </Component>
        </Directory>
      </Directory>

      <!-- Desktop shortcut (optional) -->
      <Directory Id="DesktopFolder" Name="Desktop">
        <Component Id="DesktopShortcut" Guid="*">
          <Shortcut
            Id="ApplicationDesktopShortcut"
            Name="√ÜtherLight Desktop"
            Description="Voice-to-intelligence platform for developers"
            Target="[INSTALLDIR]lumina-desktop.exe"
            WorkingDirectory="INSTALLDIR"
            Icon="ProductIcon" />

          <RegistryValue
            Root="HKCU"
            Key="Software\√ÜtherLight\Desktop"
            Name="desktopShortcut"
            Type="integer"
            Value="1"
            KeyPath="yes" />
        </Component>
      </Directory>
    </Directory>

    <!-- Features (what gets installed) -->
    <Feature Id="MainApplication" Title="√ÜtherLight Desktop" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="WebView2" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>

    <!-- Desktop shortcut is optional (user can choose) -->
    <Feature Id="DesktopShortcutFeature" Title="Desktop Shortcut" Level="1">
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- Custom UI (optional - use Tauri's default or customize) -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <!-- License agreement (optional) -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ResourcesDir)\LICENSE.rtf" />

    <!-- Custom images (optional) -->
    <!-- <WixVariable Id="WixUIBannerBmp" Value="$(var.ResourcesDir)\banner.bmp" /> -->
    <!-- <WixVariable Id="WixUIDialogBmp" Value="$(var.ResourcesDir)\dialog.bmp" /> -->
  </Product>
</Wix>
```

**Key Components**:
1. **Product Element**: Defines app metadata (name, version, manufacturer)
2. **Registry Entries**: Automatically created by WiX (DisplayName, DisplayVersion, UninstallString, etc.)
3. **Installation Directory**: `C:\Program Files\√ÜtherLight Desktop`
4. **Start Menu Shortcut**: Created in "√ÜtherLight" folder
5. **Desktop Shortcut**: Optional feature (user can choose during install)
6. **Uninstall Logic**: Removes all files and registry entries

**Design Decisions**:
- `InstallScope="perMachine"` - Install for all users (requires admin)
- `AllowSameVersionUpgrades="yes"` - Allow reinstalling same version
- Registry entries in HKLM (not HKCU) - Visible to all users
- Desktop shortcut optional - User can choose during installation

---

### Step 6: Create MSI Build Script (45 min)
**Tool**: Write
**File**: `scripts/build-windows-installer.js` (CREATE NEW)

**Goal**: Automated script to build MSI installer

**Implementation** (~150 lines):

```javascript
/**
 * Build Windows MSI Installer (BUG-007)
 *
 * DESIGN DECISION: Automated MSI build script for CI/CD integration
 * WHY: Manual WiX builds are error-prone, script ensures consistency
 *
 * USAGE: Called by publish-release.js after building Rust binary
 * OUTPUT: lumina-desktop-{version}-x64.msi
 *
 * PATTERN: Pattern-PUBLISH-001 (automated release pipeline)
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

/**
 * Build MSI installer using Tauri CLI
 */
async function buildMSI() {
    console.log('üèóÔ∏è Building Windows MSI installer...');

    // Read version from package.json
    const packageJson = JSON.parse(
        fs.readFileSync(path.join(__dirname, '../vscode-lumina/package.json'), 'utf-8')
    );
    const version = packageJson.version;

    console.log(`   Version: ${version}`);

    // Check WiX Toolset is installed
    try {
        execSync('candle.exe -?', { stdio: 'ignore' });
        console.log('‚úÖ WiX Toolset detected');
    } catch (e) {
        console.error('‚ùå WiX Toolset not found. Install from https://wixtoolset.org/');
        console.error('   Required: WiX Toolset 3.11+');
        process.exit(1);
    }

    // Navigate to desktop app directory
    const desktopDir = path.join(__dirname, '../products/lumina-desktop');
    process.chdir(desktopDir);

    // Build MSI using Tauri CLI
    try {
        console.log('üì¶ Running Tauri bundler (MSI target)...');
        execSync('npm run tauri build -- --bundles msi', {
            stdio: 'inherit',
            env: {
                ...process.env,
                TAURI_BUNDLE_TARGETS: 'msi'
            }
        });

        console.log('‚úÖ MSI build completed');
    } catch (e) {
        console.error('‚ùå MSI build failed:', e.message);
        process.exit(1);
    }

    // Locate generated MSI file
    const msiDir = path.join(desktopDir, 'src-tauri/target/release/bundle/msi');
    if (!fs.existsSync(msiDir)) {
        console.error('‚ùå MSI directory not found:', msiDir);
        process.exit(1);
    }

    const msiFiles = fs.readdirSync(msiDir).filter(f => f.endsWith('.msi'));
    if (msiFiles.length === 0) {
        console.error('‚ùå No MSI files generated');
        process.exit(1);
    }

    const msiFile = path.join(msiDir, msiFiles[0]);
    const msiSize = fs.statSync(msiFile).size;

    console.log('‚úÖ MSI installer generated:');
    console.log(`   File: ${msiFiles[0]}`);
    console.log(`   Size: ${(msiSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`   Path: ${msiFile}`);

    // Verify MSI metadata (optional)
    try {
        console.log('üîç Verifying MSI metadata...');
        verifyMSIMetadata(msiFile, version);
    } catch (e) {
        console.warn('‚ö†Ô∏è MSI metadata verification failed:', e.message);
        console.warn('   MSI may still work, but metadata might be incorrect');
    }

    return msiFile;
}

/**
 * Verify MSI metadata using PowerShell
 */
function verifyMSIMetadata(msiPath, expectedVersion) {
    // PowerShell script to read MSI properties
    const psScript = `
        $installer = New-Object -ComObject WindowsInstaller.Installer
        $database = $installer.GetType().InvokeMember("OpenDatabase", "InvokeMethod", $null, $installer, @("${msiPath}", 0))

        function Get-MsiProperty($propertyName) {
            $view = $database.GetType().InvokeMember("OpenView", "InvokeMethod", $null, $database, ("SELECT Value FROM Property WHERE Property='$propertyName'"))
            $view.GetType().InvokeMember("Execute", "InvokeMethod", $null, $view, $null)
            $record = $view.GetType().InvokeMember("Fetch", "InvokeMethod", $null, $view, $null)
            if ($record) {
                return $record.GetType().InvokeMember("StringData", "GetProperty", $null, $record, 1)
            }
            return $null
        }

        $productName = Get-MsiProperty "ProductName"
        $productVersion = Get-MsiProperty "ProductVersion"
        $manufacturer = Get-MsiProperty "Manufacturer"

        Write-Output "ProductName=$productName"
        Write-Output "ProductVersion=$productVersion"
        Write-Output "Manufacturer=$manufacturer"
    `;

    // Execute PowerShell script
    const output = execSync(`powershell -Command "${psScript.replace(/"/g, '\\"')}"`, {
        encoding: 'utf-8'
    });

    // Parse output
    const lines = output.trim().split('\n');
    const metadata = {};
    lines.forEach(line => {
        const [key, value] = line.split('=');
        if (key && value) {
            metadata[key.trim()] = value.trim();
        }
    });

    // Validate
    console.log('   ProductName:', metadata.ProductName);
    console.log('   ProductVersion:', metadata.ProductVersion);
    console.log('   Manufacturer:', metadata.Manufacturer);

    if (metadata.ProductName !== '√ÜtherLight Desktop') {
        throw new Error(`ProductName mismatch: ${metadata.ProductName}`);
    }

    if (metadata.ProductVersion !== expectedVersion) {
        console.warn(`‚ö†Ô∏è Version mismatch: ${metadata.ProductVersion} (expected ${expectedVersion})`);
    }

    if (metadata.Manufacturer !== '√ÜtherLight AI') {
        throw new Error(`Manufacturer mismatch: ${metadata.Manufacturer}`);
    }

    console.log('‚úÖ MSI metadata verified');
}

// Run if called directly
if (require.main === module) {
    buildMSI().catch((error) => {
        console.error('‚ùå Failed to build MSI installer:', error);
        process.exit(1);
    });
}

module.exports = { buildMSI };
```

**Integration with Publish Script**:

Edit `scripts/publish-release.js` to call build-windows-installer.js:

```javascript
// In publish-release.js, after building desktop app binary (around line 200):

console.log('üì¶ Step 6: Building desktop app binary...');
execSync('npm run build:release', { cwd: 'products/lumina-desktop', stdio: 'inherit' });

// NEW: Build MSI installer (BUG-007)
if (process.platform === 'win32') {
    console.log('üèóÔ∏è Step 6.5: Building Windows MSI installer...');
    execSync('node scripts/build-windows-installer.js', { stdio: 'inherit' });
}
```

---

### Step 7: Manual Testing on Windows VM (60 min)
**Pattern**: Pattern-TDD-001 (Manual testing), Pattern-TESTING-001

**Goal**: Execute manual test plan from Step 2 on clean Windows machine

**Setup Windows VM** (if not already available):
1. Download Windows 11 VM from Microsoft (free 90-day evaluation)
2. Install VirtualBox or VMware
3. Create new VM with Windows 11
4. Do NOT install any previous versions of √ÜtherLight

**Execute All 9 Manual Tests**:
- Follow test plan from `products/lumina-desktop/tests/manual/WINDOWS_INSTALLER_TEST.md`
- Mark each test as PASS or FAIL
- Document any issues found

**Expected Results**:
- ‚úÖ All 9 manual tests pass
- ‚úÖ App appears in Apps & Features
- ‚úÖ Uninstall removes all files and registry entries

**If any tests fail**: Debug issues, update WiX template/config, rebuild MSI, retest

---

### Step 8: Update Sprint TOML Completion Notes (5 min) - MANDATORY üõë

**‚ö†Ô∏è CRITICAL REQUIREMENT**: This step is MANDATORY. DO NOT proceed to Step 9 (Commit) until this is complete.

**Pattern**: Pattern-COMPLETION-001

**Why This Step Exists**: Historical audits (BUG-002A, BUG-003, BUG-002) found agents skipped completion documentation. This step MUST be completed BEFORE committing changes. If you skip this, your commit will be considered incomplete.

---

**Update Sprint TOML with completion_notes field:**

Open `internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml` and add the following to BUG-007 task section (after `completed_date`):

```toml
[tasks.BUG-007]
status = "completed"
completed_date = "2025-01-13"

completion_notes = """
Completed 2025-01-13 by AI agent (tauri-desktop-agent)

Changes Made:
- Configured WiX bundler in tauri.conf.json (added bundle.windows section)
- Added WiX features to Cargo.toml (tauri dependency)
- Created WiX installer template (main.wxs - 200 lines)
- Created MSI build script (build-windows-installer.js - 150 lines)
- Manual testing completed on Windows 11 VM (all 9 tests passed)

Technical Details:
- File(s): tauri.conf.json, Cargo.toml, wix/main.wxs (NEW), build-windows-installer.js (NEW)
- Lines Added: ~350 lines (200 WiX XML, 150 JavaScript)
- Test Coverage: Manual testing only (9 scenarios: build, install, Apps & Features, shortcuts, launch, uninstall, cleanup, registry)
- Breaking Change: No (MSI replaces portable .exe, backward compatible)
- Commit: [PENDING - will add after Step 9]

Backend Implementation (WiX/Tauri):
1. tauri.conf.json configured with WiX bundler:
   - targets: ["msi"] (build MSI installer)
   - identifier: "com.aetherlight.lumina-desktop"
   - publisher: "√ÜtherLight AI"
   - windows.wix.template: "wix/main.wxs" (custom template)
   - windows.wix.enableElevatedUpdateTask: true (updates without admin)

2. Cargo.toml updated:
   - Added "wix" feature to tauri dependency

3. WiX installer template (main.wxs):
   - Product metadata (name, version, manufacturer)
   - Registry entries (HKLM\...\Uninstall\[ProductCode])
   - Installation directory (C:\Program Files\√ÜtherLight Desktop)
   - Start Menu shortcut (in "√ÜtherLight" folder)
   - Desktop shortcut (optional feature)
   - Uninstall logic (removes all files and registry entries)

4. MSI build script (build-windows-installer.js):
   - Checks WiX Toolset installed (candle.exe)
   - Builds MSI using Tauri CLI (npm run tauri build -- --bundles msi)
   - Verifies MSI metadata with PowerShell
   - Integrated into publish-release.js (Step 6.5)

Registry Entries (Created Automatically by WiX):
- DisplayName: "√ÜtherLight Desktop"
- DisplayVersion: "0.17.2"
- Publisher: "√ÜtherLight AI"
- UninstallString: "msiexec.exe /x [ProductCode]"
- InstallLocation: "C:\Program Files\√ÜtherLight Desktop"
- DisplayIcon: "{InstallLocation}\lumina-desktop.exe,0"

Testing:
- Manual Test 1: Build MSI successfully ‚úÖ (lumina-desktop-0.17.2-x64.msi, 45 MB)
- Manual Test 2: Install via MSI on clean Windows 11 VM ‚úÖ (UAC prompt, installer UI, success)
- Manual Test 3: App appears in Apps & Features ‚úÖ (name, version, publisher, size)
- Manual Test 4: Desktop shortcut created (optional) ‚úÖ
- Manual Test 5: Start Menu shortcut exists ‚úÖ (in "√ÜtherLight" folder)
- Manual Test 6: Launch app via shortcut ‚úÖ (no errors, system tray icon, functional)
- Manual Test 7: Uninstall via Apps & Features ‚úÖ (confirmation dialog, success)
- Manual Test 8: All files removed from AppData ‚úÖ (only user data remains)
- Manual Test 9: Registry entries removed ‚úÖ (no √ÜtherLight keys found)
- Automated Test A: WiX build script succeeds ‚úÖ
- Automated Test B: MSI metadata correct ‚úÖ (ProductName, ProductVersion, Manufacturer)
- Automated Test C: WiX XML validates ‚úÖ (no schema errors)

Impact:
- Fixes: User-reported issue "Can't find app in Apps & Features to uninstall"
- Enables: Standard Windows uninstallation via Apps & Features
- UX: Professional Windows installer experience (MSI with branding)
- Compliance: Meets Windows application best practices

Dependencies:
- Blocked by: None
- Related: BUG-006 (update mechanism - MSI upgrades work differently)

Next Steps (Not in This Task):
- [ ] Code signing certificate for production (prevents SmartScreen warnings)
- [ ] Add custom installer images (banner.bmp, dialog.bmp)
- [ ] Test MSI upgrade flow (0.17.2 ‚Üí 0.17.3)
- [ ] Document installation guide for users (INSTALLING.md)

Pattern Compliance:
- ‚úÖ Pattern-TASK-ANALYSIS-001: 8-step pre-task analysis completed
- ‚úÖ Pattern-CODE-001: Code workflow check announced
- ‚úÖ Pattern-GIT-001: Git status checked before commit
- ‚úÖ Pattern-TDD-001: Manual test plan written FIRST, executed after implementation
- ‚úÖ Pattern-TRACKING-001: TodoWrite used for progress tracking
- ‚úÖ Pattern-COMPLETION-001: Sprint TOML updated with completion_notes
- ‚úÖ Pattern-TESTING-001: Manual testing protocols followed (9 scenarios)

Commit: fix(desktop): Add Windows Registry entries via WiX installer (BUG-007)
Commit Hash: [PENDING - will add after commit]
"""
```

---

**Validation (MANDATORY - Run BEFORE proceeding to Step 9):**

```bash
# Check if status is "completed"
grep -A 5 "^\[tasks.BUG-007\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep 'status = "completed"'

# Check if completed_date exists
grep -A 5 "^\[tasks.BUG-007\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep "completed_date"

# Check if completion_notes exists
grep -A 50 "^\[tasks.BUG-007\]" internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml | grep "completion_notes"
```

**Expected Output:**
```
status = "completed"
completed_date = "2025-01-13"
completion_notes = """
```

**‚ùå If ANY command returns empty**: Sprint TOML is NOT updated. Do NOT proceed to Step 9. Fix it NOW.

**‚úÖ If ALL commands return results**: Sprint TOML is updated correctly. Proceed to Step 9.

---

**Additional Documentation (Optional - If Applicable):**

1. **Testing Document**: Manual test plan already created in Step 2 (`WINDOWS_INSTALLER_TEST.md`)
2. **Pattern Documentation**: No new reusable patterns created (used existing Pattern-TESTING-001)
3. **Known Issues**: Update `docs/KNOWN_ISSUES.md` with resolution: "BUG-007: Fixed Windows Registry visibility (WiX installer + registry entries)"

---

**üõë BLOCKER**: DO NOT proceed to Step 9 (Commit) until ALL validation commands return expected output.

---

### Step 9: Commit Changes (5 min)

**‚ö†Ô∏è PREREQUISITE CHECK**: Did you complete Step 8 (Update Sprint TOML Completion Notes)?

**If NO**: STOP. Go back to Step 8 and complete it NOW.

**If YES**: Verify by running the 3 validation commands from Step 8. All 3 MUST return results.

---

**Pattern**: Pattern-GIT-001 (full commit format + workflow)

```bash
git add products/lumina-desktop/src-tauri/tauri.conf.json
git add products/lumina-desktop/src-tauri/Cargo.toml
git add products/lumina-desktop/src-tauri/wix/main.wxs
git add products/lumina-desktop/tests/manual/WINDOWS_INSTALLER_TEST.md
git add scripts/build-windows-installer.js
git add scripts/publish-release.js
git add internal/sprints/ACTIVE_SPRINT_17.1_BUGS.toml

# If Sprint TOML modified
node scripts/validate-sprint-schema.js

# Commit (use HEREDOC for proper formatting)
git commit -m "$(cat <<'EOF'
fix(desktop): Add Windows Registry entries via WiX installer (BUG-007)

- Configure WiX bundler in tauri.conf.json (bundle.windows section)
- Add WiX features to Cargo.toml (tauri dependency)
- Create WiX installer template (main.wxs - 200 lines)
- Create MSI build script (build-windows-installer.js - 150 lines)
- Add manual test plan (WINDOWS_INSTALLER_TEST.md - 9 scenarios)
- Integrate MSI build into publish workflow

Fixes user-reported issue: "Can't find app in Apps & Features to uninstall."

Registry entries created automatically by WiX:
- DisplayName, DisplayVersion, Publisher, UninstallString, InstallLocation

Manual testing completed on Windows 11 VM (all 9 tests passed).

Unblocks standard Windows uninstallation, professional installer experience.

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

**After Commit**: Get commit hash and add it to completion_notes:
```bash
git log -1 --format=%h
# Copy hash and update completion_notes "Commit Hash: {hash}" field
```

---

### Step 10: Update Sprint Status to Completed (2 min)
**Pattern**: Pattern-TRACKING-001

```bash
/sprint-task-lifecycle complete BUG-007
```

**Fallback** (if skill unavailable): Follow Pattern-TRACKING-001 manual process

**Validation**: Verify status = "completed" and completed_date added

---

## Acceptance Criteria

- [ ] Pre-Task Analysis completed (Pattern-TASK-ANALYSIS-001)
- [ ] Code Workflow Announcement made (Pattern-CODE-001)
- [ ] WiX bundler configured in tauri.conf.json ‚úÖ
- [ ] WiX features added to Cargo.toml ‚úÖ
- [ ] WiX installer template created (main.wxs - 200 lines) ‚úÖ
- [ ] MSI build script created (build-windows-installer.js - 150 lines) ‚úÖ
- [ ] Manual test plan created (WINDOWS_INSTALLER_TEST.md) ‚úÖ
- [ ] Build produces .msi installer file ‚úÖ
- [ ] Installer appears in Windows Apps & Features after installation ‚úÖ
- [ ] Uninstall removes all files from AppData ‚úÖ
- [ ] Uninstall removes registry entries ‚úÖ
- [ ] Desktop shortcut created during installation (optional) ‚úÖ
- [ ] Start Menu shortcut appears in √ÜtherLight folder ‚úÖ
- [ ] All 9 manual tests pass ‚úÖ
- [ ] Sprint TOML completion_notes added (Step 8 - Pattern-COMPLETION-001) üõë MANDATORY
- [ ] Sprint TOML validation commands pass (Step 8 - all 3 commands return results)
- [ ] Sprint TOML updated to "completed" (Pattern-TRACKING-001)
- [ ] Changes committed (Pattern-GIT-001)
- [ ] MSI build integrated into publish workflow
- [ ] Ready for code signing certificate integration (future enhancement)

---

## Error Handling

### Issue 1: WiX Toolset not found during build
- **Cause**: WiX Toolset not installed on build machine
- **Solution**:
  - Download from https://wixtoolset.org/
  - Install WiX Toolset 3.11+
  - Verify: `candle.exe -?` (should show version)
  - Add to PATH if needed

### Issue 2: MSI build fails with "Invalid XML" error
- **Cause**: Syntax error in main.wxs template
- **Solution**:
  - Validate XML: `xmllint --schema wix.xsd wix/main.wxs`
  - Check for typos: unclosed tags, missing attributes, incorrect GUIDs
  - Verify Tauri placeholder variables exist ($(var.Version), $(var.BinDir), etc.)

### Issue 3: Installation requires admin rights (UAC prompt)
- **Cause**: InstallScope="perMachine" requires elevated permissions
- **Solution**:
  - This is intentional (per-machine installs need admin)
  - Alternative: Change to InstallScope="perUser" (no admin, but only for current user)
  - Recommendation: Keep perMachine (more professional, better for enterprise)

### Issue 4: App doesn't appear in Apps & Features after install
- **Cause**: Registry entries not created
- **Solution**:
  - Check registry manually: `HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall`
  - Verify main.wxs has RegistryValue elements
  - Check WiX build logs for warnings
  - Reinstall with verbose logging: `msiexec /i lumina-desktop.msi /l*v install.log`

### Issue 5: Uninstall leaves files behind
- **Cause**: Component KeyPath not set correctly
- **Solution**:
  - Verify each Component has `KeyPath="yes"` on a File or RegistryValue
  - Check RemoveFolder elements have `On="uninstall"`
  - Test: Install ‚Üí Create dummy file in install dir ‚Üí Uninstall ‚Üí File should remain (only installed files removed)

### Issue 6: Upgrade from portable to MSI creates two installations
- **Cause**: No detection of existing portable installation
- **Solution**:
  - Add custom action to detect portable installation (check for .exe in AppData)
  - Show dialog: "Portable version detected. Uninstall first?"
  - Or: Automatically migrate settings from portable to MSI installation

---

## Rollback Plan

**If build fails** (Step 3-6):
```bash
git checkout -- products/lumina-desktop/src-tauri/tauri.conf.json
git checkout -- products/lumina-desktop/src-tauri/Cargo.toml
rm -rf products/lumina-desktop/src-tauri/wix/
git checkout -- scripts/build-windows-installer.js
# Review Tauri WiX docs, update config, retry
```

**If manual tests fail** (Step 7):
```bash
# Debug issues on Windows VM
# Update WiX template/config based on findings
# Rebuild MSI: node scripts/build-windows-installer.js
# Retest
```

**Emergency Rollback**:
```bash
git stash  # Save work
git reset --hard HEAD  # Reset
git stash pop  # Restore if needed
```

---

## Time Estimate

- Pre-Task Analysis (Pattern-TASK-ANALYSIS-001): 10 min
- Step 0 (Git + Sprint): 2 min
- Step 1 (Research WiX): 20 min
- Step 2 (Manual Test Plan): 30 min
- Step 3 (Configure tauri.conf.json): 30 min
- Step 4 (Update Cargo.toml): 10 min
- Step 5 (Create WiX Template): 60 min
- Step 6 (MSI Build Script): 45 min
- Step 7 (Manual Testing on Windows VM): 60 min
- Step 8 (Sprint TOML Completion Notes): 5 min üõë MANDATORY
- Step 9 (Commit): 5 min
- Step 10 (Sprint Complete): 2 min

**Total**: 4.5 hours (within estimated 4-6 hours)

---

## Dependencies

**Blocks**: Professional Windows installation experience, easier uninstall for users

**Blocked By**: None

---

## Success Impact

After BUG-007 complete:

‚úÖ Desktop app appears in Windows Apps & Features (name, version, publisher, size)
‚úÖ Users can uninstall via standard Windows UI (Settings > Apps > Installed apps)
‚úÖ Proper Windows installer (MSI with branding)
‚úÖ Uninstall removes all files and registry entries (clean removal)
‚úÖ Professional installation experience (installer wizard, shortcuts)
‚úÖ Meets Windows application best practices (registry entries, uninstaller)
‚úÖ Start Menu shortcut in "√ÜtherLight" folder (organized, not cluttered)
‚úÖ Desktop shortcut optional (user can choose during install)
‚úÖ Ready for code signing certificate integration (future)

---

## Notes

**WiX Bundler Architecture**:
- WiX (Windows Installer XML) is the industry standard for Windows installers
- Generates .msi files (Windows Installer database)
- Registry entries created automatically by WiX (no manual registry manipulation)
- Supports custom UI, branding, shortcuts, file associations

**Design Decisions**:
1. **WiX vs NSIS**: WiX is more Windows-native (MSI format), easier maintenance
2. **Per-machine vs per-user**: Per-machine (requires admin, better for enterprise)
3. **Desktop shortcut optional**: Reduces desktop clutter, user can choose
4. **Start Menu in folder**: "√ÜtherLight" folder prevents Start Menu pollution
5. **Enable elevated update task**: Allows updates without admin prompt (better UX)

**Portable .exe vs MSI**:
- **Portable**: No installer, no registry, user manually manages files
- **MSI**: Proper installer, registry entries, standard uninstall, professional
- **Trade-off**: MSI requires admin, portable doesn't
- **Recommendation**: Offer both (MSI for most users, portable for advanced users)

**Future Enhancements (Not in This Task)**:
- Code signing certificate (prevents Windows SmartScreen warnings)
- Custom installer images (banner.bmp, dialog.bmp for branded UI)
- Silent installation support (for enterprise deployment: `msiexec /i lumina.msi /quiet`)
- Automatic migration from portable to MSI (detect portable, migrate settings)

---

**This enhanced prompt follows template v1.4.3 (breadcrumb-based with mandatory pre-task analysis + completion notes in workflow). All universal protocols are in patterns/skills for token efficiency.**

**Pattern References**:
- Pattern-TASK-ANALYSIS-001: 8-step pre-task analysis (MANDATORY)
- Pattern-CODE-001: Code workflow + announcement (MANDATORY)
- Pattern-COMPLETION-001: Post-completion documentation (MANDATORY - Step 8)
- Pattern-TRACKING-001: Sprint TOML lifecycle
- Pattern-GIT-001: Git workflow + commit format
- Pattern-TDD-001: Test-driven development (manual test plan)
- Pattern-VALIDATION-001: Pre-flight checklist
- Pattern-TESTING-001: Manual testing protocols

**Skill References**:
- sprint-task-lifecycle: Automated Sprint TOML updates

**Token Savings**: ~2,400 tokens (54%+ reduction from v1.0, maintains enforcement)

---

**IMPORTANT**: Completion notes documentation (formerly Section 12) is now **Step 8** in the implementation workflow. This ensures agents complete documentation BEFORE committing changes, not after. See Step 8 for full instructions.
